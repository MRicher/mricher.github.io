const messageTemplates = {
  outlook: {
    incident: [
      {
        value: "msg1",
        label: { en: "Microsoft Outlook issues (prior to online migration)", fr: "Problèmes liés à Microsoft Outlook (avant la migration en ligne)" },
        en: '<h3>Microsoft Outlook issues (prior to online migration)</h3><p>An issue is preventing some users from accessing their email via Microsoft Outlook. Support staff are actively investigating the matter and working diligently to resolve it as quickly as possible.</p><p>In the interim, there are some possible workarounds users can try to continue to access Microsoft Outlook:</p><ol><li>Sign out and sign back into Microsoft Outlook.</li><li>Access Email through the Samsung email app on your <abbr>RCMP</abbr> issued mobile phone (if applicable).</li><li>Access <a href="https://email-courriel.rcmp-grc.gc.ca/owa/auth/logon.aspx">Outlook Web</a>. Please use your <abbr>HRMIS</abbr> number and <abbr>ROSS</abbr> password for your login credentials.<br><strong>Note</strong>: When accessing email using the web version of Outlook, you cannot decrypt or encrypt email. This feature is only available using Outlook on your desktop or on your mobile phone, if you\'ve enrolled your device for this functionality).</li></ol><p>Refer to <a href="/cio/email-courriel/common-courants-eng.htm">Outlook tips and tricks</a> on Infoweb for additional information on using Microsoft Outlook.</p>',
        fr: '<h3>Problèmes liés à Microsoft Outlook (avant la migration en ligne)</h3><p>Un problème empêche certains utilisateurs d\'accéder à leur courriel dans Microsoft Outlook. Le personnel de soutien travaille avec diligence pour le résoudre le plus rapidement possible.</p><p>En attendant, les utilisateurs peuvent essayer des solutions de rechange pour accéder à Microsoft Outlook&#160;:</p><ol><li>Déconnectez-vous puis reconnectez-vous à Microsoft Outlook.</li><li>Accédez à vos courriels au moyen de l\'application de courriel Samsung sur votre téléphone mobile de la <abbr>GRC</abbr>.</li><li>Accédez à <a href="https://email-courriel.rcmp-grc.gc.ca/owa/auth/logon.aspx">Outlook Web</a>. Utilisez votre numéro <abbr>SIGRH</abbr> et votre mot de passe <abbr>ROSS</abbr> pour vous connecter.<br><strong>Remarque</strong>&#160;: Lorsque vous accédez au courriel au moyen de la version Web d\'Outlook, vous ne pouvez pas chiffrer et déchiffrer de courriels. Cette fonction est seulement disponible dans Outlook sur votre ordinateur ou sur votre téléphone mobile, si vous avez inscrit votre appareil pour cette fonctionnalité.)</li></ol><p>Consultez la page Infoweb sur les <a href="/cio/email-courriel/common-courants-fra.htm">trucs et astuces concernant Outlook</a> pour en savoir plus sur comment utiliser Microsoft Outlook.</p>',
      },
    ],
    outage: [
      {
        value: "msg2",
        label: { en: "Microsoft Outlook issues (prior to online migration)", fr: "Problèmes liés à Microsoft Outlook (avant la migration en ligne)" },
        en: '<h3>Microsoft Outlook issues (prior to online migration)</h3><p>An issue is preventing some users from accessing their email via Microsoft Outlook. Support staff are actively investigating the matter and working diligently to resolve it as quickly as possible.</p><p>In the interim, there are some possible workarounds users can try to continue to access Microsoft Outlook:</p><ol><li>Sign out and sign back into Microsoft Outlook.</li><li>Access Email through the Samsung email app on your <abbr>RCMP</abbr> issued mobile phone (if applicable).</li><li>Access <a href="https://email-courriel.rcmp-grc.gc.ca/owa/auth/logon.aspx">Outlook Web</a>. Please use your <abbr>HRMIS</abbr> number and <abbr>ROSS</abbr> password for your login credentials.<br><strong>Note</strong>: When accessing email using the web version of Outlook, you cannot decrypt or encrypt email. This feature is only available using Outlook on your desktop or on your mobile phone, if you\'ve enrolled your device for this functionality).</li></ol><p>Refer to <a href="/cio/email-courriel/common-courants-eng.htm">Outlook tips and tricks</a> on Infoweb for additional information on using Microsoft Outlook.</p>',
        fr: '<h3>Problèmes liés à Microsoft Outlook (avant la migration en ligne)</h3><p>Un problème empêche certains utilisateurs d\'accéder à leur courriel dans Microsoft Outlook. Le personnel de soutien travaille avec diligence pour le résoudre le plus rapidement possible.</p><p>En attendant, les utilisateurs peuvent essayer des solutions de rechange pour accéder à Microsoft Outlook&#160;:</p><ol><li>Déconnectez-vous puis reconnectez-vous à Microsoft Outlook.</li><li>Accédez à vos courriels au moyen de l\'application de courriel Samsung sur votre téléphone mobile de la <abbr>GRC</abbr>.</li><li>Accédez à <a href="https://email-courriel.rcmp-grc.gc.ca/owa/auth/logon.aspx">Outlook Web</a>. Utilisez votre numéro <abbr>SIGRH</abbr> et votre mot de passe <abbr>ROSS</abbr> pour vous connecter.<br><strong>Remarque</strong>&#160;: Lorsque vous accédez au courriel au moyen de la version Web d\'Outlook, vous ne pouvez pas chiffrer et déchiffrer de courriels. Cette fonction est seulement disponible dans Outlook sur votre ordinateur ou sur votre téléphone mobile, si vous avez inscrit votre appareil pour cette fonctionnalité.)</li></ol><p>Consultez la page Infoweb sur les <a href="/cio/email-courriel/common-courants-fra.htm">trucs et astuces concernant Outlook</a> pour en savoir plus sur comment utiliser Microsoft Outlook.</p>',
      },
    ],
  },
  m365: {
    incident: [
      {
        value: "msg3",
        label: { en: "M365 Issues (prior to online migration)", fr: "Problèmes liés à M365 (avant la migration en ligne)" },
        en: '<h3>M365 Issues (prior to online migration)</h3><p>An issue is preventing some users from connecting to M365 Applications (Microsoft Teams, SharePoint and OneDrive). Support staff are actively investigating the matter and working diligently to resolve it as quickly as possible.</p><p>In the interim, there are some possible workarounds users can try to continue to access Microsoft Teams:</p><ol><li>Sign out and sign back into Microsoft Teams.</li><li>Access Microsoft Teams on your <abbr>RCMP</abbr> issued mobile phone (if applicable).</li><li>Access <a href="https://teams.cloud.microsoft/">Microsoft Teams Web</a>. Users may need to login, even if already logged into the desktop version.</li></ol><p>Refer to <a href="/cio/microsoft-teams/index-eng.htm">Teams tips and tricks</a> on Infoweb for additional information on using Microsoft Teams.</p>',
        fr: '<h3>Problèmes liés à M365 (avant la migration en ligne)</h3><p>Un problème empêche certains utilisateurs de se connecter aux applications M365 (Microsoft Teams, SharePoint et OneDrive). Le personnel de soutien travaille avec diligence pour le résoudre le plus rapidement possible.</p><p>En attendant, les utilisateurs peuvent essayer des solutions de rechange pour accéder à Microsoft Teams&#160;:</p><ol><li>Déconnectez-vous puis reconnectez-vous à Microsoft Teams.</li><li>Accédez à Microsoft Teams sur votre téléphone mobile de la <abbr>GRC</abbr> (s\'il y a lieu).</li><li>Accédez à <a href="https://teams.cloud.microsoft/">Microsoft Teams Web</a>. Les utilisateurs pourraient devoir se connecter, même s\'ils sont déjà connectés dans l\'application sur leur ordinateur.</li></ol><p>Consultez la page Infoweb sur les <a href="/cio/microsoft-teams/index-fra.htm">trucs et astuces concernant Teams</a> pour en savoir plus sur comment utiliser Microsoft Teams.</p>',
      },
      {
        value: "msg4",
        label: { en: "M365 Issues (post online migration)", fr: "Problèmes liés à M365 (après la migration en ligne)" },
        en: '<h3>M365 Issues (post online migration)</h3><p>An issue is preventing some users from connecting to M365 Applications (Microsoft Outlook, Teams, SharePoint and OneDrive). Support staff are actively investigating the matter and working diligently to resolve it as quickly as possible.</p><p>In the interim, there are some possible workarounds users can try to continue to access Microsoft Outlook and Teams:</p><ol><li>Sign out and sign back in to Microsoft Outlook and Microsoft Teams.</li><li>Access Email through the Samsung email app on your <abbr>RCMP</abbr> issued mobile phone (if applicable).</li><li>Access the online versions (note: if both Microsoft Outlook and Teams are inaccessible, it\'s likely the online and mobile versions may not work either):<ol><li>Access <a href="https://outlook.cloud.microsoft/">Outlook Web</a>. Users may need to login, even if already logged into the desktop version.<br> <strong>Note</strong>: When accessing email using the web version of Outlook, you cannot decrypt or encrypt email. This feature is only available using Outlook on your desktop or on your mobile phone.</li><li>Access <a href="https://teams.cloud.microsoft/">Microsoft Teams Web</a>. Users may need to login, even if already logged into the desktop version.</li></ol></li></ol><p>Refer to <a href="/cio/email-courriel/common-courants-eng.htm">Outlook tips and tricks</a> on Infoweb for additional information on using Outlook.</p><p>Refer to <a href="/cio/microsoft-teams/index-eng.htm">Teams tips and tricks</a> on Infoweb for additional information on using Microsoft Teams.</p>',
        fr: '<h3>Problèmes liés à M365 (après la migration en ligne)</h3><p>Un problème empêche certains utilisateurs de se connecter aux applications M365 (Microsoft Outlook, Teams, SharePoint et OneDrive). Le personnel de soutien travaille avec diligence pour le résoudre le plus rapidement possible.</p><p>En attendant, les utilisateurs peuvent essayer des solutions de rechange pour accéder à Microsoft Outlook et à Microsoft Teams&#160;:</p><ol><li>Déconnectez-vous puis reconnectez-vous à Microsoft Outlook et à Microsoft Teams.</li><li>Accédez à vos courriels au moyen de l\'application de courriel Samsung sur votre téléphone mobile de la <abbr>GRC</abbr>.</li><li>Accédez aux versions en ligne<br> <strong>Remarque</strong>&#160;: si Microsoft Outlook et Microsoft Teams ne sont pas accessibles, il est probable que les versions en ligne et les versions mobiles ne fonctionnent pas non plus)&#160;:<ol><li>Accédez à <a href="https://outlook.cloud.microsoft/">Outlook Web</a>. Les utilisateurs pourraient devoir se connecter, même s\'ils sont déjà connectés dans l\'application sur leur ordinateur.<br> <strong>Remarque</strong>&#160;: Lorsque vous accédez au courriel au moyen de la version Web d\'Outlook, vous ne pouvez pas chiffrer et déchiffrer de courriels. Cette fonction est seulement disponible dans Outlook sur votre ordinateur ou sur votre téléphone mobile.</li><li>Accédez à <a href="https://teams.cloud.microsoft/">Microsoft Teams Web</a>. Les utilisateurs pourraient devoir se connecter, même s\'ils sont déjà connectés dans l\'application sur leur ordinateur.</li></ol></li></ol><p>Consultez la page Infoweb sur les <a href="/cio/email-courriel/common-courants-fra.htm">trucs et astuces concernant Outlook</a> pour en savoir plus sur comment utiliser Microsoft Outlook.</p><p>Consultez la page Infoweb sur les <a href="/cio/microsoft-teams/index-fra.htm">trucs et astuces concernant Teams</a> pour en savoir plus sur comment utiliser Microsoft Teams.</p>',
      },
    ],
    outage: [
      {
        value: "msg5",
        label: { en: "M365 Issues (prior to online migration)", fr: "Problèmes liés à M365 (avant la migration en ligne)" },
        en: '<h3>M365 Issues (prior to online migration)</h3><p>An issue is preventing some users from connecting to M365 Applications (Microsoft Teams, SharePoint and OneDrive). Support staff are actively investigating the matter and working diligently to resolve it as quickly as possible.</p><p>In the interim, there are some possible workarounds users can try to continue to access Microsoft Teams:</p><ol><li>Sign out and sign back into Microsoft Teams.</li><li>Access Microsoft Teams on your <abbr>RCMP</abbr> issued mobile phone (if applicable).</li><li>Access <a href="https://teams.cloud.microsoft/">Microsoft Teams Web</a>. Users may need to login, even if already logged into the desktop version.</li></ol><p>Refer to <a href="/cio/microsoft-teams/index-eng.htm">Teams tips and tricks</a> on Infoweb for additional information on using Microsoft Teams.</p>',
        fr: '<h3>Problèmes liés à M365 (avant la migration en ligne)</h3><p>Un problème empêche certains utilisateurs de se connecter aux applications M365 (Microsoft Teams, SharePoint et OneDrive). Le personnel de soutien travaille avec diligence pour le résoudre le plus rapidement possible.</p><p>En attendant, les utilisateurs peuvent essayer des solutions de rechange pour accéder à Microsoft Teams&#160;:</p><ol><li>Déconnectez-vous puis reconnectez-vous à Microsoft Teams.</li><li>Accédez à Microsoft Teams sur votre téléphone mobile de la <abbr>GRC</abbr> (s\'il y a lieu).</li><li>Accédez à <a href="https://teams.cloud.microsoft/">Microsoft Teams Web</a>. Les utilisateurs pourraient devoir se connecter, même s\'ils sont déjà connectés dans l\'application sur leur ordinateur.</li></ol><p>Consultez la page Infoweb sur les <a href="/cio/microsoft-teams/index-fra.htm">trucs et astuces concernant Teams</a> pour en savoir plus sur comment utiliser Microsoft Teams.</p>',
      },
      {
        value: "msg6",
        label: { en: "M365 Issues (post online migration)", fr: "Problèmes liés à M365 (après la migration en ligne)" },
        en: '<h3>M365 Issues (post online migration)</h3><p>An issue is preventing some users from connecting to M365 Applications (Microsoft Outlook, Teams, SharePoint and OneDrive). Support staff are actively investigating the matter and working diligently to resolve it as quickly as possible.</p><p>In the interim, there are some possible workarounds users can try to continue to access Microsoft Outlook and Teams:</p><ol><li>Sign out and sign back in to Microsoft Outlook and Microsoft Teams.</li><li>Access Email through the Samsung email app on your <abbr>RCMP</abbr> issued mobile phone (if applicable).</li><li>Access the online versions (note: if both Microsoft Outlook and Teams are inaccessible, it\'s likely the online and mobile versions may not work either):<ol><li>Access <a href="https://outlook.cloud.microsoft/">Outlook Web</a>. Users may need to login, even if already logged into the desktop version.<br> <strong>Note</strong>: When accessing email using the web version of Outlook, you cannot decrypt or encrypt email. This feature is only available using Outlook on your desktop or on your mobile phone.</li><li>Access <a href="https://teams.cloud.microsoft/">Microsoft Teams Web</a>. Users may need to login, even if already logged into the desktop version.</li></ol></li></ol><p>Refer to <a href="/cio/email-courriel/common-courants-eng.htm">Outlook tips and tricks</a> on Infoweb for additional information on using Outlook.</p><p>Refer to <a href="/cio/microsoft-teams/index-eng.htm">Teams tips and tricks</a> on Infoweb for additional information on using Microsoft Teams.</p>',
        fr: '<h3>Problèmes liés à M365 (après la migration en ligne)</h3><p>Un problème empêche certains utilisateurs de se connecter aux applications M365 (Microsoft Outlook, Teams, SharePoint et OneDrive). Le personnel de soutien travaille avec diligence pour le résoudre le plus rapidement possible.</p><p>En attendant, les utilisateurs peuvent essayer des solutions de rechange pour accéder à Microsoft Outlook et à Microsoft Teams&#160;:</p><ol><li>Déconnectez-vous puis reconnectez-vous à Microsoft Outlook et à Microsoft Teams.</li><li>Accédez à vos courriels au moyen de l\'application de courriel Samsung sur votre téléphone mobile de la <abbr>GRC</abbr>.</li><li>Accédez aux versions en ligne<br> <strong>Remarque</strong>&#160;: si Microsoft Outlook et Microsoft Teams ne sont pas accessibles, il est probable que les versions en ligne et les versions mobiles ne fonctionnent pas non plus&#160;:<ol><li>Accédez à <a href="https://outlook.cloud.microsoft/">Outlook Web</a>. Les utilisateurs pourraient devoir se connecter, même s\'ils sont déjà connectés dans l\'application sur leur ordinateur.<br> <strong>Remarque</strong>&#160;: Lorsque vous accédez au courriel au moyen de la version Web d\'Outlook, vous ne pouvez pas chiffrer et déchiffrer de courriels. Cette fonction est seulement disponible dans Outlook sur votre ordinateur ou sur votre téléphone mobile.</li><li>Accédez à <a href="https://teams.cloud.microsoft/">Microsoft Teams Web</a>. Les utilisateurs pourraient devoir se connecter, même s\'ils sont déjà connectés dans l\'application sur leur ordinateur.</li></ol></li></ol><p>Consultez la page Infoweb sur les <a href="/cio/email-courriel/common-courants-fra.htm">trucs et astuces concernant Outlook</a> pour en savoir plus sur comment utiliser Microsoft Outlook.</p><p>Consultez la page Infoweb sur les <a href="/cio/microsoft-teams/index-fra.htm">trucs et astuces concernant Teams</a> pour en savoir plus sur comment utiliser Microsoft Teams.</p>',
      },
    ],
  },
};

let entryCounter = 1;

const quillInstances = {};

const Block = Quill.import("blots/block");
Block.tagName = "p";
Quill.register(Block, true);

const Bold = Quill.import("formats/bold");
Bold.tagName = "strong";
Quill.register(Bold, true);

const Link = Quill.import("formats/link");
class AlertLink extends Link {
  static create(value) {
    let node = super.create(value);
    node.setAttribute("class", "alert-link");
    node.removeAttribute("rel");
    node.removeAttribute("target");
    return node;
  }

  static formats(node) {
    return node.getAttribute("href");
  }
}

const Embed = Quill.import("blots/embed");

class LineBreak extends Embed {
  static create() {
    let node = super.create();
    return node;
  }

  static value() {
    return undefined;
  }

  length() {
    return 1;
  }

  insertInto(parent, ref) {
    super.insertInto(parent, ref);
  }
}

LineBreak.blotName = "linebreak";
LineBreak.tagName = "br";

Quill.register(LineBreak, true);

document.addEventListener("DOMContentLoaded", function () {
  setupEventListeners();
  updateMessageOptions(1);
  initializeQuillEditor(1);
  initializeAlertQuillEditors();
  setupAlertEventListeners();
});

function initializeQuillEditor(entryId) {
  const quillEnEditor = new Quill(`#custom-en-editor-${entryId}`, {
    theme: "snow",
    modules: {
      toolbar: {
        container: [["bold"], [{ list: "ordered" }, { list: "bullet" }], ["link"], ["linebreak"], ["clean"]],
        handlers: {
          linebreak: function () {
            const range = this.quill.getSelection(true);
            if (range) {
              this.quill.insertEmbed(range.index, "linebreak", true, Quill.sources.USER);
              this.quill.setSelection(range.index + 1, Quill.sources.SILENT);
            }
          },
        },
      },
    },
    placeholder: "Enter your custom message in English...",
  });

  const quillFrEditor = new Quill(`#custom-fr-editor-${entryId}`, {
    theme: "snow",
    modules: {
      toolbar: {
        container: [["bold"], [{ list: "ordered" }, { list: "bullet" }], ["link"], ["linebreak"], ["clean"]],
        handlers: {
          linebreak: function () {
            const range = this.quill.getSelection(true);
            if (range) {
              this.quill.insertEmbed(range.index, "linebreak", true, Quill.sources.USER);
              this.quill.setSelection(range.index + 1, Quill.sources.SILENT);
            }
          },
        },
      },
    },
    placeholder: "Entrez votre message personnalisé en français...",
  });

  quillInstances[`en-${entryId}`] = quillEnEditor;
  quillInstances[`fr-${entryId}`] = quillFrEditor;

  quillEnEditor.on("text-change", function () {
    document.getElementById(`custom-en-${entryId}`).value = sanitizeContent(quillEnEditor.root.innerHTML);
  });

  quillFrEditor.on("text-change", function () {
    document.getElementById(`custom-fr-${entryId}`).value = sanitizeContent(quillFrEditor.root.innerHTML);
  });
}

function initializeAlertQuillEditors() {
  Quill.register(AlertLink, true);

  const alertEnEditor = new Quill("#alert-en-editor", {
    theme: "snow",
    modules: {
      toolbar: {
        container: [["bold"], [{ list: "ordered" }, { list: "bullet" }], ["link"], ["linebreak"], ["clean"]],
        handlers: {
          linebreak: function () {
            const range = this.quill.getSelection(true);
            if (range) {
              this.quill.insertEmbed(range.index, "linebreak", true, Quill.sources.USER);
              this.quill.setSelection(range.index + 1, Quill.sources.SILENT);
            }
          },
        },
      },
    },
    placeholder: "Enter your alert message in English...",
  });

  const alertFrEditor = new Quill("#alert-fr-editor", {
    theme: "snow",
    modules: {
      toolbar: {
        container: [["bold"], [{ list: "ordered" }, { list: "bullet" }], ["link"], ["linebreak"], ["clean"]],
        handlers: {
          linebreak: function () {
            const range = this.quill.getSelection(true);
            if (range) {
              this.quill.insertEmbed(range.index, "linebreak", true, Quill.sources.USER);
              this.quill.setSelection(range.index + 1, Quill.sources.SILENT);
            }
          },
        },
      },
    },
    placeholder: "Entrez votre message d'alerte en français...",
  });

  alertEnEditor.root.innerHTML = "<p><br></p>";
  alertFrEditor.root.innerHTML = "<p><br></p>";

  quillInstances["alert-en"] = alertEnEditor;
  quillInstances["alert-fr"] = alertFrEditor;

  function getFullContent(editor, header) {
    const editorContent = editor.root.innerHTML.trim();
    return `<h3>${header}</h3>${editorContent}`;
  }

  document.getElementById("alert-en").value = getFullContent(alertEnEditor, "Note");
  document.getElementById("alert-fr").value = getFullContent(alertFrEditor, "Remarque");

  alertEnEditor.on("text-change", function () {
    document.getElementById("alert-en").value = sanitizeContent(getFullContent(alertEnEditor, "Note"));
    updateAlertPreview();
  });

  alertFrEditor.on("text-change", function () {
    document.getElementById("alert-fr").value = sanitizeContent(getFullContent(alertFrEditor, "Remarque"));
    updateAlertPreview();
  });
}

function setupAlertEventListeners() {
  document.getElementById("alert-type").addEventListener("change", updateAlertPreview);
  document.getElementById("alertForm").addEventListener("submit", handleAlertFormSubmit);
  document.getElementById("removeAlertBtn").addEventListener("click", handleRemoveAlert);
  document.getElementById("alertForm").addEventListener("reset", function () {
    setTimeout(() => {
      if (quillInstances["alert-en"]) {
        quillInstances["alert-en"].setText("");
      }
      if (quillInstances["alert-fr"]) {
        quillInstances["alert-fr"].setText("");
      }
      document.getElementById("alert-preview-container").style.display = "none";
    }, 10);
  });
}

function updateAlertPreview() {
  const alertType = document.getElementById("alert-type").value;
  const alertEnContent = quillInstances["alert-en"] ? quillInstances["alert-en"].root.innerHTML : "";
  const alertFrContent = quillInstances["alert-fr"] ? quillInstances["alert-fr"].root.innerHTML : "";
  const previewContainer = document.getElementById("alert-preview-container");
  const previewEn = document.getElementById("alert-preview-en");
  const previewFr = document.getElementById("alert-preview-fr");

  if (alertType && (alertEnContent.trim() || alertFrContent.trim())) {
    previewContainer.style.display = "block";

    previewEn.className = `alert alert-${alertType} alert-preview`;
    previewEn.innerHTML = `<h3>Note</h3>${alertEnContent || "<em>No English content</em>"}`;

    previewFr.className = `alert alert-${alertType} alert-preview`;
    previewFr.innerHTML = `<h3>Remarque</h3>${alertFrContent || "<em>Aucun contenu français</em>"}`;
  } else {
    previewContainer.style.display = "none";
  }
}

function handleAlertFormSubmit(e) {
  e.preventDefault();

  const alertType = document.getElementById("alert-type").value;
  const alertEnContent = document.getElementById("alert-en").value.trim();
  const alertFrContent = document.getElementById("alert-fr").value.trim();

  if (!alertType) {
    showAlert(getLocalizedText("Please select an alert type.", "Veuillez sélectionner un type d'alerte."), "danger");
    return;
  }

  if (!alertEnContent && !alertFrContent) {
    showAlert(getLocalizedText("Please enter at least one alert message.", "Veuillez entrer au moins un message d'alerte."), "danger");
    return;
  }

  generateAlertSHTMFile(alertType, alertEnContent, alertFrContent);
  showAlert(getLocalizedText("Alert SHTM file generated successfully.", "Fichier SHTM d'alerte généré avec succès."), "success");
}

function handleRemoveAlert() {
  const emptyContent = "";
  const blob = new Blob([emptyContent], { type: "text/html" });
  const url = window.URL.createObjectURL(blob);
  const a = document.createElement("a");
  a.href = url;
  a.download = "alert.shtm";
  document.body.appendChild(a);
  a.click();

  window.URL.revokeObjectURL(url);
  document.body.removeChild(a);

  showAlert(getLocalizedText("Empty alert SHTM file generated successfully.", "Fichier SHTM d'alerte vide généré avec succès."), "success");
}

function generateAlertSHTMFile(alertType, alertEnContent, alertFrContent) {
  const shtmlContent = `<!--#if expr="\${pg-lang1} = 'eng'"-->
		<div class="alert alert-${alertType}" role="alert">
			${alertEnContent}
		</div>
		<!--#else -->
		<div class="alert alert-${alertType}" role="alert">
			${alertFrContent}
		</div>
		<!--#endif -->`;

  const blob = new Blob([shtmlContent], { type: "text/html" });
  const url = window.URL.createObjectURL(blob);
  const a = document.createElement("a");
  a.href = url;
  a.download = "alert.shtm";
  document.body.appendChild(a);
  a.click();

  window.URL.revokeObjectURL(url);
  document.body.removeChild(a);
}

function setupEventListeners() {
  document.addEventListener("change", function (e) {
    if (e.target.classList.contains("application-radio") || e.target.classList.contains("status-radio")) {
      const entryId = e.target.name.split("-")[1];
      updateMessageOptions(entryId);
      if (e.target.classList.contains("status-radio")) {
        toggleMessageDropdown(entryId);
      }
    }

    if (e.target.classList.contains("message-select")) {
      const entryId = e.target.id.split("-")[1];
      toggleCustomMessage(entryId, e.target.value);
    }
  });

  document.getElementById("addEntryBtn").addEventListener("click", addStatusEntry);
  document.getElementById("statusForm").addEventListener("submit", handleFormSubmit);

  document.getElementById("statusForm").addEventListener("reset", function () {
    setTimeout(() => {
      document.querySelectorAll(".custom-message-section").forEach((section) => {
        section.classList.remove("show");
      });
      document.querySelectorAll(".status-entry").forEach((entry) => {
        const entryId = entry.dataset.entryId;
        const messageGroup = document.getElementById(`message-${entryId}`).closest(".form-group");
        messageGroup.style.display = "block";
      });
    }, 10);
  });
}

function updateMessageOptions(entryId) {
  const appRadio = document.querySelector(`input[name="application-${entryId}"]:checked`);
  const statusRadio = document.querySelector(`input[name="status-${entryId}"]:checked`);
  const messageSelect = document.getElementById(`message-${entryId}`);

  const app = appRadio ? appRadio.value : null;
  const status = statusRadio ? statusRadio.value : null;

  messageSelect.innerHTML = `
				<option value="" data-en="Select a message" data-fr="Sélectionnez un message">Select a message</option>
			`;

  if (app && status && messageTemplates[app] && messageTemplates[app][status]) {
    messageTemplates[app][status].forEach((msg) => {
      const option = document.createElement("option");
      option.value = msg.value;
      option.dataset.en = msg.en;
      option.dataset.fr = msg.fr;

      const currentLang = document.documentElement.lang?.split("-")[0] || "en";

      if (msg.label) {
        option.textContent = currentLang === "en" ? msg.label.en : msg.label.fr;
      } else {
        option.textContent = currentLang === "en" ? msg.en : msg.fr;
      }

      messageSelect.appendChild(option);
    });
  }

  const otherOption = document.createElement("option");
  otherOption.value = "other";
  otherOption.dataset.en = "Other";
  otherOption.dataset.fr = "Autre";

  const currentLang = document.documentElement.lang?.split("-")[0] || "en";
  otherOption.textContent = currentLang === "en" ? "Other" : "Autre";
  messageSelect.appendChild(otherOption);

  messageSelect.value = "";
  toggleCustomMessage(entryId, "");
}

function toggleCustomMessage(entryId, value) {
  const customSection = document.getElementById(`custom-message-${entryId}`);
  const customEnInput = document.getElementById(`custom-en-${entryId}`);
  const customFrInput = document.getElementById(`custom-fr-${entryId}`);

  if (value === "other") {
    customSection.classList.add("show");
    customEnInput.required = true;
    customFrInput.required = true;
    customEnInput.setAttribute("aria-required", "true");
    customFrInput.setAttribute("aria-required", "true");
  } else {
    customSection.classList.remove("show");
    customEnInput.required = false;
    customFrInput.required = false;
    customEnInput.removeAttribute("aria-required");
    customFrInput.removeAttribute("aria-required");

    if (quillInstances[`en-${entryId}`]) {
      quillInstances[`en-${entryId}`].setText("");
    }
    if (quillInstances[`fr-${entryId}`]) {
      quillInstances[`fr-${entryId}`].setText("");
    }
    customEnInput.value = "";
    customFrInput.value = "";
  }
}

function toggleMessageDropdown(entryId) {
  const statusRadio = document.querySelector(`input[name="status-${entryId}"]:checked`);
  const messageGroup = document.getElementById(`message-${entryId}`).closest(".form-group");

  if (statusRadio && statusRadio.value === "no-issues") {
    messageGroup.style.display = "none";
    document.getElementById(`message-${entryId}`).required = false;
    document.getElementById(`message-${entryId}`).value = "";
    toggleCustomMessage(entryId, "");
  } else {
    messageGroup.style.display = "block";
    document.getElementById(`message-${entryId}`).required = true;
  }
}

function addStatusEntry() {
  const currentEntries = document.querySelectorAll(".status-entry").length;
  if (currentEntries >= 2) {
    showAlert(getLocalizedText("Maximum of 2 status entries allowed.", "Maximum de 2 entrées de statut autorisées."), "warning");
    return;
  }

  entryCounter++;
  const container = document.getElementById("statusEntriesContainer");

  const newEntry = document.createElement("div");
  newEntry.className = "status-entry";
  newEntry.dataset.entryId = entryCounter;
  newEntry.innerHTML = `
                <h2 class="h4">
                    <span data-en="Status entry" data-fr="Entrée de statut">Status entry</span> #<span class="entry-number">${entryCounter}</span>
                </h2>
                
                <div class="form-group">
                    <fieldset>
                        <legend class="bilingual-label">
                            <span data-en="Application" data-fr="Application">Application</span>
                            <span class="text-danger">(<span data-en="required" data-fr="obligatoire">required</span>)</span>
                            <small id="application-help-${entryCounter}" class="form-text text-muted d-block" data-en="Choose the application to update." data-fr="Choisissez l'application à mettre à jour.">Choose the application to update.</small>
                        </legend>
                        <div class="form-check">
                            <input class="form-check-input application-radio" type="radio" name="application-${entryCounter}" id="application-outlook-${entryCounter}" value="outlook" required aria-describedby="application-help-${entryCounter}">
                            <label class="form-check-label" for="application-outlook-${entryCounter}">
                                Microsoft Outlook
                            </label>
                        </div>
                        <div class="form-check">
                            <input class="form-check-input application-radio" type="radio" name="application-${entryCounter}" id="application-m365-${entryCounter}" value="m365" required aria-describedby="application-help-${entryCounter}">
                            <label class="form-check-label" for="application-m365-${entryCounter}">
                                Microsoft 365 (M365)
                            </label>
                        </div>
                    </fieldset>
                </div>

                <div class="form-group">
                    <fieldset>
                        <legend class="bilingual-label">
                            <span data-en="Current status" data-fr="Statut actuel">Current status</span>
                            <span class="text-danger">(<span data-en="required" data-fr="obligatoire">required</span>)</span>
                            <small id="status-help-${entryCounter}" class="form-text text-muted d-block" data-en="Select the current operational status." data-fr="Sélectionnez le statut opérationnel actuel.">Select the current operational status.</small>
                        </legend>
                        <div class="form-check">
                            <input class="form-check-input status-radio" type="radio" name="status-${entryCounter}" id="status-no-issues-${entryCounter}" value="no-issues" required aria-describedby="status-help-${entryCounter}">
                            <label class="form-check-label" for="status-no-issues-${entryCounter}">
                                <span data-en="No reported issues" data-fr="Aucun problème signalé">No reported issues</span>
                            </label>
                        </div>
                        <div class="form-check">
                            <input class="form-check-input status-radio" type="radio" name="status-${entryCounter}" id="status-incident-${entryCounter}" value="incident" required aria-describedby="status-help-${entryCounter}">
                            <label class="form-check-label" for="status-incident-${entryCounter}">
                                <span data-en="Incident" data-fr="Incident">Incident</span>
                            </label>
                        </div>
                        <div class="form-check">
                            <input class="form-check-input status-radio" type="radio" name="status-${entryCounter}" id="status-outage-${entryCounter}" value="outage" required aria-describedby="status-help-${entryCounter}">
                            <label class="form-check-label" for="status-outage-${entryCounter}">
                                <span data-en="Outage" data-fr="Panne">Outage</span>
                            </label>
                        </div>
                    </fieldset>
                </div>
                
                <div class="form-group">
                    <label class="bilingual-label" for="message-${entryCounter}">
                        <span data-en="Status message" data-fr="Message de statut">Status message</span>
                        <span class="text-danger">(<span data-en="required" data-fr="obligatoire">required</span>)</span>
                        <small id="message-help-${entryCounter}" class="form-text text-muted d-block" data-en="Choose a pre-defined message or select 'Other' to write your own." data-fr="Choisissez un message prédéfini ou sélectionnez « Autre » pour écrire le vôtre.">Choose a pre-defined message or select "Other" to write your own.</small>
                    </label>
                    <select class="form-control message-select" id="message-${entryCounter}" name="message-${entryCounter}" required aria-required="true" aria-describedby="message-help-${entryCounter}">
                        <option value="" data-en="Select a message" data-fr="Sélectionnez un message">Select a message</option>
                        <option value="other" data-en="Other" data-fr="Autre">Other</option>
                    </select>
                </div>
                
                <div class="custom-message-section" id="custom-message-${entryCounter}" role="region" aria-labelledby="custom-message-heading-${entryCounter}">
                    <h3 class="h5" id="custom-message-heading-${entryCounter}" data-en="Custom message" data-fr="Message personnalisé">Custom message</h3>
                    
                    <div class="form-group">
                        <div class="bilingual-label">
                            <span data-en="English message" data-fr="Message en anglais">English message</span>
                            <small id="custom-en-help-${entryCounter}" class="form-text text-muted d-block" data-en="Enter your custom message in English." data-fr="Entrez votre message personnalisé en anglais.">Enter your custom message in English.</small>
                        </div>
                        <div id="custom-en-editor-${entryCounter}" class="custom-message-en" style="min-height: 150px;"></div>
                        <input type="hidden" id="custom-en-${entryCounter}" name="custom-en-${entryCounter}">
                    </div>

                    <div class="form-group">
                        <div class="bilingual-label">
                            <span data-en="French message" data-fr="Message en français">French message</span>
                            <small id="custom-fr-help-${entryCounter}" class="form-text text-muted d-block" data-en="Enter your custom message in French." data-fr="Entrez votre message personnalisé en français.">Enter your custom message in French.</small>
                        </div>
                        <div id="custom-fr-editor-${entryCounter}" class="custom-message-fr" style="min-height: 150px;"></div>
                        <input type="hidden" id="custom-fr-${entryCounter}" name="custom-fr-${entryCounter}">
                    </div>
                </div>
            
            <button type="button" class="btn btn-danger btn-sm remove-entry-btn" data-entry-id="${entryCounter}" data-en="Remove this entry" data-fr="Supprimer cette entrée">Remove this entry</button>
        `;

  container.appendChild(newEntry);
  initializeQuillEditor(entryCounter);

  const currentCounter = entryCounter;
  newEntry.querySelector(".remove-entry-btn").addEventListener("click", function () {
    delete quillInstances[`en-${currentCounter}`];
    delete quillInstances[`fr-${currentCounter}`];
    newEntry.remove();
    updateAddButtonVisibility();
    showAlert(getLocalizedText("Entry removed successfully.", "Entrée supprimée avec succès."), "info");
  });

  updateMessageOptions(entryCounter);

  const currentLang = document.documentElement.lang?.split("-")[0] || "en";
  updateElementLanguage(newEntry, currentLang);

  const firstRadio = newEntry.querySelector(".application-radio");
  if (firstRadio) firstRadio.focus();

  updateAddButtonVisibility();
  showAlert(getLocalizedText("New status entry added.", "Nouvelle entrée de statut ajoutée."), "success");
}

function updateAddButtonVisibility() {
  const addBtn = document.getElementById("addEntryBtn");
  const currentEntries = document.querySelectorAll(".status-entry").length;

  if (currentEntries >= 2) {
    addBtn.style.display = "none";
  } else {
    addBtn.style.display = "inline-block";
  }
}

function updateElementLanguage(element, lang) {
  const isEnglish = lang === "en-CA" || lang === "en";
  element.querySelectorAll("[data-en][data-fr]").forEach((el) => {
    const text = isEnglish ? el.getAttribute("data-en") : el.getAttribute("data-fr");
    if (el.tagName === "INPUT" || el.tagName === "TEXTAREA") {
      el.placeholder = text;
    } else if (el.tagName === "OPTION") {
      el.textContent = text;
    } else {
      el.innerHTML = text;
    }
  });
}

function getLocalizedText(enText, frText) {
  const currentLang = document.documentElement.lang?.split("-")[0] || "en";
  return currentLang === "en" ? enText : frText;
}

function handleFormSubmit(e) {
  e.preventDefault();

  if (!validateForm()) {
    showAlert(getLocalizedText("Please fill in all required fields.", "Veuillez remplir tous les champs obligatoires."), "danger");
    return;
  }

  const formData = collectFormData();

  if (formData.length === 0) {
    showAlert(getLocalizedText("No valid entries to export.", "Aucune entrée valide à exporter."), "warning");
    return;
  }

  formData.forEach((entry) => {
    generateSHTMFile(entry);
  });

  showAlert(
    getLocalizedText(`Successfully generated ${formData.length} SHTM file(s).`, `${formData.length} fichier(s) SHTM généré(s) avec succès.`),
    "success"
  );
}

function validateForm() {
  const form = document.getElementById("statusForm");
  let isValid = true;

  if (!form.checkValidity()) {
    form.classList.add("was-validated");
    return false;
  }

  document.querySelectorAll(".status-entry").forEach((entry) => {
    const entryId = entry.dataset.entryId;
    const messageSelect = document.getElementById(`message-${entryId}`);

    if (messageSelect && messageSelect.value === "other") {
      const customEnInput = document.getElementById(`custom-en-${entryId}`);
      const customFrInput = document.getElementById(`custom-fr-${entryId}`);

      let enContent = customEnInput.value.trim();
      let frContent = customFrInput.value.trim();

      if (quillInstances[`en-${entryId}`]) {
        enContent = quillInstances[`en-${entryId}`].getText().trim();
      }
      if (quillInstances[`fr-${entryId}`]) {
        frContent = quillInstances[`fr-${entryId}`].getText().trim();
      }

      if (!enContent || !frContent) {
        isValid = false;
        const enEditor = document.getElementById(`custom-en-editor-${entryId}`);
        const frEditor = document.getElementById(`custom-fr-editor-${entryId}`);
        if (enEditor) enEditor.style.border = "2px solid #dc3545";
        if (frEditor) frEditor.style.border = "2px solid #dc3545";
      }
    }
  });

  return isValid;
}

function collectFormData() {
  const entries = [];

  document.querySelectorAll(".status-entry").forEach((entry) => {
    const entryId = entry.dataset.entryId;
    const appRadio = document.querySelector(`input[name="application-${entryId}"]:checked`);
    const statusRadio = document.querySelector(`input[name="status-${entryId}"]:checked`);
    const app = appRadio ? appRadio.value : null;
    const status = statusRadio ? statusRadio.value : null;

    if (!app || !status) {
      return;
    }

    if (status === "no-issues") {
      entries.push({
        application: app,
        status: status,
        messageEn: "",
        messageFr: "",
      });
      return;
    }

    const messageSelect = document.getElementById(`message-${entryId}`);
    const messageValue = messageSelect.value;

    if (!messageValue) {
      return;
    }

    let messageEn, messageFr;

    if (messageValue === "other") {
      messageEn = document.getElementById(`custom-en-${entryId}`).value.trim();
      messageFr = document.getElementById(`custom-fr-${entryId}`).value.trim();

      if (!messageEn && quillInstances[`en-${entryId}`]) {
        messageEn = quillInstances[`en-${entryId}`].root.innerHTML.trim();
      }
      if (!messageFr && quillInstances[`fr-${entryId}`]) {
        messageFr = quillInstances[`fr-${entryId}`].root.innerHTML.trim();
      }
    } else {
      const selectedOption = messageSelect.options[messageSelect.selectedIndex];
      messageEn = selectedOption.dataset.en;
      messageFr = selectedOption.dataset.fr;
    }

    entries.push({
      application: app,
      status: status,
      messageEn: messageEn,
      messageFr: messageFr,
    });
  });

  return entries;
}

function generateSHTMFile(entry) {
  const timestamp = new Date().toISOString();
  const filename = entry.application === "outlook" ? "outlook.shtm" : "m365.shtm";

  const appDisplayNames = {
    outlook: {
      en: "Microsoft Outlook",
      fr: "Microsoft Outlook",
    },
    m365: {
      en: "Microsoft 365 (M365)",
      fr: "Microsoft 365 (M365)",
    },
  };

  const statusConfig = {
    "no-issues": {
      en: "No reported issues",
      fr: "Aucun problème signalé",
      icon: "fa-check-circle",
      color: "text-success",
      ariaLabelEn: "No reported issues",
      ariaLabelFr: "Aucun problème signalé",
    },
    incident: {
      en: "Incident",
      fr: "Incident",
      icon: "fa-exclamation-triangle",
      color: "text-warning",
      ariaLabelEn: "Incident",
      ariaLabelFr: "Incident",
    },
    outage: {
      en: "Outage",
      fr: "Panne",
      icon: "fa-times-circle",
      color: "text-danger",
      ariaLabelEn: "Outage",
      ariaLabelFr: "Panne",
    },
  };

  const appNameEn = appDisplayNames[entry.application].en;
  const appNameFr = appDisplayNames[entry.application].fr;
  const statusInfo = statusConfig[entry.status];

  let shtmlContent;

  const messageEnHTML = entry.messageEn ? entry.messageEn : "";
  const messageFrHTML = entry.messageFr ? entry.messageFr : "";

  shtmlContent = `<!--#if expr="\${pg-lang1} = 'eng'"-->
        <p class="mb-0"><span class="sr-only">Status: </span><strong>${statusInfo.en}</strong></p>
        ${messageEnHTML}
        </div>
        <i class="fas ${statusInfo.icon} fa-lg ${statusInfo.color} m-3" aria-label="${statusInfo.ariaLabelEn}" role="img"></i>
        <!--#else -->
        <p class="mb-0"><span class="sr-only">État&#160;:&#160;</span><strong>${statusInfo.fr}</strong></p>
        ${messageFrHTML}
        </div>
        <i class="fas ${statusInfo.icon} fa-lg ${statusInfo.color} m-3" aria-label="${statusInfo.ariaLabelFr}" role="img"></i>
        <!--#endif -->`;
  const blob = new Blob([shtmlContent], { type: "text/html" });
  const url = window.URL.createObjectURL(blob);
  const a = document.createElement("a");
  a.href = url;
  a.download = filename;
  document.body.appendChild(a);
  a.click();

  window.URL.revokeObjectURL(url);
  document.body.removeChild(a);
}

function showAlert(message, type) {
  const alertContainer = document.getElementById("alertContainer");
  const alert = document.createElement("div");
  alert.className = `alert alert-${type} alert-dismissible fade show`;
  alert.setAttribute("role", "alert");
  alert.innerHTML = `
            ${message}
            <button type="button" class="btn-close" data-bs-dismiss="alert" aria-label="Close"></button>
        `;
  alertContainer.appendChild(alert);

  setTimeout(() => {
    alert.classList.remove("show");
    setTimeout(() => alert.remove(), 150);
  }, 5000);
}

function sanitizeContent(html) {
  const tempDiv = document.createElement("div");
  tempDiv.innerHTML = html;

  function processTextNode(node) {
    let text = node.textContent;
    let modified = false;

    const msReplaced = text.replace(/\bMS\b/g, "Microsoft");
    if (msReplaced !== text) {
      text = msReplaced;
      modified = true;
    }

    const abbrs = ["RCMP", "GRC", "ROSS", "HRMIS", "SIGRH"];

    abbrs.forEach((abbr) => {
      const pattern = new RegExp(`\\b${abbr}\\b`, "g");
      if (pattern.test(text)) {
        modified = true;
      }
    });

    if (modified) {
      const span = document.createElement("span");
      span.innerHTML = text;

      abbrs.forEach((abbr) => {
        const pattern = new RegExp(`\\b${abbr}\\b`, "g");
        span.innerHTML = span.innerHTML.replace(pattern, `<abbr>$&</abbr>`);
      });

      node.parentNode.replaceChild(span, node);

      while (span.firstChild) {
        span.parentNode.insertBefore(span.firstChild, span);
      }
      span.parentNode.removeChild(span);
    }
  }

  function walkNodes(node) {
    if (node.nodeType === Node.TEXT_NODE) {
      if (node.parentNode.tagName !== "ABBR") {
        processTextNode(node);
      }
    } else if (node.nodeType === Node.ELEMENT_NODE && node.tagName !== "ABBR") {
      Array.from(node.childNodes).forEach(walkNodes);
    }
  }

  walkNodes(tempDiv);

  let result = tempDiv.innerHTML;
  result = result.replace(/<p><br><\/p>/g, "");
  result = result.replace(/<p><\/p>/g, "");

  return result;
}
