const ORCAVIA_APP_VERSION="1.0.2",ORCAVIA_VERSION_STRING="Version 1.0.1";document.addEventListener("DOMContentLoaded",(()=>{const t=document.getElementById("version-info");t&&(t.textContent="Version 1.0.1")}));class RCMPDataEditor{constructor(){this.data={data:[]},this.themeMapping={"Systemic barriers":"Les obstacle systémiques",Recruitment:"Le recrutement","Training at Depot":"La formation à la division Dépôt","Recruit field training":"La formation pratique des recrues",Postings:"Les affectations","Ongoing training":"La formation continue","Human resources and staffing":"Les ressources humaines et la dotation","Maternity and parental leave":"Le congé de maternité et le congé parental","Employment flexibility":"La flexibilité de l'emploi","Grievances and discipline":"Les griefs et la disciplines","Mental health":"La santé mentale",Promotions:"Les promotions",Leadership:"Le leadership","Specialized teams":"Les équipes spécialisées","Medical Examination":"L'examen médical","Temporary civilian employees, civilian members and public service employees":"Employés civiles temporaires, membres civiles et fonctionnaires"},this.reversedThemeMapping=Object.fromEntries(Object.entries(this.themeMapping).map((([t,e])=>[e,t]))),this.waitForLanguageInitialization()}init(){document.getElementById("file-upload").addEventListener("change",(t=>this.handleFileUpload(t))),document.getElementById("add-record-btn").addEventListener("click",(()=>this.addNewRecord())),document.getElementById("download-btn").addEventListener("click",(()=>this.downloadData())),document.getElementById("load-from-url-btn").addEventListener("click",(()=>this.loadFromURL())),this.render()}showAlert(t,e="success"){const a=document.getElementById("alerts-container"),n=document.createElement("div");n.className=`alert alert-${e} alert-dismissible fade show`;const r=window.languageSwitcher&&"fr"===window.languageSwitcher.currentLang?"Fermer":"Close";let i;if("object"==typeof t&&t.en&&t.fr){const e="fr"===(window.languageSwitcher?window.languageSwitcher.currentLang:"en")?t.fr:t.en;i=`<span data-en="${t.en}" data-fr="${t.fr}">${e}</span>`}else i=t;n.innerHTML=`\n\t ${i}\n\t <button type="button" class="btn-close" data-bs-dismiss="alert" aria-label="${r}"></button>\n\t `,a.appendChild(n),window.languageSwitcher&&window.languageSwitcher.switchLanguage(window.languageSwitcher.currentLang),setTimeout((()=>{n.parentNode&&n.remove()}),5e3)}showUpdateAlert(t,e,a="danger"){const n=document.getElementById(`update-alerts-${t}`);if(!n)return;n.innerHTML="";const r=document.createElement("div");r.className=`alert alert-${a} alert-dismissible fade show`;const i=window.languageSwitcher&&"fr"===window.languageSwitcher.currentLang?"Fermer":"Close";r.innerHTML=`\n\t\t\t${e}\n\t\t\t<button type="button" class="btn-close" data-bs-dismiss="alert" aria-label="${i}"></button>\n\t\t`,n.appendChild(r),setTimeout((()=>{r.parentNode&&r.remove()}),5e3)}sanitizeText(t){if(!t||"string"!=typeof t)return t;let e=t;e=e.replace(/’/g,"'"),e=e.replace(/ »/g,"&#160;»"),e=e.replace(/« /g,"«&#160;"),e=e.replace(/<p><br><\/p>/g,""),e=e.replace(/ /g," &#160;");const a=e.includes("<p>")||e.includes("ql-");e=e.replace(/\b[A-Za-z0-9._%+-]+@[A-Za-z0-9.-]+\.[A-Z|a-z]{2,}\b/g,(t=>{const n=t.toLowerCase(),r=e.substring(0,e.indexOf(t)),i=e.substring(e.indexOf(t)+t.length);return r.includes('<a href="mailto:')&&!r.includes("</a>")&&i.includes("</a>")||a&&r.includes("<a ")&&i.includes("</a>")?n:a?t:`<a href="mailto:${n}">${n}</a>`}));return["RCMP","GRC","MCC","CACP","CISC","ATIP","CPM","ACCP","SCRC","AIPRP","ICIR","IIIC","CAD","RAO","CCG","MAB","GBA","EDI","ACS","DICE","DREAM","HR","PSEA","CRH","HRC","MR","RM","ICHR","CES","PEC","NMP","PNM","AM","CIRH","FCP","PFT","PE","RH","LEFP","PSDPA","CM","LPDAC"].forEach((t=>{e=((t,e)=>t.replace(new RegExp(`(?<!<abbr[^>]*>)\\b${e}\\b(?!</abbr>)`,"g"),((t,e,a)=>{const n=a.substring(0,e),r=a.substring(e+t.length);return n.lastIndexOf("<abbr")>n.lastIndexOf("</abbr>")&&r.includes("</abbr>")?t:`<abbr>${t}</abbr>`})))(e,t)})),e}sanitizeRecord(t){const e={};for(const[a,n]of Object.entries(t))e[a]="string"==typeof n?this.sanitizeText(n):n;return e}sanitizeAllData(){return{...this.data,data:this.data.data.map((t=>this.sanitizeRecord(t)))}}async restoreScrollPosition(t){return new Promise((e=>{let a=0;const n=()=>{a++;const r=document.documentElement.scrollHeight,i=window.innerHeight;t<=r-i||a>=10?(window.scrollTo({top:Math.min(t,r-i),behavior:"instant"}),e()):requestAnimationFrame(n)};requestAnimationFrame(n)}))}async loadFromURL(){const t=document.getElementById("load-from-url-btn"),e=t.textContent,a=window.pageYOffset||document.documentElement.scrollTop;try{t.textContent="Loading...",t.disabled=!0;const e=await fetch("bas.json");if(!e.ok)throw new Error(`HTTP error! status: ${e.status}`);const n=await e.json();if(!n.data||!Array.isArray(n.data)){const t=window.languageSwitcher&&"fr"===window.languageSwitcher.currentLang?"Structure JSON invalide depuis l'URL":"Invalid JSON structure from URL";throw new Error(t)}this.data=n,this.render(),await this.restoreScrollPosition(a),this.showAlert({en:`Successfully loaded ${n.data.length} records from website!`,fr:`${n.data.length} enregistrements chargés avec succès depuis le site web !`})}catch(t){const e=window.languageSwitcher&&"fr"===window.languageSwitcher.currentLang?"Erreur lors du chargement des données depuis le site web : "+t.message:"Error loading data from website: "+t.message;this.showAlert(e,"error")}finally{t.textContent=e,t.disabled=!1}}async handleFileUpload(t){const e=t.target.files[0];if(!e)return;const a=window.pageYOffset||document.documentElement.scrollTop,n=new FileReader;n.onload=async t=>{try{const e=JSON.parse(t.target.result);if(!e.data||!Array.isArray(e.data)){const t=window.languageSwitcher&&"fr"===window.languageSwitcher.currentLang?"Structure JSON invalide":"Invalid JSON structure";throw new Error(t)}this.data=e,this.render(),await this.restoreScrollPosition(a),this.showAlert({en:"JSON file loaded successfully!",fr:"Fichier JSON chargé avec succès !"})}catch(t){const e=window.languageSwitcher&&"fr"===window.languageSwitcher.currentLang?"Erreur lors du chargement du fichier JSON : "+t.message:"Error loading JSON file: "+t.message;this.showAlert(e,"error")}},n.readAsText(e)}addNewRecord(){const t={"last-updated":this.getCurrentDateFormatted(),"english-theme":"","french-theme":"","english-title":"","french-title":"","english-summary":"","french-summary":"","english-progress":"In progress","french-progress":"En cours","recommendations-1":"","english-recommendation-summary-1":"","french-recommendation-summary-1":"","recommendations-2":"","english-recommendation-summary-2":"","french-recommendation-summary-2":"","recommendations-3":"","english-recommendation-summary-3":"","french-recommendation-summary-3":"","english-mcc-actions":"","french-mcc-actions":"","update-1-date":"","english-update-1":"","french-update-1":"","update-2-date":"","english-update-2":"","french-update-2":"","update-3-date":"","english-update-3":"","french-update-3":"","update-4-date":"","english-update-4":"","french-update-4":"","update-5-date":"","english-update-5":"","french-update-5":"","update-6-date":"","english-update-6":"","french-update-6":""};this.data.data.push(t),this.render(),setTimeout((()=>{const t=document.querySelectorAll(".record-card"),e=t[t.length-1];e&&e.scrollIntoView({behavior:"smooth",block:"start"})}),100),this.showAlert({en:"New record added successfully!",fr:"Nouvel enregistrement ajouté avec succès !"})}getCurrentDateFormatted(){const t=new Date;return`${t.getFullYear()}-${String(t.getMonth()+1).padStart(2,"0")}-${String(t.getDate()).padStart(2,"0")}`}deleteRecord(t){const e=window.languageSwitcher&&"fr"===window.languageSwitcher.currentLang?"Êtes-vous sûr de vouloir supprimer cet enregistrement ?":"Are you sure you want to delete this record?";confirm(e)&&(this.data.data.splice(t,1),this.render(),this.showAlert({en:"Record deleted successfully!",fr:"Enregistrement supprimé avec succès !"}))}downloadData(){const t=this.sanitizeAllData(),e=JSON.stringify(t,null,2),a=new Blob([e],{type:"application/json"}),n=URL.createObjectURL(a),r=document.createElement("a");r.href=n,r.download=`bas-data-${(new Date).toISOString().split("T")[0]}.json`,document.body.appendChild(r),r.click(),document.body.removeChild(r),URL.revokeObjectURL(n);const i=window.languageSwitcher&&"fr"===window.languageSwitcher.currentLang?"Données téléchargées avec succès avec formatage assaini !":"Data downloaded successfully with sanitized formatting!";this.showAlert(i)}updateRecord(t,e,a){if(this.data.data[t]){if((e.includes("date")||"last-updated"===e)&&a)if(/^\d{4}-\d{2}-\d{2}$/.test(a))this.data.data[t][e]=a;else{const n=new Date(a);if(isNaN(n.getTime()))this.data.data[t][e]=a;else{const a=n.getFullYear(),r=String(n.getMonth()+1).padStart(2,"0"),i=String(n.getDate()).padStart(2,"0");this.data.data[t][e]=`${a}-${r}-${i}`}}else this.data.data[t][e]=a;if("english-theme"===e&&this.themeMapping[a]){this.data.data[t]["french-theme"]=this.themeMapping[a];const e=document.getElementById(`french-theme-${t}`);e&&(e.value=this.themeMapping[a])}else if("french-theme"===e&&this.reversedThemeMapping[a]){this.data.data[t]["english-theme"]=this.reversedThemeMapping[a];const e=document.getElementById(`english-theme-${t}`);e&&(e.value=this.reversedThemeMapping[a])}else if("english-progress"===e){const e={"In progress":"En cours",Complete:"Terminé"};if(e[a]){this.data.data[t]["french-progress"]=e[a];const n=document.getElementById(`french-progress-${t}`);n&&(n.value=e[a])}}else if("french-progress"===e){const e={"En cours":"In progress","Terminé":"Complete"};if(e[a]){this.data.data[t]["english-progress"]=e[a];const n=document.getElementById(`english-progress-${t}`);n&&(n.value=e[a])}}}}getStatusClass(t){return t&&(t.toLowerCase().includes("complete")||t.toLowerCase().includes("terminé"))?"status-complete":"status-pending"}getThemeOptions(t,e=!0){return(e?Object.keys(this.themeMapping):Object.values(this.themeMapping)).map((e=>`<option value="${e}" ${t===e?"selected":""}>${e}</option>`)).join("")}formatAllDateInputs(){document.querySelectorAll('input[type="date"]').forEach((t=>{this.formatDateInput(t)}))}initializeQuillEditors(){if("undefined"!=typeof Quill){if(!Quill.imports["formats/abbr"]){const t=Quill.import("blots/inline");class e extends t{static blotName="abbr";static tagName="abbr"}Quill.register(e)}if(!Quill.imports["formats/cite"]){const t=Quill.import("blots/inline");class e extends t{static blotName="italic";static tagName="cite"}Quill.register(e,!0)}document.querySelectorAll(".quill-editor").forEach((t=>{t.getAttribute("data-editor-id");const e=t.getAttribute("data-field"),a=parseInt(t.getAttribute("data-record-index"));if(t.querySelector(".ql-toolbar"))return;const n=new Quill(t,{theme:"snow",modules:{toolbar:[["bold","italic"],["link"]],clipboard:{matchVisual:!1}}}),r=this.data.data[a];if(r&&r[e]){const t=r[e]||"";t&&n.clipboard.dangerouslyPasteHTML(t)}n.on("text-change",(()=>{let t=n.root.innerHTML;"<p><br></p>"===t&&(t=""),this.updateRecord(a,e,t)}))}))}}render(){const t=document.getElementById("records-container"),e=document.activeElement,a=e?e.id:null;if(0===this.data.data.length)return t.innerHTML='\n <div class="no-records">\n <h3 data-en="No records found" data-fr="Aucun enregistrement trouvé">No records found</h3>\n <p data-en="Upload a JSON file or add a new record to get started." data-fr="Téléversez un fichier JSON ou ajoutez un nouvel enregistrement pour commencer.">Upload a JSON file or add a new record to get started.</p>\n </div>\n ',window.languageSwitcher&&window.languageSwitcher.switchLanguage(window.languageSwitcher.currentLang),void this.formatAllDateInputs();const n=document.createDocumentFragment(),r=document.createElement("div");for(r.innerHTML=this.data.data.map(((t,e)=>`\n <div class="record-card">\n <div class="record-header">\n <div>\n <h2 class="h4 mb-1" data-en="Record ${e+1}${t["english-title"]?` - ${t["english-title"]}`:""}" data-fr="Enregistrement ${e+1}${t["french-title"]?` - ${t["french-title"]}`:""}">Record ${e+1}${t["english-title"]?` - ${t["english-title"]}`:""}</h2>\n\t\t\t\t\t\t<span class="status-badge ${this.getStatusClass(t["english-progress"])}">\n\t\t\t\t\t\t\t<span data-en="${t["english-progress"]||"Unknown status"}" data-fr="${t["french-progress"]||"Statut inconnu"}">${window.languageSwitcher&&"fr"===window.languageSwitcher.currentLang?t["french-progress"]||"Statut inconnu":t["english-progress"]||"Unknown status"}</span>\n\t\t\t\t\t\t</span>\n <small class="text-muted d-block mt-1" data-en="Updated: ${t["last-updated"]||"Not set"}" data-fr="Mis à jour : ${t["last-updated"]||"Non défini"}">Updated: ${t["last-updated"]||"Not set"}</small>\n </div>\n <button class="btn btn-danger btn-sm" onclick="editor.deleteRecord(${e})" data-en="Delete" data-fr="Supprimer">Delete</button>\n </div>\n \n <div class="record-body">\n <div class="mb-3">\n <label for="last-updated-${e}" class="form-label" data-en="Last updated" data-fr="Dernière mise à jour">Last updated</label>\n <input type="date" class="form-control" id="last-updated-${e}" value="${t["last-updated"]||""}"\n onchange="editor.updateRecord(${e}, 'last-updated', this.value)"\n pattern="\\d{4}-\\d{2}-\\d{2}" placeholder="YYYY-MM-DD"\n data-en-lang="en-CA" data-fr-lang="fr-CA">\n </div>\n\n <div class="form-row mb-3">\n <div>\n <label for="english-theme-${e}" class="form-label" data-en="English theme" data-fr="Thème anglais">English theme</label>\n <select class="form-select" id="english-theme-${e}" onchange="editor.updateRecord(${e}, 'english-theme', this.value)">\n <option value="">Select a theme...</option>\n ${this.getThemeOptions(t["english-theme"],!0)}\n </select>\n </div>\n <div>\n <label for="french-theme-${e}" class="form-label" data-en="French theme" data-fr="Thème français">French theme</label>\n <select class="form-select" id="french-theme-${e}" onchange="editor.updateRecord(${e}, 'french-theme', this.value)">\n <option value="">Sélectionner un thème...</option>\n ${this.getThemeOptions(t["french-theme"],!1)}\n </select>\n </div>\n </div>\n\n <div class="form-row mb-3">\n <div>\n <label for="english-title-${e}" class="form-label" data-en="English title" data-fr="Titre anglais">English title</label>\n <textarea class="form-control" id="english-title-${e}" rows="3" onchange="editor.updateRecord(${e}, 'english-title', this.value)">${t["english-title"]||""}</textarea>\n </div>\n <div>\n <label for="french-title-${e}" class="form-label" data-en="French title" data-fr="Titre français">French title</label>\n <textarea class="form-control" id="french-title-${e}" rows="3" onchange="editor.updateRecord(${e}, 'french-title', this.value)">${t["french-title"]||""}</textarea>\n </div>\n </div>\n\n\t\t\t\t\t<div class="form-row mb-3">\n <div>\n <label for="english-summary-${e}" class="form-label" data-en="English summary" data-fr="Résumé anglais">English summary</label>\n <div class="quill-editor" id="english-summary-${e}" data-editor-id="english-summary-${e}" data-field="english-summary" data-record-index="${e}"></div>\n </div>\n <div>\n <label for="french-summary-${e}" class="form-label" data-en="French summary" data-fr="Résumé français">French summary</label>\n <div class="quill-editor" id="french-summary-${e}" data-editor-id="french-summary-${e}" data-field="french-summary" data-record-index="${e}"></div>\n </div>\n </div>\n\n\t\t\t\t\t<div class="form-row mb-3">\n\t\t\t\t\t\t<div>\n\t\t\t\t\t\t\t<label for="english-progress-${e}" class="form-label" data-en="English progress" data-fr="Progrès anglais">English progress</label>\n\t\t\t\t\t\t\t<select class="form-select" id="english-progress-${e}" onchange="editor.updateRecord(${e}, 'english-progress', this.value)">\n\t\t\t\t\t\t\t\t<option value="In progress" ${"In progress"===t["english-progress"]?"selected":""}>In progress</option>\n\t\t\t\t\t\t\t\t<option value="Complete" ${"Complete"===t["english-progress"]?"selected":""}>Complete</option>\n\t\t\t\t\t\t\t</select>\n\t\t\t\t\t\t</div>\n\t\t\t\t\t\t<div>\n\t\t\t\t\t\t\t<label for="french-progress-${e}" class="form-label" data-en="French progress" data-fr="Progrès français">French progress</label>\n\t\t\t\t\t\t\t<select class="form-select" id="french-progress-${e}" onchange="editor.updateRecord(${e}, 'french-progress', this.value)">\n\t\t\t\t\t\t\t\t<option value="En cours" ${"En cours"===t["french-progress"]?"selected":""}>En cours</option>\n\t\t\t\t\t\t\t\t<option value="Terminé" ${"Terminé"===t["french-progress"]?"selected":""}>Terminé</option>\n\t\t\t\t\t\t\t</select>\n\t\t\t\t\t\t</div>\n\t\t\t\t\t</div>\n\n\t\t\t\t\t<div class="recommendation-section">\n\t\t\t\t\t\t<h3 class="h5" data-en="Recommendations" data-fr="Recommandations">Recommendations</h3>\n\t\t\t\t\t\t\n\t\t\t\t\t\t${[1,2,3].map((a=>1===a||t[`recommendations-${a}`]||t[`english-recommendation-summary-${a}`]||t[`french-recommendation-summary-${a}`]?`\n\t\t\t\t\t\t\t\t<div class="recommendation-item mb-3">\n\t\t\t\t\t\t\t\t\t${a>1?`\n\t\t\t\t\t\t\t\t\t\t<div class="d-flex justify-content-end mb-2">\n\t\t\t\t\t\t\t\t\t\t\t<button class="btn btn-outline-danger btn-sm" onclick="editor.deleteRecommendation(${e}, ${a})" data-en="Delete" data-fr="Supprimer">Delete</button>\n\t\t\t\t\t\t\t\t\t\t</div>\n\t\t\t\t\t\t\t\t\t`:""}\n\t\t\t\t\t\t\t\t\t\n\t\t\t\t\t\t\t\t\t<div class="mb-3">\n\t\t\t\t\t\t\t\t\t\t<label for="recommendations-${a}-${e}" class="form-label" data-en="Recommendation ${a}" data-fr="Recommandation ${a}">Recommendation ${a}</label>\n\t\t\t\t\t\t\t\t\t\t<input type="text" class="form-control" id="recommendations-${a}-${e}" value="${t[`recommendations-${a}`]||""}"\n\t\t\t\t\t\t\t\t\t\t\tonchange="editor.updateRecord(${e}, 'recommendations-${a}', this.value)">\n\t\t\t\t\t\t\t\t\t</div>\n\n\t\t\t\t\t\t\t\t\t<div class="form-row mb-3">\n\t\t\t\t\t\t\t\t\t\t<div>\n\t\t\t\t\t\t\t\t\t\t\t<label for="english-recommendation-summary-${a}-${e}" class="form-label" data-en="English recommendation summary ${a}" data-fr="Résumé des recommandations ${a} anglais">English recommendation summary ${a}</label>\n\t\t\t\t\t\t\t\t\t\t\t<div class="quill-editor" id="english-recommendation-summary-${a}-${e}" data-editor-id="english-recommendation-summary-${a}-${e}" data-field="english-recommendation-summary-${a}" data-record-index="${e}"></div>\n\t\t\t\t\t\t\t\t\t\t</div>\n\t\t\t\t\t\t\t\t\t\t<div>\n\t\t\t\t\t\t\t\t\t\t\t<label for="french-recommendation-summary-${a}-${e}" class="form-label" data-en="French recommendation summary ${a}" data-fr="Résumé des recommandations ${a} français">French recommendation summary ${a}</label>\n\t\t\t\t\t\t\t\t\t\t\t<div class="quill-editor" id="french-recommendation-summary-${a}-${e}" data-editor-id="french-recommendation-summary-${a}-${e}" data-field="french-recommendation-summary-${a}" data-record-index="${e}"></div>\n\t\t\t\t\t\t\t\t\t\t</div>\n\t\t\t\t\t\t\t\t\t</div>\n\t\t\t\t\t\t\t\t</div>\n\t\t\t\t\t\t\t`:"")).join("")}\n\t\t\t\t\t\t\n\t\t\t\t\t<button class="btn btn-outline-secondary btn-sm" onclick="editor.addRecommendation(${e})" data-en="Add recommendation" data-fr="Ajouter une recommandation">Add recommendation</button>\n\t\t\t\t\t<div id="recommendation-alerts-${e}" class="mt-2"></div>\n\t\t\t\t</div>\n\n\t\t\t\t<div class="update-section form-row mb-3">\n\t\t\t\t\t<div>\n\t\t\t\t\t\t<label for="english-mcc-actions-${e}" class="form-label" data-en="English MCC action titles (one per line)" data-fr="Titres d'action MCC anglais (un par ligne)">English <abbr>MCC</abbr> action titles (one per line)</label>\n\t\t\t\t\t\t<textarea class="form-control" id="english-mcc-actions-${e}" rows="5" \n\t\t\t\t\t\t\tplaceholder="Enter each action title on a new line&#10;Each line will become a bullet point"\n\t\t\t\t\t\t\tonchange="editor.updateMCCActions(${e}, 'english-mcc-actions', this.value)">${this.convertMCCActionsToTextarea(t["english-mcc-actions"])}</textarea>\n\t\t\t\t\t\t<small class="form-text text-muted" data-en="Each line will be displayed as a bullet point" data-fr="Chaque ligne sera affichée comme une puce">Each line will be displayed as a bullet point</small>\n\t\t\t\t\t</div>\n\t\t\t\t\t<div>\n\t\t\t\t\t\t<label for="french-mcc-actions-${e}" class="form-label" data-en="French MCC action titles (one per line)" data-fr="Titres d'action CPM français (un par ligne)">Titre(s) de l'action Commission des pertes massives (<abbr>CPM</abbr>) pertinent(s) (un par ligne)</label>\n\t\t\t\t\t\t<textarea class="form-control" id="french-mcc-actions-${e}" rows="5" \n\t\t\t\t\t\t\tplaceholder="Entrez chaque titre d'action sur une nouvelle ligne&#10;Chaque ligne deviendra une puce"\n\t\t\t\t\t\t\tonchange="editor.updateMCCActions(${e}, 'french-mcc-actions', this.value)">${this.convertMCCActionsToTextarea(t["french-mcc-actions"])}</textarea>\n\t\t\t\t\t\t<small class="form-text text-muted" data-en="Each line will be displayed as a bullet point" data-fr="Chaque ligne sera affichée comme une puce">Chaque ligne sera affichée comme une puce</small>\n\t\t\t\t\t</div>\n\t\t\t\t</div>\n\n <div class="update-section">\n <h3 class="h5" data-en="Progress updates" data-fr="Mises à jour du progrès">Progress updates</h3>\n ${[1,2,3,4,5,6].map((a=>t[`update-${a}-date`]||t[`english-update-${a}`]||t[`french-update-${a}`]?`\n <div class="update-item">\n <div class="d-flex justify-content-between align-items-center mb-3">\n <h4 class="h6 mb-0" data-en="Update ${a}" data-fr="Mise à jour ${a}">Update ${a}</h4>\n <button class="btn btn-outline-danger btn-sm" onclick="editor.deleteUpdate(${e}, ${a})" data-en="Delete" data-fr="Supprimer">Delete</button>\n </div>\n \n <div class="mb-3">\n <label for="update-${a}-date-${e}" class="form-label" data-en="Date" data-fr="Date">Date</label>\n <input type="date" class="form-control" id="update-${a}-date-${e}" value="${t[`update-${a}-date`]||""}"\n onchange="editor.updateRecord(${e}, 'update-${a}-date', this.value)"\n pattern="\\d{4}-\\d{2}-\\d{2}" placeholder="YYYY-MM-DD"\n data-en-lang="en-CA" data-fr-lang="fr-CA">\n </div>\n \n\t\t\t\t\t\t\t\t\t<div class="form-row">\n <div>\n <label for="english-update-${a}-${e}" class="form-label" data-en="English update" data-fr="Mise à jour anglaise">English update</label>\n <div class="quill-editor" id="english-update-${a}-${e}" data-editor-id="english-update-${a}-${e}" data-field="english-update-${a}" data-record-index="${e}"></div>\n </div>\n <div>\n <label for="french-update-${a}-${e}" class="form-label" data-en="French update" data-fr="Mise à jour française">French update</label>\n <div class="quill-editor" id="french-update-${a}-${e}" data-editor-id="french-update-${a}-${e}" data-field="french-update-${a}" data-record-index="${e}"></div>\n </div>\n </div>\n </div>\n `:"")).join("")}\n \n <button class="btn btn-outline-secondary btn-sm" onclick="editor.addUpdate(${e})" data-en="Add update" data-fr="Ajouter une mise à jour">Add update</button>\n\t\t\t<div id="update-alerts-${e}" class="mt-2"></div>\n </div>\n </div>\n </div>\n `)).join("");r.firstChild;)n.appendChild(r.firstChild);t.innerHTML="",t.appendChild(n),this.formatAllDateInputs();const i=this.getCurrentDateFormatted();t.querySelectorAll('input[type="date"]:not([data-initialized])').forEach((t=>{if(!t.value&&t.id.includes("update-")&&t.id.includes("-date-")){const e=t.id.match(/update-(\d+)-date-(\d+)/);if(e){const a=e[1],n=e[2],r=this.data.data[n];r&&r[`update-${a}-date`]===i&&(t.value=i)}}t.setAttribute("data-initialized","true")})),a&&requestAnimationFrame((()=>{const t=document.getElementById(a);t&&"function"==typeof t.focus&&t.focus()})),window.languageSwitcher&&window.languageSwitcher.switchLanguage(window.languageSwitcher.currentLang),this.initializeQuillEditors()}updateMCCActions(t,e,a){if(this.data.data[t])if(a){const n=a.split("\n").map((t=>t.trim())).filter((t=>t.length>0));if(n.length>0){const a=n.map((t=>`<li>${t}</li>`)).join("");this.data.data[t][e]=a}else this.data.data[t][e]=""}else this.data.data[t][e]=""}convertMCCActionsToTextarea(t){return t?t.replace(/<li>/g,"").replace(/<\/li>/g,"\n").trim():""}addUpdate(t){const e=this.data.data[t];if(!e)return;const a=document.getElementById(`update-alerts-${t}`);a&&(a.innerHTML="");for(let a=1;a<=6;a++)if(!e[`update-${a}-date`]&&!e[`english-update-${a}`]&&!e[`french-update-${a}`]){const n=this.getCurrentDateFormatted();e[`update-${a}-date`]=n,e[`english-update-${a}`]="",e[`french-update-${a}`]="",this.render(),setTimeout((()=>{const e=document.getElementById(`update-${a}-date-${t}`);e&&(e.value=n)}),0);const r=window.languageSwitcher&&"fr"===window.languageSwitcher.currentLang?`Mise à jour ${a} ajoutée à l'enregistrement ${t+1} !`:`Update ${a} added to record ${t+1}!`;return void this.showAlert(r)}const n=window.languageSwitcher&&"fr"===window.languageSwitcher.currentLang||"fr"===document.documentElement.lang||"fr-CA"===document.documentElement.getAttribute("lang")?"Nombre maximum de mises à jour (6) atteint pour cet enregistrement.":"Maximum number of updates (6) reached for this record.";this.showUpdateAlert(t,n,"danger")}deleteUpdate(t,e){const a=window.languageSwitcher&&"fr"===window.languageSwitcher.currentLang?`Êtes-vous sûr de vouloir supprimer la mise à jour ${e} ?`:`Are you sure you want to delete update ${e}?`;if(confirm(a)){const a=this.data.data[t];if(a){a[`update-${e}-date`]="",a[`english-update-${e}`]="",a[`french-update-${e}`]="",this.render();const n=window.languageSwitcher&&"fr"===window.languageSwitcher.currentLang?`Mise à jour ${e} supprimée de l'enregistrement ${t+1} !`:`Update ${e} deleted from record ${t+1}!`;this.showAlert(n)}}}deleteRecommendation(t,e){const a=window.languageSwitcher&&"fr"===window.languageSwitcher.currentLang?`Êtes-vous sûr de vouloir supprimer la recommandation ${e} ?`:`Are you sure you want to delete recommendation ${e}?`;if(confirm(a)){const a=this.data.data[t];if(a){a[`recommendations-${e}`]="",a[`english-recommendation-summary-${e}`]="",a[`french-recommendation-summary-${e}`]="",this.render();const n=window.languageSwitcher&&"fr"===window.languageSwitcher.currentLang?`Recommandation ${e} supprimée de l'enregistrement ${t+1} !`:`Recommendation ${e} deleted from record ${t+1}!`;this.showAlert(n)}}}addRecommendation(t){const e=this.data.data[t];if(!e)return;const a=document.getElementById(`recommendation-alerts-${t}`);a&&(a.innerHTML="");for(let a=2;a<=3;a++){if(!(e[`recommendations-${a}`]||e[`english-recommendation-summary-${a}`]||e[`french-recommendation-summary-${a}`])){e[`recommendations-${a}`]=" ",e[`english-recommendation-summary-${a}`]="",e[`french-recommendation-summary-${a}`]="",this.render();const n=window.languageSwitcher&&"fr"===window.languageSwitcher.currentLang?`Recommandation ${a} ajoutée à l'enregistrement ${t+1} !`:`Recommendation ${a} added to record ${t+1}!`;return void this.showAlert(n)}}const n=window.languageSwitcher&&"fr"===window.languageSwitcher.currentLang||"fr"===document.documentElement.lang||"fr-CA"===document.documentElement.getAttribute("lang")?"Nombre maximum de recommandations (3) atteint pour cet enregistrement.":"Maximum number of recommendations (3) reached for this record.";this.showRecommendationAlert(t,n,"danger")}showRecommendationAlert(t,e,a="danger"){const n=document.getElementById(`recommendation-alerts-${t}`);if(!n)return;n.innerHTML="";const r=document.createElement("div");r.className=`alert alert-${a} alert-dismissible fade show`;const i=window.languageSwitcher&&"fr"===window.languageSwitcher.currentLang?"Fermer":"Close";r.innerHTML=`\n\t\t\t${e}\n\t\t\t<button type="button" class="btn-close" data-bs-dismiss="alert" aria-label="${i}"></button>\n\t\t`,n.appendChild(r),setTimeout((()=>{r.parentNode&&r.remove()}),5e3)}updateCalendarLanguage(){const t=document.documentElement.lang||"en-CA";document.querySelectorAll('input[type="date"]').forEach((e=>{e.setAttribute("lang",t),this.formatDateInput(e)}))}formatDateInput(t){t&&(t.setAttribute("pattern","\\d{4}-\\d{2}-\\d{2}"),t.setAttribute("placeholder","YYYY-MM-DD"),t.hasAttribute("data-formatted")||(t.addEventListener("change",(t=>{this.ensureDateFormat(t.target)})),t.setAttribute("data-formatted","true")))}ensureDateFormat(t){if(t.value&&!/^\d{4}-\d{2}-\d{2}$/.test(t.value)){const e=new Date(t.value);if(!isNaN(e.getTime())){const a=e.getFullYear(),n=String(e.getMonth()+1).padStart(2,"0"),r=String(e.getDate()).padStart(2,"0");t.value=`${a}-${n}-${r}`}}}waitForLanguageInitialization(){window.languageSwitcher?this.init():setTimeout((()=>this.waitForLanguageInitialization()),50)}}document.addEventListener("DOMContentLoaded",(function(){window.editor=new RCMPDataEditor}));