const BISOLUX_APP_VERSION="1.2.0",BISOLUX_VERSION_STRING="Version 1.2.0";let cropper=null,originalImageData=null,selectedPreset=null,activePresetButton=null;function initializeImageCropper(){const e=document.getElementById("upload-area"),t=document.getElementById("image-input");if(!e||!t)return;t.addEventListener("change",handleFileSelect),e.addEventListener("dragover",handleDragOver),e.addEventListener("dragleave",handleDragLeave),e.addEventListener("drop",handleDrop),e.addEventListener("click",(()=>t.click()));const o=e.querySelector("button");o&&o.addEventListener("click",(e=>{e.stopPropagation(),t.click()}))}function handleFileSelect(e){const t=e.target.files[0];t&&loadImage(t)}function handleDragOver(e){e.preventDefault(),e.stopPropagation(),e.currentTarget.classList.add("dragover")}function handleDragLeave(e){e.preventDefault(),e.stopPropagation(),e.currentTarget.classList.remove("dragover")}function handleDrop(e){e.preventDefault(),e.stopPropagation(),e.currentTarget.classList.remove("dragover");const t=e.dataTransfer.files;if(t.length>0){const e=t[0];e.type.startsWith("image/")&&loadImage(e)}}function loadImage(e){if(!e.type.match(/^image\/(png|jpe?g)$/i))return void alert("Please select a PNG or JPG image.");if(e.size>10485760)return void alert("File size must be less than 10MB.");const t=new FileReader;t.onload=function(e){const t=e.target.result;originalImageData=t;const o=document.getElementById("cropper-section"),r=document.getElementById("preview-section");o&&(o.style.display="block",o.scrollIntoView({behavior:"smooth"})),r&&(r.style.display="none"),initializeCropper(t)},t.readAsDataURL(e)}function initializeCropper(e){const t=document.getElementById("cropper-image");t&&(cropper&&cropper.destroy(),t.src=e,cropper=new Cropper(t,{aspectRatio:NaN,viewMode:0,dragMode:"move",autoCropArea:.8,restore:!1,guides:!0,center:!0,highlight:!1,cropBoxMovable:!0,cropBoxResizable:!0,toggleDragModeOnDblclick:!1,responsive:!0,checkOrientation:!1,minCropBoxWidth:50,minCropBoxHeight:50,ready:function(){const e=document.getElementById("none-preset");e&&(setActivePresetButton(e),selectedPreset="None")}}))}function setActivePresetButton(e){document.querySelectorAll(".preset-buttons .btn").forEach((e=>e.classList.remove("active"))),e&&(e.classList.add("active"),activePresetButton=e)}function setPresetSize(e,t,o){if(!cropper)return;setActivePresetButton(o),cropper.presetWidth=e,cropper.presetHeight=t,selectedPreset=getPresetName(e,t),cropper.setAspectRatio(e/t);const r=cropper.getContainerData(),n=e/t;let i,a;r.width/r.height>n?(a=Math.min(r.height-40,400),i=a*n):(i=Math.min(r.width-40,600),a=i/n),cropper.setCropBoxData({left:(r.width-i)/2,top:(r.height-a)/2,width:i,height:a})}function setNonePreset(){if(!cropper)return;setActivePresetButton(document.getElementById("none-preset")),cropper.presetWidth=null,cropper.presetHeight=null,selectedPreset="None",cropper.setAspectRatio(NaN)}function getPresetName(e,t){return`${e}x${t}`}function flipHorizontal(){if(!cropper)return;const e=cropper.getImageData().scaleX||1;cropper.scaleX(-e)}function flipVertical(){if(!cropper)return;const e=cropper.getImageData().scaleY||1;cropper.scaleY(-e)}function resetCrop(){if(!cropper)return;cropper.presetWidth=null,cropper.presetHeight=null,selectedPreset=null;document.querySelectorAll(".preset-buttons .btn").forEach((e=>e.classList.remove("active"))),cropper.reset(),setTimeout((()=>{setNonePreset()}),100)}function cropImage(){if(!cropper)return;let e={imageSmoothingEnabled:!0,imageSmoothingQuality:"high",maxWidth:2e3,maxHeight:2e3};cropper.presetWidth&&cropper.presetHeight&&"None"!==selectedPreset&&(e.width=cropper.presetWidth,e.height=cropper.presetHeight);const t=cropper.getCroppedCanvas(e);if(!t)return void alert("Failed to crop image. Please try again.");"None"===selectedPreset&&(selectedPreset=`${t.width}x${t.height}`),displayPreview(t);const o=document.getElementById("preview-section");o&&(o.style.display="block",o.scrollIntoView({behavior:"smooth"}))}function displayPreview(e){const t=document.getElementById("preview-image"),o=document.getElementById("image-dimensions");if(!t)return;const r=e.toDataURL("image/png",.9);if(t.src=r,o){document.documentElement.lang;const t=`Dimensions: ${e.width} Ã— ${e.height} pixels`;o.textContent=t}t.canvas=e}function downloadImage(e){const t=document.getElementById("preview-image"),o=t?.canvas;if(!o)return void alert("No image to download. Please crop an image first.");const r=selectedPreset?`image-${selectedPreset}`:`image-${o.width}x${o.height}`;let n,i,a;if("png"!==e){n="image/jpeg",i=.85,a=`${r}.jpg`;const e=document.createElement("canvas"),t=e.getContext("2d");return e.width=o.width,e.height=o.height,t.fillStyle="#FFFFFF",t.fillRect(0,0,e.width,e.height),t.drawImage(o,0,0),void e.toBlob((function(e){downloadBlob(e,a)}),n,i)}n="image/png",i=1,a=`${r}.png`,o.toBlob((function(e){downloadBlob(e,a)}),n,i)}function downloadBlob(e,t){const o=URL.createObjectURL(e),r=document.createElement("a");r.href=o,r.download=t,document.body.appendChild(r),r.click(),document.body.removeChild(r),URL.revokeObjectURL(o)}function startOver(){const e=document.getElementById("cropper-section"),t=document.getElementById("preview-section");e&&(e.style.display="none"),t&&(t.style.display="none"),cropper&&(cropper.destroy(),cropper=null);const o=document.getElementById("image-input");o&&(o.value=""),originalImageData=null,selectedPreset=null,activePresetButton=null;document.querySelectorAll(".preset-buttons .btn").forEach((e=>e.classList.remove("active"))),window.scrollTo({top:0,behavior:"smooth"})}function zoomIn(){cropper&&cropper.zoom(.1)}function zoomOut(){cropper&&cropper.zoom(-.1)}function resetZoom(){cropper&&cropper.zoomTo(1)}function moveImage(e){if(!cropper)return;switch(e){case"up":cropper.move(0,-10);break;case"down":cropper.move(0,10);break;case"left":cropper.move(-10,0);break;case"right":cropper.move(10,0)}}function moveCropBox(e){if(!cropper)return;const t=cropper.getCropBoxData();switch(e){case"up":cropper.setCropBoxData({left:t.left,top:t.top-10,width:t.width,height:t.height});break;case"down":cropper.setCropBoxData({left:t.left,top:t.top+10,width:t.width,height:t.height});break;case"left":cropper.setCropBoxData({left:t.left-10,top:t.top,width:t.width,height:t.height});break;case"right":cropper.setCropBoxData({left:t.left+10,top:t.top,width:t.width,height:t.height})}}function formatFileSize(e){if(0===e)return"0 Bytes";const t=Math.floor(Math.log(e)/Math.log(1024));return parseFloat((e/Math.pow(1024,t)).toFixed(2))+" "+["Bytes","KB","MB","GB"][t]}document.addEventListener("DOMContentLoaded",(()=>{const e=document.getElementById("version-info");e&&(e.textContent="Version 1.2.0")})),document.addEventListener("DOMContentLoaded",(function(){initializeImageCropper()}));