form.addEventListener('submit', (event) => {
  event.preventDefault();

  const getValue = (selector) =>
    document.querySelector(selector)?.shadowRoot?.querySelector('input')?.value || '';

  const englishTitle = getValue('gcds-input[name="englishTitle"]');
  const frenchTitle = getValue('gcds-input[name="frenchTitle"]');
  const version = getValue('gcds-input[name="version"]');
  const date = getValue('gcds-input[name="date"]');
  const visibilityGroup = document.querySelector('gcds-radio-group[name="visibility"]');
  const visibility = visibilityGroup?.shadowRoot.querySelector('input[type="radio"]:checked')?.value || '';

  // Basic validation for required fields
  if (!englishTitle || !frenchTitle || !version || !date || !visibility) {
    alert('Please complete all required fields before saving.');
    return;
  }

  const data = {
    englishTitle,
    frenchTitle,
    version,
    date,
    visibility,
    items: [],
  };

  itemsContainer.querySelectorAll('.item-pair').forEach(pair => {
    const level = parseInt(pair.dataset.level);
    const en = pair.querySelector('gcds-input[label="Item in English"]')?.shadowRoot.querySelector('input').value || '';
    const fr = pair.querySelector('gcds-input[label="Item in French"]')?.shadowRoot.querySelector('input').value || '';
    const noteEn = pair.querySelector('gcds-input[label="English note"]')?.shadowRoot.querySelector('input')?.value || '';
    const noteFr = pair.querySelector('gcds-input[label="French note"]')?.shadowRoot.querySelector('input')?.value || '';
    data.items.push({ english: en, french: fr, level, noteEnglish: noteEn, noteFrench: noteFr });
  });

  // Clean filename: remove unsafe characters from title
  const cleanTitle = englishTitle.trim().toLowerCase().replace(/[^a-z0-9-_]+/g, '-');
  const cleanVersion = version.trim().replace(/[^a-z0-9.]+/gi, '-');
  const filename = `${cleanTitle}-${cleanVersion}.json`;

  const blob = new Blob([JSON.stringify(data, null, 2)], { type: 'application/json' });
  const url = URL.createObjectURL(blob);
  const link = document.createElement('a');
  link.href = url;
  link.download = filename;
  link.click();
  URL.revokeObjectURL(url);
});
