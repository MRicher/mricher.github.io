<!DOCTYPE html>
<html lang="en" dir="ltr">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Title Form - GC Design System</title>

  <!-- GC Design System CSS -->
  <link rel="stylesheet" href="https://cdn.design-system.alpha.canada.ca/@cdssnc/gcds-utility@1.8.0/dist/gcds-utility.min.css" />
  <link rel="stylesheet" href="https://cdn.design-system.alpha.canada.ca/@cdssnc/gcds-components@0.34.1/dist/gcds/gcds.css" />

  <!-- GC Design System JS -->
  <script type="module" src="https://cdn.design-system.alpha.canada.ca/@cdssnc/gcds-components@0.34.1/dist/gcds/gcds.esm.js"></script>
  <script nomodule src="https://cdn.design-system.alpha.canada.ca/@cdssnc/gcds-components@0.34.1/dist/gcds/gcds.js"></script>

  <style>
    #itemsContainer {
      margin-top: 1rem;
    }
    .item-pair {
      border: 1px solid #ccc;
      margin-bottom: 1rem;
      padding: 1rem;
      border-radius: 0.25rem;
      background: #f9f9f9;
    }
    .item-header {
      display: flex;
      flex-wrap: wrap;
      gap: 0.5rem;
      align-items: center;
    }
    .item-controls {
      display: flex;
      gap: 0.5rem;
      margin-top: 0.5rem;
      flex-wrap: wrap;
    }
    .item-notes {
      margin-top: 0.5rem;
      border-top: 1px solid #ccc;
      padding-top: 0.5rem;
      display: flex;
      gap: 1rem;
      flex-wrap: wrap;
    }
  </style>
</head>

<body>
<gcds-container main-container size="xl" centered tag="main">
  <gcds-heading tag="h1">Form</gcds-heading>

  <form id="titleForm" novalidate>
    <gcds-input label="English Title" name="englishTitle" required></gcds-input>
    <gcds-input label="French Title" name="frenchTitle" required></gcds-input>

    <gcds-radio-group
      name="visibility"
      legend="Visibility"
      required
      options='[
        { "id": "public", "label": "Public", "value": "public", "hint": "Visible to everyone.", "checked": "" },
        { "id": "internal", "label": "Internal", "value": "internal", "hint": "Visible only internally." }
      ]'>
    </gcds-radio-group>

    <gcds-date-input
      legend="Date input"
      name="date"
      format="full"
      required
    ></gcds-date-input>

    <gcds-input label="Version (1.0.0)" name="version" required></gcds-input>

    <h2>Items</h2>
    <div id="itemsContainer"></div>
    <gcds-button type="button" onclick="addItem()">Add Root Item</gcds-button>

    <br /><br />
    <gcds-button type="submit">Save as JSON</gcds-button>
  </form>

  <h2>Load JSON</h2>
  <gcds-file-uploader
    uploader-id="uploader"
    label="Upload JSON File"
    name="file-uploader"
    hint="Select a JSON file to load data from."
  ></gcds-file-uploader>

</gcds-container>

<script>
  const form = document.getElementById('titleForm');
  const uploader = document.querySelector('gcds-file-uploader');
  const itemsContainer = document.getElementById('itemsContainer');

  function createGcdsInput(label, value = '', type = 'text') {
    const input = document.createElement('gcds-input');
    input.setAttribute('label', label);
    if (type !== 'text') input.setAttribute('type', type);
    setTimeout(() => {
      input.shadowRoot.querySelector('input').value = value;
    });
    return input;
  }

  function addItem(en = '', fr = '', level = 0, noteEn = '', noteFr = '') {
    const wrapper = document.createElement('div');
    wrapper.className = 'item-pair';
    wrapper.style.marginLeft = `${level * 30}px`;
    wrapper.dataset.level = level;

    const header = document.createElement('div');
    header.className = 'item-header';
    const enInput = createGcdsInput('Item in English', en);
    const frInput = createGcdsInput('Item in French', fr);
    header.appendChild(enInput);
    header.appendChild(frInput);

    const controls = document.createElement('div');
    controls.className = 'item-controls';

    const addChildBtn = document.createElement('gcds-button');
    addChildBtn.setAttribute('type', 'button');
    addChildBtn.textContent = '+ Child';
    addChildBtn.onclick = () => {
      const idx = [...itemsContainer.children].indexOf(wrapper);
      const newItem = addItem('', '', level + 1);
      itemsContainer.insertBefore(newItem, itemsContainer.children[idx + 1]);
    };

    const toggleNoteBtn = document.createElement('gcds-button');
    toggleNoteBtn.setAttribute('type', 'button');
    toggleNoteBtn.textContent = '+ Note';

    const upBtn = document.createElement('gcds-button');
    upBtn.setAttribute('type', 'button');
    upBtn.textContent = '↑';
    upBtn.onclick = () => {
      const prev = wrapper.previousElementSibling;
      if (prev) itemsContainer.insertBefore(wrapper, prev);
    };

    const downBtn = document.createElement('gcds-button');
    downBtn.setAttribute('type', 'button');
    downBtn.textContent = '↓';
    downBtn.onclick = () => {
      const next = wrapper.nextElementSibling;
      if (next) itemsContainer.insertBefore(next, wrapper);
    };

    const removeBtn = document.createElement('gcds-button');
    removeBtn.setAttribute('type', 'button');
    removeBtn.textContent = 'Remove';
    removeBtn.onclick = () => wrapper.remove();

    controls.append(addChildBtn, toggleNoteBtn, upBtn, downBtn, removeBtn);
    wrapper.append(header, controls);

    let notes = null;
    toggleNoteBtn.onclick = () => {
      if (!notes) {
        notes = document.createElement('div');
        notes.className = 'item-notes';
        const enNote = createGcdsInput('English note', noteEn);
        const frNote = createGcdsInput('French note', noteFr);
        notes.append(enNote, frNote);
        wrapper.appendChild(notes);
        toggleNoteBtn.textContent = 'Remove Note';
      } else {
        notes.remove();
        notes = null;
        toggleNoteBtn.textContent = '+ Note';
      }
    };

    if (noteEn || noteFr) toggleNoteBtn.click();
    itemsContainer.appendChild(wrapper);
    return wrapper;
  }

  // New function to get date value from gcds-date-input (month, day, year)
  function getDateValue() {
    const dateInput = document.querySelector('gcds-date-input[name="date"]');
    if (!dateInput?.shadowRoot) return '';

    // Month
    const monthSelect = dateInput.shadowRoot.querySelector('gcds-select[name="month"]');
    let month = '';
    if (monthSelect?.shadowRoot) {
      const selectEl = monthSelect.shadowRoot.querySelector('select');
      if (selectEl) {
        month = selectEl.value.trim();
      }
    }

    // Day
    const dayInput = dateInput.shadowRoot.querySelector('gcds-input.gcds-date-input__day');
    let day = '';
    if (dayInput?.shadowRoot) {
      const inputEl = dayInput.shadowRoot.querySelector('input');
      if (inputEl) {
        day = inputEl.value.trim();
      }
    }

    // Year
    const yearInput = dateInput.shadowRoot.querySelector('gcds-input.gcds-date-input__year');
    let year = '';
    if (yearInput?.shadowRoot) {
      const inputEl = yearInput.shadowRoot.querySelector('input');
      if (inputEl) {
        year = inputEl.value.trim();
      }
    }

    if (!year || !month || !day) return '';

    const mm = month.padStart(2, '0');
    const dd = day.padStart(2, '0');

    return `${year}-${mm}-${dd}`;
  }

  form.addEventListener('submit', (event) => {
    event.preventDefault();

    const getValue = (selector) =>
      document.querySelector(selector)?.shadowRoot?.querySelector('input')?.value.trim() || '';

    const englishTitle = getValue('gcds-input[name="englishTitle"]');
    const frenchTitle = getValue('gcds-input[name="frenchTitle"]');
    const version = getValue('gcds-input[name="version"]');
    const date = getDateValue();

    const visibilityGroup = document.querySelector('gcds-radio-group[name="visibility"]');
    const visibility = visibilityGroup?.shadowRoot.querySelector('input[type="radio"]:checked')?.value || '';

    // Validation and debugging alerts
    if (!englishTitle) {
      alert('English Title is empty.');
      return;
    }
    if (!frenchTitle) {
      alert('French Title is empty.');
      return;
    }
    if (!version) {
      alert('Version is empty.');
      return;
    }
    if (!date) {
      alert('Date is empty.');
      return;
    }
    if (!visibility) {
      alert('Visibility is not selected.');
      return;
    }

    // Validate version: must be number.number.number
    if (!/^\d+\.\d+\.\d+$/.test(version)) {
      alert('Version must follow the format number.number.number, e.g., 1.0.0');
      return;
    }

    // Validate date: YYYY-MM-DD format
    if (!/^\d{4}-\d{2}-\d{2}$/.test(date)) {
      alert('Date must be in the format yyyy-mm-dd.');
      return;
    }

    const data = {
      englishTitle,
      frenchTitle,
      version,
      date,
      visibility,
      items: []
    };

    itemsContainer.querySelectorAll('.item-pair').forEach(pair => {
      const level = parseInt(pair.dataset.level);
      const en = pair.querySelector('gcds-input[label="Item in English"]')?.shadowRoot.querySelector('input')?.value.trim() || '';
      const fr = pair.querySelector('gcds-input[label="Item in French"]')?.shadowRoot.querySelector('input')?.value.trim() || '';
      const noteEn = pair.querySelector('gcds-input[label="English note"]')?.shadowRoot.querySelector('input')?.value.trim() || '';
      const noteFr = pair.querySelector('gcds-input[label="French note"]')?.shadowRoot.querySelector('input')?.value.trim() || '';
      data.items.push({ english: en, french: fr, level, noteEnglish: noteEn, noteFrench: noteFr });
    });

    const cleanTitle = englishTitle.toLowerCase().replace(/[^a-z0-9-_]+/g, '-');
    const cleanVersion = version.replace(/[^a-z0-9.]+/gi, '-');
    const filename = `${cleanTitle}-${cleanVersion}.json`;

    const blob = new Blob([JSON.stringify(data, null, 2)], { type: 'application/json' });
    const url = URL.createObjectURL(blob);
    const link = document.createElement('a');
    link.href = url;
    link.download = filename;
    link.click();
    URL.revokeObjectURL(url);
  });

  uploader.addEventListener('change', (event) => {
    const files = event.detail?.files;
    if (!files || files.length === 0) return;

    const file = files[0];
    const reader = new FileReader();
    reader.onload = (e) => {
      try {
        const data = JSON.parse(e.target.result);

        const setInput = (selector, value) => {
          const input = document.querySelector(selector);
          if(input?.shadowRoot) {
            input.shadowRoot.querySelector('input').value = value || '';
          }
        };

        setInput('gcds-input[name="englishTitle"]', data.englishTitle);
        setInput('gcds-input[name="frenchTitle"]', data.frenchTitle);
        setInput('gcds-input[name="version"]', data.version);

        // Set date - parse YYYY-MM-DD into gcds-date-input fields
        if (data.date) {
          const dateInput = document.querySelector('gcds-date-input[name="date"]');
          if (dateInput?.shadowRoot) {
            const [year, month, day] = data.date.split('-');
            // Set month select
            const monthSelect = dateInput.shadowRoot.querySelector('gcds-select[name="month"]');
            if (monthSelect?.shadowRoot) {
              const selectEl = monthSelect.shadowRoot.querySelector('select');
              if (selectEl) selectEl.value = month;
            }
            // Set day input
            const dayInput = dateInput.shadowRoot.querySelector('gcds-input.gcds-date-input__day');
            if (dayInput?.shadowRoot) {
              const inputEl = dayInput.shadowRoot.querySelector('input');
              if (inputEl) inputEl.value = day;
            }
            // Set year input
            const yearInput = dateInput.shadowRoot.querySelector('gcds-input.gcds-date-input__year');
            if (yearInput?.shadowRoot) {
              const inputEl = yearInput.shadowRoot.querySelector('input');
              if (inputEl) inputEl.value = year;
            }
          }
        }

        // Set visibility radio
        if (data.visibility) {
          const visibilityGroup = document.querySelector('gcds-radio-group[name="visibility"]');
          if (visibilityGroup?.shadowRoot) {
            const radios = visibilityGroup.shadowRoot.querySelectorAll('input[type="radio"]');
            radios.forEach(radio => {
              radio.checked = radio.value === data.visibility;
            });
          }
        }

        // Clear existing items
        itemsContainer.innerHTML = '';

        if (Array.isArray(data.items)) {
          data.items.forEach(item => {
            addItem(item.english, item.french, item.level || 0, item.noteEnglish, item.noteFrench);
          });
        }
      } catch (error) {
        alert('Error parsing JSON file: ' + error.message);
      }
    };
    reader.readAsText(file);
  });

  // Initialize with one empty item
  addItem();

</script>

</body>
</html>
