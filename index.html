<!DOCTYPE html>
<html dir="ltr" lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Title Form - GC Design System</title>

  <!-- GC Design System Utility CSS -->
  <link
    rel="stylesheet"
    href="https://cdn.design-system.alpha.canada.ca/@cdssnc/gcds-utility@1.8.0/dist/gcds-utility.min.css"
  />

  <!-- GC Design System Components CSS -->
  <link
    rel="stylesheet"
    href="https://cdn.design-system.alpha.canada.ca/@cdssnc/gcds-components@0.34.1/dist/gcds/gcds.css"
  />

  <!-- GC Design System Components JS -->
  <script
    type="module"
    src="https://cdn.design-system.alpha.canada.ca/@cdssnc/gcds-components@0.34.1/dist/gcds/gcds.esm.js"
  ></script>
  <script
    nomodule
    src="https://cdn.design-system.alpha.canada.ca/@cdssnc/gcds-components@0.34.1/dist/gcds/gcds.js"
  ></script>

  <style>
    #itemsContainer {
      margin-top: 1rem;
    }
    .item-pair {
      border: 1px solid #ccc;
      margin-bottom: 1rem;
      padding: 1rem;
      border-radius: 0.25rem;
      background: #f9f9f9;
    }
    .item-header {
      display: flex;
      flex-wrap: wrap;
      gap: 0.5rem;
      align-items: center;
    }
    .item-controls {
      display: flex;
      gap: 0.5rem;
      margin-top: 0.5rem;
      flex-wrap: wrap;
    }
    .item-notes {
      margin-top: 0.5rem;
      border-top: 1px solid #ccc;
      padding-top: 0.5rem;
      display: flex;
      gap: 1rem;
      flex-wrap: wrap;
    }
  </style>
</head>
<body>
  <gcds-container main-container size="xl" centered tag="main">
    <section>
      <gcds-heading tag="h1">Title Form</gcds-heading>
    </section>

    <form id="titleForm">
      <gcds-input label="English Title" name="englishTitle" required></gcds-input>
      <gcds-input label="French Title" name="frenchTitle" required></gcds-input>

    <gcds-radio-group
      name="visibility"
      legend="Visibility"
      options='[
        { "label": "Public", "id": "public", "value": "public", "hint": "Visible to everyone." },
        { "label": "Internal", "id": "internal", "value": "internal", "hint": "Only visible internally." }
      ]'
    ></gcds-radio-group>

      <gcds-input label="Version" name="version" placeholder="1.0.0" required></gcds-input>
      <gcds-input label="Date" name="date" type="date" required></gcds-input>

      <h2>Items</h2>
      <div id="itemsContainer"></div>
      <gcds-button type="button" onclick="addItem()">Add Root Item</gcds-button>

      <br /><br />
      <gcds-button type="submit">Save as JSON</gcds-button>
    </form>

    <h2>Load JSON</h2>
    <input type="file" id="fileInput" accept="application/json" />
  </gcds-container>

  <script>
    const form = document.getElementById('titleForm');
    const fileInput = document.getElementById('fileInput');
    const itemsContainer = document.getElementById('itemsContainer');

    function createGcdsInput(label, value = '', type = 'text') {
      const input = document.createElement('gcds-input');
      input.setAttribute('label', label);
      input.setAttribute('type', type);
      setTimeout(() => {
        const inner = input.shadowRoot.querySelector('input');
        if (inner) inner.value = value;
      });
      return input;
    }

    function addItem(en = '', fr = '', level = 0, noteEn = '', noteFr = '') {
      const wrapper = document.createElement('div');
      wrapper.className = 'item-pair';
      wrapper.style.marginLeft = `${level * 30}px`;
      wrapper.dataset.level = level;

      const header = document.createElement('div');
      header.className = 'item-header';
      const enInput = createGcdsInput('Item in English', en);
      const frInput = createGcdsInput('Item in French', fr);
      header.appendChild(enInput);
      header.appendChild(frInput);

      const controls = document.createElement('div');
      controls.className = 'item-controls';

      const addChildBtn = document.createElement('gcds-button');
      addChildBtn.setAttribute('type', 'button');
      addChildBtn.textContent = '+ Child';
      addChildBtn.onclick = () => {
        const idx = [...itemsContainer.children].indexOf(wrapper);
        const newItem = addItem('', '', level + 1);
        itemsContainer.insertBefore(newItem, itemsContainer.children[idx + 1]);
      };

      const toggleNoteBtn = document.createElement('gcds-button');
      toggleNoteBtn.setAttribute('type', 'button');
      toggleNoteBtn.textContent = '+ Note';

      const upBtn = document.createElement('gcds-button');
      upBtn.setAttribute('type', 'button');
      upBtn.textContent = '↑';
      upBtn.onclick = () => {
        const prev = wrapper.previousElementSibling;
        if (prev) itemsContainer.insertBefore(wrapper, prev);
      };

      const downBtn = document.createElement('gcds-button');
      downBtn.setAttribute('type', 'button');
      downBtn.textContent = '↓';
      downBtn.onclick = () => {
        const next = wrapper.nextElementSibling;
        if (next) itemsContainer.insertBefore(next, wrapper);
      };

      const removeBtn = document.createElement('gcds-button');
      removeBtn.setAttribute('type', 'button');
      removeBtn.textContent = 'Remove';
      removeBtn.onclick = () => wrapper.remove();

      controls.append(addChildBtn, toggleNoteBtn, upBtn, downBtn, removeBtn);
      wrapper.append(header, controls);

      let notes = null;
      toggleNoteBtn.onclick = () => {
        if (!notes) {
          notes = document.createElement('div');
          notes.className = 'item-notes';
          const enNote = createGcdsInput('English note', noteEn);
          const frNote = createGcdsInput('French note', noteFr);
          notes.append(enNote, frNote);
          wrapper.appendChild(notes);
          toggleNoteBtn.textContent = 'Remove Note';
        } else {
          notes.remove();
          notes = null;
          toggleNoteBtn.textContent = '+ Note';
        }
      };

      if (noteEn || noteFr) toggleNoteBtn.click();
      itemsContainer.appendChild(wrapper);
      return wrapper;
    }

    form.addEventListener('submit', (event) => {
      event.preventDefault();

      const getInputValue = (name) => {
        const el = document.querySelector(`gcds-input[name="${name}"]`);
        return el?.shadowRoot.querySelector('input')?.value || '';
      };

      const visibilityGroup = document.querySelector('gcds-radio-group[name="visibility"]');
      const visibility = visibilityGroup?.shadowRoot.querySelector('input[type="radio"]:checked')?.value || 'public';

      const data = {
        englishTitle: getInputValue('englishTitle'),
        frenchTitle: getInputValue('frenchTitle'),
        version: getInputValue('version'),
        date: getInputValue('date'),
        visibility,
        items: []
      };

      itemsContainer.querySelectorAll('.item-pair').forEach(pair => {
        const level = parseInt(pair.dataset.level);
        const en = pair.querySelector('gcds-input[label="Item in English"]')?.shadowRoot.querySelector('input')?.value || '';
        const fr = pair.querySelector('gcds-input[label="Item in French"]')?.shadowRoot.querySelector('input')?.value || '';
        const noteEn = pair.querySelector('gcds-input[label="English note"]')?.shadowRoot.querySelector('input')?.value || '';
        const noteFr = pair.querySelector('gcds-input[label="French note"]')?.shadowRoot.querySelector('input')?.value || '';
        data.items.push({ english: en, french: fr, level, noteEnglish: noteEn, noteFrench: noteFr });
      });

      const blob = new Blob([JSON.stringify(data, null, 2)], { type: 'application/json' });
      const url = URL.createObjectURL(blob);
      const link = document.createElement('a');
      link.href = url;
      link.download = 'titles.json';
      link.click();
      URL.revokeObjectURL(url);
    });

    fileInput.addEventListener('change', (e) => {
      const file = e.target.files[0];
      if (!file) return;
      const reader = new FileReader();
      reader.onload = (e) => {
        try {
          const data = JSON.parse(e.target.result);
          const setInput = (name, value) => {
            const el = document.querySelector(`gcds-input[name="${name}"]`);
            if (el) el.shadowRoot.querySelector('input').value = value || '';
          };
          setInput('englishTitle', data.englishTitle);
          setInput('frenchTitle', data.frenchTitle);
          setInput('version', data.version);
          setInput('date', data.date);
          const visibilityGroup = document.querySelector('gcds-radio-group[name="visibility"]');
            visibilityGroup.shadowRoot.querySelectorAll('input[type="radio"]').forEach(input => {
              input.checked = input.value === data.visibility;
            });

          itemsContainer.innerHTML = '';
          (data.items || []).forEach(item =>
            addItem(item.english, item.french, item.level || 0, item.noteEnglish || '', item.noteFrench || '')
          );
        } catch (err) {
          alert('Invalid JSON file.');
        }
      };
      reader.readAsText(file);
    });
  </script>
</body>
</html>
