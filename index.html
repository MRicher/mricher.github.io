<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <title>Title Form - GC Design System</title>

  <!-- GC Design System Utility CSS -->
  <link
    rel="stylesheet"
    href="https://cdn.design-system.alpha.canada.ca/@cdssnc/gcds-utility@1.8.0/dist/gcds-utility.min.css"
  />

  <!-- GC Design System Components CSS -->
  <link
    rel="stylesheet"
    href="https://cdn.design-system.alpha.canada.ca/@cdssnc/gcds-components@0.34.1/dist/gcds/gcds.css"
  />

  <!-- GC Design System Components JS -->
  <script
    type="module"
    src="https://cdn.design-system.alpha.canada.ca/@cdssnc/gcds-components@0.34.1/dist/gcds/gcds.esm.js"
  ></script>
  <script
    nomodule
    src="https://cdn.design-system.alpha.canada.ca/@cdssnc/gcds-components@0.34.1/dist/gcds/gcds.js"
  ></script>

  <style>
    #itemsContainer {
      margin-top: 1rem;
    }
    .item-pair {
      border: 1px solid #ccc;
      margin-bottom: 1rem;
      padding: 1rem;
      border-radius: 0.25rem;
      background: #f9f9f9;
    }
    .item-header {
      display: flex;
      flex-wrap: wrap;
      gap: 0.5rem;
      align-items: center;
    }
    .item-header gcds-input {
      flex: 1 1 200px;
      min-width: 200px;
    }
    .item-controls {
      display: flex;
      gap: 0.5rem;
      margin-top: 0.5rem;
      flex-wrap: wrap;
    }
    .item-notes {
      margin-top: 0.5rem;
      border-top: 1px solid #ccc;
      padding-top: 0.5rem;
      display: flex;
      gap: 1rem;
      flex-wrap: wrap;
    }
    .item-notes gcds-input {
      flex: 1 1 45%;
      min-width: 200px;
    }
  </style>
</head>
<body>
  <main class="gcds-container gcds-container--max-width">
    <h1>Title Form</h1>
    <form id="titleForm">
      <gcds-input
        label="English Title"
        name="englishTitle"
        required
      ></gcds-input>

      <gcds-input
        label="French Title"
        name="frenchTitle"
        required
      ></gcds-input>

      <gcds-fieldset legend="Visibility">
        <gcds-radio
          label="Public"
          name="visibility"
          value="public"
          checked
        ></gcds-radio>
        <gcds-radio
          label="Internal"
          name="visibility"
          value="internal"
        ></gcds-radio>
      </gcds-fieldset>

      <gcds-input
        label="Version"
        name="version"
        placeholder="e.g., 1.0"
        required
      ></gcds-input>

      <gcds-input
        label="Date"
        name="date"
        type="date"
        required
      ></gcds-input>

      <h2>Items</h2>
      <div id="itemsContainer"></div>
      <gcds-button type="button" onclick="addItem()">
        Add Root Item
      </gcds-button>

      <br /><br />

      <gcds-button type="submit">Save as JSON</gcds-button>
    </form>

    <h2>Load JSON</h2>
    <input type="file" id="fileInput" accept="application/json" />
  </main>

  <script>
    const form = document.getElementById('titleForm');
    const fileInput = document.getElementById('fileInput');
    const itemsContainer = document.getElementById('itemsContainer');

    function createGcdsInput(label, name, value = '', placeholder = '', required = false, type = 'text') {
      const input = document.createElement('gcds-input');
      input.setAttribute('label', label);
      input.setAttribute('name', name);
      if (placeholder) input.setAttribute('placeholder', placeholder);
      if (required) input.setAttribute('required', '');
      if (type !== 'text') input.setAttribute('type', type);
      input.value = value;
      return input;
    }

    function addItem(english = '', french = '', level = 0, enNote = '', frNote = '') {
      const wrapper = document.createElement('div');
      wrapper.className = 'item-pair';
      wrapper.style.marginLeft = `${level * 30}px`;
      wrapper.dataset.level = level;

      const header = document.createElement('div');
      header.className = 'item-header';

      const enInput = createGcdsInput('Item in English', '', english, '', true);
      const frInput = createGcdsInput('Item in French', '', french, '', true);

      header.appendChild(enInput);
      header.appendChild(frInput);

      const controls = document.createElement('div');
      controls.className = 'item-controls';

      const addChildBtn = document.createElement('gcds-button');
      addChildBtn.setAttribute('type', 'button');
      addChildBtn.textContent = '+ Child';
      addChildBtn.addEventListener('click', () => {
        const index = [...itemsContainer.children].indexOf(wrapper);
        const newItem = addItem('', '', level + 1);
        itemsContainer.insertBefore(newItem, itemsContainer.children[index + 1]);
      });

      const toggleNoteBtn = document.createElement('gcds-button');
      toggleNoteBtn.setAttribute('type', 'button');
      toggleNoteBtn.textContent = '+ Note';

      const upBtn = document.createElement('gcds-button');
      upBtn.setAttribute('type', 'button');
      upBtn.textContent = '↑';
      upBtn.addEventListener('click', () => {
        const prev = wrapper.previousElementSibling;
        if (prev) itemsContainer.insertBefore(wrapper, prev);
      });

      const downBtn = document.createElement('gcds-button');
      downBtn.setAttribute('type', 'button');
      downBtn.textContent = '↓';
      downBtn.addEventListener('click', () => {
        const next = wrapper.nextElementSibling;
        if (next) itemsContainer.insertBefore(next, wrapper);
      });

      const removeBtn = document.createElement('gcds-button');
      removeBtn.setAttribute('type', 'button');
      removeBtn.textContent = 'Remove';
      removeBtn.addEventListener('click', () => wrapper.remove());

      controls.appendChild(addChildBtn);
      controls.appendChild(toggleNoteBtn);
      controls.appendChild(upBtn);
      controls.appendChild(downBtn);
      controls.appendChild(removeBtn);

      wrapper.appendChild(header);
      wrapper.appendChild(controls);

      let notes = null;

      toggleNoteBtn.addEventListener('click', () => {
        if (!notes) {
          notes = document.createElement('div');
          notes.className = 'item-notes';

          const enNoteInput = createGcdsInput('English note', '', enNote, '', false);
          const frNoteInput = createGcdsInput('French note', '', frNote, '', false);

          notes.appendChild(enNoteInput);
          notes.appendChild(frNoteInput);
          wrapper.appendChild(notes);

          toggleNoteBtn.textContent = 'Remove Note';
        } else {
          notes.remove();
          notes = null;
          toggleNoteBtn.textContent = '+ Note';
        }
      });

      // If there are notes pre-filled, show notes on load
      if (enNote || frNote) {
        toggleNoteBtn.click();
      }

      itemsContainer.appendChild(wrapper);

      return wrapper;
    }

    form.addEventListener('submit', (event) => {
      event.preventDefault();

      const englishTitle = document.querySelector('gcds-input[name="englishTitle"]').value;
      const frenchTitle = document.querySelector('gcds-input[name="frenchTitle"]').value;
      const version = document.querySelector('gcds-input[name="version"]').value;
      const date = document.querySelector('gcds-input[name="date"]').value;
      const visibility = document.querySelector('gcds-radio[name="visibility"]:checked').value;

      const items = [];
      itemsContainer.querySelectorAll('.item-pair').forEach(pair => {
        const level = parseInt(pair.dataset.level);
        const enInput = pair.querySelector('gcds-input[label="Item in English"]');
        const frInput = pair.querySelector('gcds-input[label="Item in French"]');
        const enNoteInput = pair.querySelector('gcds-input[label="English note"]');
        const frNoteInput = pair.querySelector('gcds-input[label="French note"]');

        items.push({
          english: enInput ? enInput.value : '',
          french: frInput ? frInput.value : '',
          level,
          noteEnglish: enNoteInput ? enNoteInput.value : '',
          noteFrench: frNoteInput ? frNoteInput.value : ''
        });
      });

      const data = {
        englishTitle,
        frenchTitle,
        visibility,
        version,
        date,
        items
      };

      const blob = new Blob([JSON.stringify(data, null, 2)], { type: 'application/json' });
      const url = URL.createObjectURL(blob);

      const link = document.createElement('a');
      link.href = url;
      link.download = 'titles.json';
      link.click();

      URL.revokeObjectURL(url);
    });

    fileInput.addEventListener('change', (event) => {
      const file = event.target.files[0];
      if (!file) return;

      const reader = new FileReader();
      reader.onload = (e) => {
        try {
          const data = JSON.parse(e.target.result);
          document.querySelector('gcds-input[name="englishTitle"]').value = data.englishTitle || '';
          document.querySelector('gcds-input[name="frenchTitle"]').value = data.frenchTitle || '';
          document.querySelector('gcds-input[name="version"]').value = data.version || '';
          document.querySelector('gcds-input[name="date"]').value = data.date || '';
          if (data.visibility === 'internal') {
            document.getElementById('internal').checked = true;
          } else {
            document.getElementById('public').checked = true;
          }

          itemsContainer.innerHTML = '';
          if (Array.isArray(data.items)) {
            data.items.forEach(item =>
              addItem(item.english, item.french, item.level || 0, item.noteEnglish || '', item.noteFrench || '')
            );
          }
        } catch (err) {
          alert('Invalid JSON file.');
        }
      };
      reader.readAsText(file);
    });

    // Start with one root item on page load
    addItem();
  </script>
</body>
</html>
