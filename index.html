<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <title>GC Styled Title Form</title>

  <!-- GC Design System -->
  <link rel="stylesheet" href="https://cdn.design-system.alpha.canada.ca/@cdssnc/gcds-components@latest/dist/gcds/gcds.css" />
  <script type="module" src="https://cdn.design-system.alpha.canada.ca/@cdssnc/gcds-components@latest/dist/gcds/gcds.esm.js"></script>
  <script nomodule src="https://cdn.design-system.alpha.canada.ca/@cdssnc/gcds-components@latest/dist/gcds/gcds.js"></script>

  <style>
    .item-wrapper {
      margin-bottom: 1rem;
      border: 1px solid #ccc;
      padding: 1rem;
      margin-left: var(--level-indent, 0);
    }

    .item-notes {
      margin-top: 0.5rem;
    }

    .task-actions {
      display: flex;
      gap: 0.5rem;
      margin-top: 0.5rem;
    }

    .form-section {
      margin-bottom: 2rem;
    }
  </style>
</head>
<body>
  <main>
    <gcds-heading tag="h1" text="Title Form (GC Design System)" level="1"></gcds-heading>

    <form id="titleForm">
      <div class="form-section">
        <gcds-input label="English Title" name="englishTitle" required></gcds-input>
        <gcds-input label="French Title" name="frenchTitle" required></gcds-input>

        <gcds-fieldset legend="Visibility">
          <gcds-radio label="Public" name="visibility" value="public" checked></gcds-radio>
          <gcds-radio label="Internal" name="visibility" value="internal"></gcds-radio>
        </gcds-fieldset>

        <gcds-input label="Version" name="version" required></gcds-input>
        <gcds-date label="Date" name="date" required></gcds-date>
      </div>

      <gcds-heading tag="h3" text="Items" level="3"></gcds-heading>
      <div id="itemsContainer"></div>

      <gcds-button type="button" onClick="addItem()">Add Root Item</gcds-button>

      <div style="margin-top: 2rem;">
        <gcds-button type="submit">Save as JSON</gcds-button>
      </div>
    </form>

    <gcds-heading tag="h2" text="Load JSON" level="2"></gcds-heading>
    <input type="file" id="fileInput" accept="application/json">
  </main>

  <script>
    const form = document.getElementById('titleForm');
    const itemsContainer = document.getElementById('itemsContainer');
    const fileInput = document.getElementById('fileInput');

    function addItem(english = '', french = '', level = 0, enNote = '', frNote = '') {
      const wrapper = document.createElement('div');
      wrapper.className = 'item-wrapper';
      wrapper.style.setProperty('--level-indent', `${level * 2}rem`);
      wrapper.dataset.level = level;

      wrapper.innerHTML = `
        <gcds-input label="Item in English" value="${english}"></gcds-input>
        <gcds-input label="Item in French" value="${french}"></gcds-input>
        <div class="task-actions">
          <gcds-button type="button" onclick="addChild(this)">+ Child</gcds-button>
          <gcds-button type="button" onclick="toggleNotes(this)">+ Note</gcds-button>
          <gcds-button type="button" onclick="moveUp(this)">↑</gcds-button>
          <gcds-button type="button" onclick="moveDown(this)">↓</gcds-button>
          <gcds-button type="button" onclick="removeItem(this)">Remove</gcds-button>
        </div>
      `;

      itemsContainer.appendChild(wrapper);

      if (enNote || frNote) {
        const notes = document.createElement('div');
        notes.className = 'item-notes';
        notes.innerHTML = `
          <gcds-input label="English note" value="${enNote}"></gcds-input>
          <gcds-input label="French note" value="${frNote}"></gcds-input>
        `;
        wrapper.appendChild(notes);
      }
    }

    function addChild(button) {
      const parent = button.closest('.item-wrapper');
      const level = parseInt(parent.dataset.level) + 1;
      const newItem = addItem('', '', level);
      itemsContainer.insertBefore(newItem, parent.nextSibling);
    }

    function toggleNotes(button) {
      const wrapper = button.closest('.item-wrapper');
      const existing = wrapper.querySelector('.item-notes');
      if (existing) {
        existing.remove();
        button.textContent = '+ Note';
      } else {
        const notes = document.createElement('div');
        notes.className = 'item-notes';
        notes.innerHTML = `
          <gcds-input label="English note"></gcds-input>
          <gcds-input label="French note"></gcds-input>
        `;
        wrapper.appendChild(notes);
        button.textContent = 'Remove Note';
      }
    }

    function moveUp(button) {
      const wrapper = button.closest('.item-wrapper');
      const prev = wrapper.previousElementSibling;
      if (prev) itemsContainer.insertBefore(wrapper, prev);
    }

    function moveDown(button) {
      const wrapper = button.closest('.item-wrapper');
      const next = wrapper.nextElementSibling;
      if (next) itemsContainer.insertBefore(next, wrapper);
    }

    function removeItem(button) {
      const wrapper = button.closest('.item-wrapper');
      wrapper.remove();
    }

    form.addEventListener('submit', function (event) {
      event.preventDefault();
      const data = {
        englishTitle: form.querySelector('gcds-input[name="englishTitle"]').value,
        frenchTitle: form.querySelector('gcds-input[name="frenchTitle"]').value,
        visibility: form.querySelector('gcds-radio[name="visibility"]:checked')?.value || 'public',
        version: form.querySelector('gcds-input[name="version"]').value,
        date: form.querySelector('gcds-date[name="date"]').value,
        items: []
      };

      itemsContainer.querySelectorAll('.item-wrapper').forEach(wrapper => {
        const item = {
          english: wrapper.querySelector('gcds-input[label="Item in English"]').value,
          french: wrapper.querySelector('gcds-input[label="Item in French"]').value,
          level: parseInt(wrapper.dataset.level),
          noteEnglish: wrapper.querySelector('gcds-input[label="English note"]')?.value || '',
          noteFrench: wrapper.querySelector('gcds-input[label="French note"]')?.value || ''
        };
        data.items.push(item);
      });

      const blob = new Blob([JSON.stringify(data, null, 2)], { type: 'application/json' });
      const url = URL.createObjectURL(blob);
      const link = document.createElement('a');
      link.href = url;
      link.download = 'titles.json';
      link.click();
      URL.revokeObjectURL(url);
    });

    fileInput.addEventListener('change', function (event) {
      const file = event.target.files[0];
      if (!file) return;

      const reader = new FileReader();
      reader.onload = function (e) {
        try {
          const data = JSON.parse(e.target.result);
          form.querySelector('gcds-input[name="englishTitle"]').value = data.englishTitle || '';
          form.querySelector('gcds-input[name="frenchTitle"]').value = data.frenchTitle || '';
          form.querySelector('gcds-input[name="version"]').value = data.version || '';
          form.querySelector('gcds-date[name="date"]').value = data.date || '';

          form.querySelector(`gcds-radio[name="visibility"][value="${data.visibility || 'public'}"]`).checked = true;

          itemsContainer.innerHTML = '';
          (data.items || []).forEach(item => {
            addItem(item.english, item.french, item.level || 0, item.noteEnglish || '', item.noteFrench || '');
          });
        } catch (err) {
          alert('Invalid JSON file.');
        }
      };
      reader.readAsText(file);
    });

    // Initial root item
    addItem();
  </script>
</body>
</html>
