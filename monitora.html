<!DOCTYPE html>
<html lang="en-CA">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title data-en="Monitora" data-fr="Monitora">Monitora</title>
    <meta name="description"
          content="This application edits and generates the HTML for the system health page on the Infoweb."
          data-en="This application edits and generates the HTML for the system health page on the Infoweb."
          data-fr="Cette application modifie et génère le code HTML pour la page de l'état des systèmes sur l'Infoweb.">
    <link rel="stylesheet" href="css/bootstrap.min.css">
    <link rel="stylesheet" href="css/creavia.css">
    <link rel="stylesheet" href="css/quill.snow.css">
    <style>
        .custom-message-section {
            display: none;
            margin-top: 1rem;
            padding: 1rem;
            background-color: var(--hero-bg);
            border: 1px solid var(--border-color);
            border-radius: 0.375rem;
            transition: all 0.3s ease;
        }
        
        .custom-message-section.show {
            display: block;
        }

        .ql-container {
            background-color: var(--card-bg);
            color: var(--card-text);
            border-color: var(--border-color) !important;
        }

        .ql-editor {
            color: var(--card-text);
            min-height: 150px;
        }

        .ql-editor.ql-blank::before {
            color: var(--card-text);
            opacity: 0.6;
        }

        .ql-toolbar {
            background-color: var(--card-bg);
            border-color: var(--border-color) !important;
        }

        fieldset {
            border: none;
            padding: 0;
            margin: 0;
        }

        legend.bilingual-label {
            font-size: 1rem;
            font-weight: 500;
            margin-bottom: 0.5rem;
            padding: 0;
        }

        .form-check {
            margin-bottom: 0.5rem;
        }

        .form-check-input {
            margin-top: 0.25rem;
        }

        .form-check-label {
            margin-left: 0.25rem;
            cursor: pointer;
        }

        .status-entry {
            margin-bottom: 2rem;
            padding-bottom: 2rem;
            border-bottom: 2px solid var(--border-color);
        }

        .status-entry:last-child {
            border-bottom: none;
        }

        .form-group {
            margin-bottom: 1.5rem;
        }

        .action-buttons {
            margin-top: 2rem;
            display: flex;
            gap: 1rem;
            flex-wrap: wrap;
        }

        .remove-entry-btn {
            margin-top: 1rem;
        }

		.alert-message-section {
			margin-top: 2rem;
			padding: 1.5rem;
			background-color: var(--hero-bg);
			border: 2px solid var(--border-color);
			border-radius: 0.375rem;
		}

		.alert-preview {
			margin-top: 1rem;
			padding: 1rem;
			border-radius: 0.375rem;
		}
    </style>
</head>

<body>
    <a class="skip-link"
       href="#main-content"
       data-en="Skip to main content"
       data-fr="Passer au contenu principal">
        Skip to main content
    </a>

    <header>
        <nav class="navbar navbar-expand-lg" aria-label="Main navigation">
            <div class="container">
                <div class="navbar-brand d-flex align-items-center">
                    <img src="img/tree.svg"
                         alt=""
                         class="me-2"
                         style="height: 50px; width: auto;">
                    <span data-en="Monitora" data-fr="Monitora">Monitora</span>
                </div>

                <button class="navbar-toggler"
                        type="button"
                        data-bs-toggle="collapse"
                        data-bs-target="#navbarNav"
                        aria-controls="navbarNav"
                        aria-expanded="false"
                        aria-label="Toggle navigation menu">
                    <span class="navbar-toggler-icon"></span>
                    <span class="sr-only"
                          data-en="Toggle navigation menu"
                          data-fr="Basculer le menu de navigation">
                        Toggle navigation menu
                    </span>
                </button>

                <div class="collapse navbar-collapse" id="navbarNav">
                    <ul class="navbar-nav me-auto mb-2 mb-lg-0" role="menubar">
                        <li class="nav-item" role="none">
                            <a class="nav-link"
                               href="index.html"
                               role="menuitem"
                               data-en="Home"
                               data-fr="Accueil">
                                Home
                            </a>
                        </li>
                    </ul>

                    <div class="language-switcher" role="group" aria-label="Settings">
                        <button id="theme-toggle"
                                type="button"
                                class="theme-toggle"
                                aria-label="Toggle dark/light theme"
                                data-en-dark="Switch to light mode"
                                data-en-light="Switch to dark mode"
                                data-fr-dark="Passer au mode clair"
                                data-fr-light="Passer au mode sombre">
                            <span id="theme-text"
                                  data-en="Dark mode"
                                  data-fr="Mode sombre">
                                Dark mode
                            </span>
                        </button>

                        <button id="lang-fr-btn"
                                type="button"
                                class="btn btn-outline-primary btn-sm"
                                data-lang="fr-CA"
                                aria-label="Passer au français"
                                aria-pressed="false"
                                style="display: none;">
                            <span data-en="Français" data-fr="Français">Français</span>
                        </button>

                        <button id="lang-en-btn"
                                type="button"
                                class="btn btn-outline-primary btn-sm"
                                data-lang="en-CA"
                                aria-label="Switch to English"
                                aria-pressed="false">
                            <span data-en="English" data-fr="English">English</span>
                        </button>
                    </div>
                </div>
            </div>
        </nav>
    </header>

    <main class="container" id="main-content">
        <section aria-labelledby="main-heading">
            <h1 id="main-heading"
                data-en="Application status update"
                data-fr="Mise à jour du statut des applications">
                Application status update
            </h1>
            
            <p class="lead" 
               data-en="Update operational status messages for applications and export to bilingual SHTM files." 
               data-fr="Mettez à jour les messages d'état opérationnel des applications et exportez vers des fichiers SHTM bilingues.">
                Update operational status messages for applications and export to bilingual SHTM files.
            </p>
        </section>

        <!-- Main Form -->
        <form id="statusForm" novalidate>
            <div id="statusEntriesContainer">
                <!-- Status Entry 1 (Template) -->
                <div class="status-entry" data-entry-id="1">
                    <h2 class="h4">
                        <span data-en="Status entry" data-fr="Entrée de statut">Status entry</span> #<span class="entry-number">1</span>
                    </h2>
                    
                    <!-- Application Selection -->
                    <div class="form-group">
                        <fieldset>
                            <legend class="bilingual-label">
                                <span data-en="Application" data-fr="Application">Application</span>
                                <span class="text-danger" aria-label="required">*</span>
                                <small id="application-help-1" class="form-text text-muted d-block" data-en="Choose the application to update." data-fr="Choisissez l'application à mettre à jour.">Choose the application to update.</small>
                            </legend>
                            <div class="form-check">
                                <input class="form-check-input application-radio" type="radio" name="application-1" id="application-outlook-1" value="outlook" required aria-describedby="application-help-1">
                                <label class="form-check-label" for="application-outlook-1">
                                    Microsoft Outlook
                                </label>
                            </div>
                            <div class="form-check">
                                <input class="form-check-input application-radio" type="radio" name="application-1" id="application-m365-1" value="m365" required aria-describedby="application-help-1">
                                <label class="form-check-label" for="application-m365-1">
                                    Microsoft 365 (M365)
                                </label>
                            </div>
                        </fieldset>
                    </div>

                    <!-- Current Status -->
                    <div class="form-group">
                        <fieldset>
                            <legend class="bilingual-label">
                                <span data-en="Current status" data-fr="Statut actuel">Current status</span>
                                <span class="text-danger" aria-label="required">*</span>
                                <small id="status-help-1" class="form-text text-muted d-block" data-en="Select the current operational status." data-fr="Sélectionnez le statut opérationnel actuel.">Select the current operational status.</small>
                            </legend>
                            <div class="form-check">
                                <input class="form-check-input status-radio" type="radio" name="status-1" id="status-no-issues-1" value="no-issues" required aria-describedby="status-help-1">
                                <label class="form-check-label" for="status-no-issues-1">
                                    <span data-en="No reported issues" data-fr="Aucun problème signalé">No reported issues</span>
                                </label>
                            </div>
                            <div class="form-check">
                                <input class="form-check-input status-radio" type="radio" name="status-1" id="status-incident-1" value="incident" required aria-describedby="status-help-1">
                                <label class="form-check-label" for="status-incident-1">
                                    <span data-en="Incident" data-fr="Incident">Incident</span>
                                </label>
                            </div>
                            <div class="form-check">
                                <input class="form-check-input status-radio" type="radio" name="status-1" id="status-outage-1" value="outage" required aria-describedby="status-help-1">
                                <label class="form-check-label" for="status-outage-1">
                                    <span data-en="Outage" data-fr="Panne">Outage</span>
                                </label>
                            </div>
                        </fieldset>
                    </div>
                    
                    <!-- Pre-determined Messages -->
                    <div class="form-group">
                        <label class="bilingual-label" for="message-1">
                            <span data-en="Status message" data-fr="Message de statut">Status message</span>
                            <span class="text-danger" aria-label="required">*</span>
                            <small id="message-help-1" class="form-text text-muted d-block" data-en="Choose a pre-defined message or select 'Other' to write your own." data-fr="Choisissez un message prédéfini ou sélectionnez « Autre » pour écrire le vôtre.">Choose a pre-defined message or select "Other" to write your own.</small>
                        </label>
                        <select class="form-control message-select" id="message-1" name="message-1" required aria-required="true" aria-describedby="message-help-1">
                            <option value="" data-en="Select a message" data-fr="Sélectionnez un message">Select a message</option>
                            <option value="other" data-en="Other" data-fr="Autre">Other</option>
                        </select>
                    </div>
                    
                    <!-- Custom Message Section (Hidden by default) -->
                    <div class="custom-message-section" id="custom-message-1" role="region" aria-labelledby="custom-message-heading-1">
                        <h3 class="h5" id="custom-message-heading-1" data-en="Custom message" data-fr="Message personnalisé">Custom message</h3>
                        
                        <div class="form-group">
                            <label class="bilingual-label" for="custom-en-1">
                                <span data-en="English message" data-fr="Message en anglais">English message</span>
                                <small id="custom-en-help-1" class="form-text text-muted d-block" data-en="Enter your custom message in English." data-fr="Entrez votre message personnalisé en anglais.">Enter your custom message in English.</small>
                            </label>
                            <div id="custom-en-editor-1" class="custom-message-en" style="min-height: 150px;"></div>
                            <input type="hidden" id="custom-en-1" name="custom-en-1">
                        </div>
                        
                        <div class="form-group">
                            <label class="bilingual-label" for="custom-fr-1">
                                <span data-en="French message" data-fr="Message en français">French message</span>
                                <small id="custom-fr-help-1" class="form-text text-muted d-block" data-en="Enter your custom message in French." data-fr="Entrez votre message personnalisé en français.">Enter your custom message in French.</small>
                            </label>
                            <div id="custom-fr-editor-1" class="custom-message-fr" style="min-height: 150px;"></div>
                            <input type="hidden" id="custom-fr-1" name="custom-fr-1">
                        </div>
                    </div>
                </div>
            </div>
            
            <!-- Action Buttons -->
            <div class="action-buttons" role="group" aria-label="Form actions">
                <button type="button" class="btn btn-secondary" id="addEntryBtn" data-en="Add another status entry" data-fr="Ajouter une autre entrée de statut">Add another status entry</button>
                
                <button type="submit" class="btn btn-success" data-en="Generate SHTM file" data-fr="Générer le fichier SHTM">Generate SHTM file</button>
                
                <button type="reset" class="btn btn-outline-secondary" data-en="Reset form" data-fr="Réinitialiser le formulaire">Reset form</button>
            </div>
        </form>

		<section class="alert-message-section" aria-labelledby="alert-message-heading">
			<h2 id="alert-message-heading" data-en="Alert message (Optional)" data-fr="Message d'alerte (Optionnel)">Alert message (Optional)</h2>
			
			<p class="lead" data-en="Create a site-wide alert banner to notify users of important information." data-fr="Créez une bannière d'alerte à l'échelle du site pour informer les utilisateurs d'informations importantes.">
				Create a site-wide alert banner to notify users of important information.
			</p>

			<form id="alertForm" novalidate>
				<div class="form-group">
					<label class="bilingual-label" for="alert-type">
						<span data-en="Alert type" data-fr="Type d'alerte">Alert type</span>
						<small id="alert-type-help" class="form-text text-muted d-block" data-en="Select the severity level of the alert." data-fr="Sélectionnez le niveau de gravité de l'alerte.">Select the severity level of the alert.</small>
					</label>
					<select class="form-control" id="alert-type" name="alert-type" aria-describedby="alert-type-help">
						<option value="" data-en="Select alert type" data-fr="Sélectionnez le type d'alerte">Select alert type</option>
						<option value="warning" data-en="Warning (Yellow)" data-fr="Avertissement (Jaune)">Warning (Yellow)</option>
						<option value="danger" data-en="Danger (Red)" data-fr="Danger (Rouge)">Danger (Red)</option>
					</select>
				</div>

				<div class="form-group">
					<label class="bilingual-label" for="alert-en">
						<span data-en="English alert message" data-fr="Message d'alerte en anglais">English alert message</span>
						<small id="alert-en-help" class="form-text text-muted d-block" data-en="Enter the alert message in English." data-fr="Entrez le message d'alerte en anglais.">Enter the alert message in English.</small>
					</label>
					<div id="alert-en-editor" style="min-height: 150px;"></div>
					<input type="hidden" id="alert-en" name="alert-en">
				</div>

				<div class="form-group">
					<label class="bilingual-label" for="alert-fr">
						<span data-en="French alert message" data-fr="Message d'alerte en français">French alert message</span>
						<small id="alert-fr-help" class="form-text text-muted d-block" data-en="Enter the alert message in French." data-fr="Entrez le message d'alerte en français.">Enter the alert message in French.</small>
					</label>
					<div id="alert-fr-editor" style="min-height: 150px;"></div>
					<input type="hidden" id="alert-fr" name="alert-fr">
				</div>

				<div id="alert-preview-container" style="display: none;">
					<h3 class="h5" data-en="Preview" data-fr="Aperçu">Preview</h3>
					<div id="alert-preview-en" class="alert alert-preview" role="alert"></div>
					<div id="alert-preview-fr" class="alert alert-preview" role="alert"></div>
				</div>

				<div class="action-buttons" role="group" aria-label="Alert form actions">
					<button type="submit" class="btn btn-success" data-en="Generate alert SHTM file" data-fr="Générer le fichier SHTM d'alerte">Generate alert SHTM file</button>
					<button type="reset" class="btn btn-outline-secondary" data-en="Clear alert" data-fr="Effacer l'alerte">Clear alert</button>
				</div>
			</form>
		</section>

        <!-- Success/Error Messages -->
        <div id="alertContainer" class="mt-3" role="alert" aria-live="polite" aria-atomic="true"></div>
    </main>

    <footer class="mt-auto">
        <div class="container">
            <div class="text-center">
                <p id="version-info" class="mb-0" data-en="" data-fr=""></p>
            </div>
        </div>
    </footer>

    <script src="js/bootstrap.bundle.min.js"></script>
    <script src="js/creavia.js"></script>
    <script src="js/quill.js"></script>
    <script>
        // [All the existing JavaScript code remains the same]
        // Pre-determined messages for each application
        const messageTemplates = {
            outlook: {
                'no-issues': [
                    { value: 'msg1', en: 'All Outlook services are operating normally.', fr: 'Tous les services Outlook fonctionnent normalement.' },
                    { value: 'msg2', en: 'No current issues affecting Outlook.', fr: 'Aucun problème actuel n\'affecte Outlook.' }
                ],
                'incident': [
                    { value: 'msg3', en: 'We are investigating reports of Outlook connectivity issues.', fr: 'Nous enquêtons sur des rapports de problèmes de connectivité Outlook.' },
                    { value: 'msg4', en: 'Some users may experience delayed email delivery.', fr: 'Certains utilisateurs peuvent rencontrer des retards de livraison de courriels.' }
                ],
                'outage': [
                    { value: 'msg5', en: 'Outlook services are currently unavailable. We are working to restore access.', fr: 'Les services Outlook sont actuellement indisponibles. Nous travaillons à rétablir l\'accès.' },
                    { value: 'msg6', en: 'Major outage affecting all Outlook users. Estimated restoration time: 2 hours.', fr: 'Panne majeure affectant tous les utilisateurs Outlook. Temps de rétablissement estimé : 2 heures.' }
                ]
            },
            m365: {
                'no-issues': [
                    { value: 'msg7', en: 'All Microsoft 365 services are running smoothly.', fr: 'Tous les services Microsoft 365 fonctionnent correctement.' },
                    { value: 'msg8', en: 'No disruptions to M365 services at this time.', fr: 'Aucune interruption des services M365 pour le moment.' }
                ],
                'incident': [
                    { value: 'msg9', en: 'We are aware of performance issues affecting some M365 applications.', fr: 'Nous sommes conscients de problèmes de performance affectant certaines applications M365.' },
                    { value: 'msg10', en: 'Teams and SharePoint may be experiencing intermittent connectivity.', fr: 'Teams et SharePoint peuvent rencontrer une connectivité intermittente.' }
                ],
                'outage': [
                    { value: 'msg11', en: 'Microsoft 365 services are experiencing a complete outage. Updates to follow.', fr: 'Les services Microsoft 365 subissent une panne complète. Mises à jour à suivre.' },
                    { value: 'msg12', en: 'Critical outage impacting all M365 services. Our team is working on resolution.', fr: 'Panne critique affectant tous les services M365. Notre équipe travaille à la résolution.' }
                ]
            }
        };
        
        let entryCounter = 1;
        
        // Store Quill instances
        const quillInstances = {};

        document.addEventListener('DOMContentLoaded', function() {
			setupEventListeners();
			updateMessageOptions(1);
			initializeQuillEditor(1);
			initializeAlertQuillEditors();
			setupAlertEventListeners();
		});

        const Block = Quill.import('blots/block');
        Block.tagName = 'p';
        Quill.register(Block, true);

		const Bold = Quill.import('formats/bold');
		Bold.tagName = 'strong';
		Quill.register(Bold, true);

        // Initialize Quill editor for a specific entry
		function initializeQuillEditor(entryId) {
			const quillEnEditor = new Quill(`#custom-en-editor-${entryId}`, {
				theme: 'snow',
				modules: {
					toolbar: [
						['bold'],
						[{ 'list': 'ordered'}, { 'list': 'bullet' }],
						['link'],
						['clean']
					]
				},
				placeholder: 'Enter your custom message in English...'
			});

			const quillFrEditor = new Quill(`#custom-fr-editor-${entryId}`, {
				theme: 'snow',
				modules: {
					toolbar: [
						['bold'],
						[{ 'list': 'ordered'}, { 'list': 'bullet' }],
						['link'],
						['clean']
					]
				},
				placeholder: 'Entrez votre message personnalisé en français...'
			});
			
			quillInstances[`en-${entryId}`] = quillEnEditor;
			quillInstances[`fr-${entryId}`] = quillFrEditor;
			
			quillEnEditor.on('text-change', function() {
				document.getElementById(`custom-en-${entryId}`).value = quillEnEditor.root.innerHTML;
			});
			
			quillFrEditor.on('text-change', function() {
				document.getElementById(`custom-fr-${entryId}`).value = quillFrEditor.root.innerHTML;
			});
		}

		// Initialize Quill editors for alert messages
		function initializeAlertQuillEditors() {
			// Register custom alert link format
			Quill.register(AlertLink, true);
			
			const alertEnEditor = new Quill('#alert-en-editor', {
				theme: 'snow',
				modules: {
					toolbar: [
						['bold'],
						[{ 'list': 'ordered'}, { 'list': 'bullet' }],
						['link'],
						['clean']
					]
				},
				placeholder: 'Enter your alert message in English...'
			});

			const alertFrEditor = new Quill('#alert-fr-editor', {
				theme: 'snow',
				modules: {
					toolbar: [
						['bold'],
						[{ 'list': 'ordered'}, { 'list': 'bullet' }],
						['link'],
						['clean']
					]
				},
				placeholder: 'Entrez votre message d\'alerte en français...'
			});
			
			// Set default content with headers
			alertEnEditor.root.innerHTML = '<h2>Note</h2><p><br></p>';
			alertFrEditor.root.innerHTML = '<h2>Remarque</h2><p><br></p>';
			
			// Initialize hidden input values
			document.getElementById('alert-en').value = alertEnEditor.root.innerHTML;
			document.getElementById('alert-fr').value = alertFrEditor.root.innerHTML;
			
			quillInstances['alert-en'] = alertEnEditor;
			quillInstances['alert-fr'] = alertFrEditor;
			
			alertEnEditor.on('text-change', function() {
				document.getElementById('alert-en').value = alertEnEditor.root.innerHTML;
				updateAlertPreview();
			});
			
			alertFrEditor.on('text-change', function() {
				document.getElementById('alert-fr').value = alertFrEditor.root.innerHTML;
				updateAlertPreview();
			});
		}

		// Setup alert event listeners
		function setupAlertEventListeners() {
			document.getElementById('alert-type').addEventListener('change', updateAlertPreview);
			document.getElementById('alertForm').addEventListener('submit', handleAlertFormSubmit);
			document.getElementById('alertForm').addEventListener('reset', function() {
				setTimeout(() => {
					if (quillInstances['alert-en']) {
						quillInstances['alert-en'].setText('');
					}
					if (quillInstances['alert-fr']) {
						quillInstances['alert-fr'].setText('');
					}
					document.getElementById('alert-preview-container').style.display = 'none';
				}, 10);
			});
		}

		// Update alert preview
		function updateAlertPreview() {
			const alertType = document.getElementById('alert-type').value;
			const alertEnContent = quillInstances['alert-en'] ? quillInstances['alert-en'].root.innerHTML : '';
			const alertFrContent = quillInstances['alert-fr'] ? quillInstances['alert-fr'].root.innerHTML : '';
			const previewContainer = document.getElementById('alert-preview-container');
			const previewEn = document.getElementById('alert-preview-en');
			const previewFr = document.getElementById('alert-preview-fr');
			
			if (alertType && (alertEnContent.trim() || alertFrContent.trim())) {
				previewContainer.style.display = 'block';
				
				previewEn.className = `alert alert-${alertType} alert-preview`;
				previewEn.innerHTML = alertEnContent || '<em>No English content</em>';
				
				previewFr.className = `alert alert-${alertType} alert-preview`;
				previewFr.innerHTML = alertFrContent || '<em>Aucun contenu français</em>';
			} else {
				previewContainer.style.display = 'none';
			}
		}

		// Handle alert form submission
		function handleAlertFormSubmit(e) {
			e.preventDefault();
			
			const alertType = document.getElementById('alert-type').value;
			const alertEnContent = document.getElementById('alert-en').value.trim();
			const alertFrContent = document.getElementById('alert-fr').value.trim();
			
			if (!alertType) {
				showAlert(getLocalizedText('Please select an alert type.', 'Veuillez sélectionner un type d\'alerte.'), 'danger');
				return;
			}
			
			if (!alertEnContent && !alertFrContent) {
				showAlert(getLocalizedText('Please enter at least one alert message.', 'Veuillez entrer au moins un message d\'alerte.'), 'danger');
				return;
			}
			
			generateAlertSHTMFile(alertType, alertEnContent, alertFrContent);
			showAlert(getLocalizedText('Alert SHTM file generated successfully.', 'Fichier SHTM d\'alerte généré avec succès.'), 'success');
		}

		// Generate alert SHTM file
		function generateAlertSHTMFile(alertType, alertEnContent, alertFrContent) {
			const shtmlContent = `<!--#if expr="lang=eng" -->
		<div class="alert alert-${alertType}" role="alert">
			${alertEnContent}
		</div>
		<!--#else -->
		<div class="alert alert-${alertType}" role="alert">
			${alertFrContent}
		</div>
		<!--#endif -->`;
			
			const blob = new Blob([shtmlContent], { type: 'text/html' });
			const url = window.URL.createObjectURL(blob);
			const a = document.createElement('a');
			a.href = url;
			a.download = 'alert.shtm';
			document.body.appendChild(a);
			a.click();
			
			window.URL.revokeObjectURL(url);
			document.body.removeChild(a);
		}

        // Setup all event listeners
		function setupEventListeners() {
			document.addEventListener('change', function(e) {
				if (e.target.classList.contains('application-radio') || e.target.classList.contains('status-radio')) {
					const entryId = e.target.name.split('-')[1];
					updateMessageOptions(entryId);
					if (e.target.classList.contains('status-radio')) {
						toggleMessageDropdown(entryId);
					}
				}
				
				if (e.target.classList.contains('message-select')) {
					const entryId = e.target.id.split('-')[1];
					toggleCustomMessage(entryId, e.target.value);
				}
			});
			
			document.getElementById('addEntryBtn').addEventListener('click', addStatusEntry);
			document.getElementById('statusForm').addEventListener('submit', handleFormSubmit);
			
			document.getElementById('statusForm').addEventListener('reset', function() {
				setTimeout(() => {
					document.querySelectorAll('.custom-message-section').forEach(section => {
						section.classList.remove('show');
					});
					document.querySelectorAll('.status-entry').forEach(entry => {
						const entryId = entry.dataset.entryId;
						const messageGroup = document.getElementById(`message-${entryId}`).closest('.form-group');
						messageGroup.style.display = 'block';
					});
				}, 10);
			});
		}
        
        // Update message dropdown based on application and status selection
        function updateMessageOptions(entryId) {
            const appRadio = document.querySelector(`input[name="application-${entryId}"]:checked`);
            const statusRadio = document.querySelector(`input[name="status-${entryId}"]:checked`);
            const messageSelect = document.getElementById(`message-${entryId}`);
            
            const app = appRadio ? appRadio.value : null;
            const status = statusRadio ? statusRadio.value : null;
            
			messageSelect.innerHTML = `
				<option value="" data-en="Select a message" data-fr="Sélectionnez un message">Select a message</option>
			`;
            
            if (app && status && messageTemplates[app] && messageTemplates[app][status]) {
                messageTemplates[app][status].forEach(msg => {
                    const option = document.createElement('option');
                    option.value = msg.value;
                    option.dataset.en = msg.en;
                    option.dataset.fr = msg.fr;
                    
                    const currentLang = document.documentElement.lang?.split('-')[0] || 'en';
                    option.textContent = currentLang === 'en' ? msg.en : msg.fr;
                    
                    messageSelect.appendChild(option);
                });
            }
            
            const otherOption = document.createElement('option');
            otherOption.value = 'other';
            otherOption.dataset.en = 'Other';
            otherOption.dataset.fr = 'Autre';
            
            const currentLang = document.documentElement.lang?.split('-')[0] || 'en';
            otherOption.textContent = currentLang === 'en' ? 'Other' : 'Autre';
            messageSelect.appendChild(otherOption);
            
            messageSelect.value = '';
            toggleCustomMessage(entryId, '');
        }
        
        // Toggle custom message section
		function toggleCustomMessage(entryId, value) {
			const customSection = document.getElementById(`custom-message-${entryId}`);
			const customEnInput = document.getElementById(`custom-en-${entryId}`);
			const customFrInput = document.getElementById(`custom-fr-${entryId}`);
			
			if (value === 'other') {
				customSection.classList.add('show');
				customEnInput.required = true;
				customFrInput.required = true;
				customEnInput.setAttribute('aria-required', 'true');
				customFrInput.setAttribute('aria-required', 'true');
			} else {
				customSection.classList.remove('show');
				customEnInput.required = false;
				customFrInput.required = false;
				customEnInput.removeAttribute('aria-required');
				customFrInput.removeAttribute('aria-required');
				
				if (quillInstances[`en-${entryId}`]) {
					quillInstances[`en-${entryId}`].setText('');
				}
				if (quillInstances[`fr-${entryId}`]) {
					quillInstances[`fr-${entryId}`].setText('');
				}
				customEnInput.value = '';
				customFrInput.value = '';
			}
		}

		// Toggle message dropdown visibility based on status
		function toggleMessageDropdown(entryId) {
			const statusRadio = document.querySelector(`input[name="status-${entryId}"]:checked`);
			const messageGroup = document.getElementById(`message-${entryId}`).closest('.form-group');
			
			if (statusRadio && statusRadio.value === 'no-issues') {
				messageGroup.style.display = 'none';
				document.getElementById(`message-${entryId}`).required = false;
				document.getElementById(`message-${entryId}`).value = '';
				toggleCustomMessage(entryId, '');
			} else {
				messageGroup.style.display = 'block';
				document.getElementById(`message-${entryId}`).required = true;
			}
		}
        
        // Add a new status entry
        function addStatusEntry() {
            const currentEntries = document.querySelectorAll('.status-entry').length;
            if (currentEntries >= 2) {
                showAlert(getLocalizedText('Maximum of 2 status entries allowed.', 'Maximum de 2 entrées de statut autorisées.'), 'warning');
                return;
            }
            
            entryCounter++;
            const container = document.getElementById('statusEntriesContainer');
            
            const newEntry = document.createElement('div');
            newEntry.className = 'status-entry';
            newEntry.dataset.entryId = entryCounter;
            newEntry.innerHTML = `
                <h2 class="h4">
                    <span data-en="Status entry" data-fr="Entrée de statut">Status entry</span> #<span class="entry-number">${entryCounter}</span>
                </h2>
                
                <div class="form-group">
                    <fieldset>
                        <legend class="bilingual-label">
                            <span data-en="Application" data-fr="Application">Application</span>
                            <span class="text-danger" aria-label="required">*</span>
                            <small id="application-help-${entryCounter}" class="form-text text-muted d-block" data-en="Choose the application to update." data-fr="Choisissez l'application à mettre à jour.">Choose the application to update.</small>
                        </legend>
                        <div class="form-check">
                            <input class="form-check-input application-radio" type="radio" name="application-${entryCounter}" id="application-outlook-${entryCounter}" value="outlook" required aria-describedby="application-help-${entryCounter}">
                            <label class="form-check-label" for="application-outlook-${entryCounter}">
                                Microsoft Outlook
                            </label>
                        </div>
                        <div class="form-check">
                            <input class="form-check-input application-radio" type="radio" name="application-${entryCounter}" id="application-m365-${entryCounter}" value="m365" required aria-describedby="application-help-${entryCounter}">
                            <label class="form-check-label" for="application-m365-${entryCounter}">
                                Microsoft 365 (M365)
                            </label>
                        </div>
                    </fieldset>
                </div>

                <div class="form-group">
                    <fieldset>
                        <legend class="bilingual-label">
                            <span data-en="Current status" data-fr="Statut actuel">Current status</span>
                            <span class="text-danger" aria-label="required">*</span>
                            <small id="status-help-${entryCounter}" class="form-text text-muted d-block" data-en="Select the current operational status." data-fr="Sélectionnez le statut opérationnel actuel.">Select the current operational status.</small>
                        </legend>
                        <div class="form-check">
                            <input class="form-check-input status-radio" type="radio" name="status-${entryCounter}" id="status-no-issues-${entryCounter}" value="no-issues" required aria-describedby="status-help-${entryCounter}">
                            <label class="form-check-label" for="status-no-issues-${entryCounter}">
                                <span data-en="No reported issues" data-fr="Aucun problème signalé">No reported issues</span>
                            </label>
                        </div>
                        <div class="form-check">
                            <input class="form-check-input status-radio" type="radio" name="status-${entryCounter}" id="status-incident-${entryCounter}" value="incident" required aria-describedby="status-help-${entryCounter}">
                            <label class="form-check-label" for="status-incident-${entryCounter}">
                                <span data-en="Incident" data-fr="Incident">Incident</span>
                            </label>
                        </div>
                        <div class="form-check">
                            <input class="form-check-input status-radio" type="radio" name="status-${entryCounter}" id="status-outage-${entryCounter}" value="outage" required aria-describedby="status-help-${entryCounter}">
                            <label class="form-check-label" for="status-outage-${entryCounter}">
                                <span data-en="Outage" data-fr="Panne">Outage</span>
                            </label>
                        </div>
                    </fieldset>
                </div>
                
                <div class="form-group">
                    <label class="bilingual-label" for="message-${entryCounter}">
                        <span data-en="Status message" data-fr="Message de statut">Status message</span>
                        <span class="text-danger" aria-label="required">*</span>
                        <small id="message-help-${entryCounter}" class="form-text text-muted d-block" data-en="Choose a pre-defined message or select 'Other' to write your own." data-fr="Choisissez un message prédéfini ou sélectionnez « Autre » pour écrire le vôtre.">Choose a pre-defined message or select "Other" to write your own.</small>
                    </label>
                    <select class="form-control message-select" id="message-${entryCounter}" name="message-${entryCounter}" required aria-required="true" aria-describedby="message-help-${entryCounter}">
                        <option value="" data-en="Select a message" data-fr="Sélectionnez un message">Select a message</option>
                        <option value="other" data-en="Other" data-fr="Autre">Other</option>
                    </select>
                </div>
                
                <div class="custom-message-section" id="custom-message-${entryCounter}" role="region" aria-labelledby="custom-message-heading-${entryCounter}">
                    <h3 class="h5" id="custom-message-heading-${entryCounter}" data-en="Custom message" data-fr="Message personnalisé">Custom message</h3>
					<div class="form-group">
                    <label class="bilingual-label" for="custom-en-${entryCounter}">
                        <span data-en="English message" data-fr="Message en anglais">English message</span>
                        <small id="custom-en-help-${entryCounter}" class="form-text text-muted d-block" data-en="Enter your custom message in English." data-fr="Entrez votre message personnalisé en anglais.">Enter your custom message in English.</small>
                    </label>
                    <div id="custom-en-editor-${entryCounter}" class="custom-message-en" style="min-height: 150px;"></div>
                    <input type="hidden" id="custom-en-${entryCounter}" name="custom-en-${entryCounter}">
                </div>

                <div class="form-group">
                    <label class="bilingual-label" for="custom-fr-${entryCounter}">
                        <span data-en="French message" data-fr="Message en français">French message</span>
                        <small id="custom-fr-help-${entryCounter}" class="form-text text-muted d-block" data-en="Enter your custom message in French." data-fr="Entrez votre message personnalisé en français.">Enter your custom message in French.</small>
                    </label>
                    <div id="custom-fr-editor-${entryCounter}" class="custom-message-fr" style="min-height: 150px;"></div>
                    <input type="hidden" id="custom-fr-${entryCounter}" name="custom-fr-${entryCounter}">
                </div>
            </div>
            
            <button type="button" class="btn btn-danger btn-sm remove-entry-btn" data-entry-id="${entryCounter}" data-en="Remove this entry" data-fr="Supprimer cette entrée">Remove this entry</button>
        `;
        
        container.appendChild(newEntry);
        initializeQuillEditor(entryCounter);

        const currentCounter = entryCounter;
        newEntry.querySelector('.remove-entry-btn').addEventListener('click', function() {
            delete quillInstances[`en-${currentCounter}`];
            delete quillInstances[`fr-${currentCounter}`];
            newEntry.remove();
            updateAddButtonVisibility();
            showAlert(getLocalizedText('Entry removed successfully.', 'Entrée supprimée avec succès.'), 'info');
        });

        updateMessageOptions(entryCounter);

        const currentLang = document.documentElement.lang?.split('-')[0] || 'en';
        updateElementLanguage(newEntry, currentLang);

        const firstRadio = newEntry.querySelector('.application-radio');
        if (firstRadio) firstRadio.focus();

        updateAddButtonVisibility();
        showAlert(getLocalizedText('New status entry added.', 'Nouvelle entrée de statut ajoutée.'), 'success');
    }

    function updateAddButtonVisibility() {
        const addBtn = document.getElementById('addEntryBtn');
        const currentEntries = document.querySelectorAll('.status-entry').length;
        
        if (currentEntries >= 2) {
            addBtn.style.display = 'none';
        } else {
            addBtn.style.display = 'inline-block';
        }
    }

    function updateElementLanguage(element, lang) {
        const isEnglish = lang === 'en-CA' || lang === 'en';
        element.querySelectorAll('[data-en][data-fr]').forEach(el => {
            const text = isEnglish ? el.getAttribute('data-en') : el.getAttribute('data-fr');
            if (el.tagName === 'INPUT' || el.tagName === 'TEXTAREA') {
                el.placeholder = text;
            } else if (el.tagName === 'OPTION') {
                el.textContent = text;
            } else {
                el.innerHTML = text;
            }
        });
    }
    
    function getLocalizedText(enText, frText) {
        const currentLang = document.documentElement.lang?.split('-')[0] || 'en';
        return currentLang === 'en' ? enText : frText;
    }
    
    function handleFormSubmit(e) {
        e.preventDefault();
        
        if (!validateForm()) {
            showAlert(getLocalizedText('Please fill in all required fields.', 'Veuillez remplir tous les champs obligatoires.'), 'danger');
            return;
        }
        
        const formData = collectFormData();
        
        if (formData.length === 0) {
            showAlert(getLocalizedText('No valid entries to export.', 'Aucune entrée valide à exporter.'), 'warning');
            return;
        }
        
        formData.forEach(entry => {
            generateSHTMFile(entry);
        });
        
        showAlert(getLocalizedText(`Successfully generated ${formData.length} SHTM file(s).`, `${formData.length} fichier(s) SHTM généré(s) avec succès.`), 'success');
    }
    
    function validateForm() {
        const form = document.getElementById('statusForm');
        let isValid = true;
        
        if (!form.checkValidity()) {
            form.classList.add('was-validated');
            return false;
        }
        
        document.querySelectorAll('.status-entry').forEach(entry => {
            const entryId = entry.dataset.entryId;
            const messageSelect = document.getElementById(`message-${entryId}`);
            
            if (messageSelect && messageSelect.value === 'other') {
                const customEnInput = document.getElementById(`custom-en-${entryId}`);
                const customFrInput = document.getElementById(`custom-fr-${entryId}`);
                
                let enContent = customEnInput.value.trim();
                let frContent = customFrInput.value.trim();
                
                if (quillInstances[`en-${entryId}`]) {
                    enContent = quillInstances[`en-${entryId}`].getText().trim();
                }
                if (quillInstances[`fr-${entryId}`]) {
                    frContent = quillInstances[`fr-${entryId}`].getText().trim();
                }
                
                if (!enContent || !frContent) {
                    isValid = false;
                    const enEditor = document.getElementById(`custom-en-editor-${entryId}`);
                    const frEditor = document.getElementById(`custom-fr-editor-${entryId}`);
                    if (enEditor) enEditor.style.border = '2px solid #dc3545';
                    if (frEditor) frEditor.style.border = '2px solid #dc3545';
                }
            }
        });
        
        return isValid;
    }
    
	function collectFormData() {
		const entries = [];
		
		document.querySelectorAll('.status-entry').forEach(entry => {
			const entryId = entry.dataset.entryId;
			const appRadio = document.querySelector(`input[name="application-${entryId}"]:checked`);
			const statusRadio = document.querySelector(`input[name="status-${entryId}"]:checked`);
			const app = appRadio ? appRadio.value : null;
			const status = statusRadio ? statusRadio.value : null;
			
			if (!app || !status) {
				return;
			}
			
			// For "no-issues" status, no message is required
			if (status === 'no-issues') {
				entries.push({
					application: app,
					status: status,
					messageEn: '',
					messageFr: ''
				});
				return;
			}
			
			const messageSelect = document.getElementById(`message-${entryId}`);
			const messageValue = messageSelect.value;
			
			if (!messageValue) {
				return;
			}
			
			let messageEn, messageFr;
			
			if (messageValue === 'other') {
				messageEn = document.getElementById(`custom-en-${entryId}`).value.trim();
				messageFr = document.getElementById(`custom-fr-${entryId}`).value.trim();
				
				if (!messageEn && quillInstances[`en-${entryId}`]) {
					messageEn = quillInstances[`en-${entryId}`].root.innerHTML.trim();
				}
				if (!messageFr && quillInstances[`fr-${entryId}`]) {
					messageFr = quillInstances[`fr-${entryId}`].root.innerHTML.trim();
				}
			} else {
				const selectedOption = messageSelect.options[messageSelect.selectedIndex];
				messageEn = selectedOption.dataset.en;
				messageFr = selectedOption.dataset.fr;
			}
			
			entries.push({
				application: app,
				status: status,
				messageEn: messageEn,
				messageFr: messageFr
			});
		});
		
		return entries;
	}
    
    function generateSHTMFile(entry) {
        const timestamp = new Date().toISOString();
        const filename = entry.application === 'outlook' ? 'outlook.shtm' : 'm365.shtm';
        
        const appDisplayNames = {
            'outlook': {
                en: 'Microsoft Outlook',
                fr: 'Microsoft Outlook'
            },
            'm365': {
                en: 'Microsoft 365 (M365)',
                fr: 'Microsoft 365 (M365)'
            }
        };
        
        const statusConfig = {
            'no-issues': {
                en: 'No reported issues',
                fr: 'Aucun problème signalé',
                icon: 'fa-check-circle',
                color: 'text-success',
                ariaLabelEn: 'No reported issues',
                ariaLabelFr: 'Aucun problème signalé'
            },
            'incident': {
                en: 'Incident',
                fr: 'Incident',
                icon: 'fa-exclamation-triangle',
                color: 'text-warning',
                ariaLabelEn: 'Incident',
                ariaLabelFr: 'Incident'
            },
            'outage': {
                en: 'Outage',
                fr: 'Panne',
                icon: 'fa-times-circle',
                color: 'text-danger',
                ariaLabelEn: 'Outage',
                ariaLabelFr: 'Panne'
            }
        };
        
        const appNameEn = appDisplayNames[entry.application].en;
        const appNameFr = appDisplayNames[entry.application].fr;
        const statusInfo = statusConfig[entry.status];
        
        const messageEnHTML = entry.messageEn ? `<p>${entry.messageEn}</p>` : '';
		const messageFrHTML = entry.messageFr ? `<p>${entry.messageFr}</p>` : '';

		const shtmlContent = `<!--#if expr="lang=eng" -->
		<div class="col-sm-6">
			<div class="card mb-3">
				<div class="card-body d-flex justify-content-between align-items-center">
					<div>
						<h3 class="h5 mb-1">${appNameEn}</h3>
						<p class="mb-0">
							<span class="sr-only">Status:&#160;</span>${statusInfo.en}
						</p>
						${messageEnHTML}
					</div>
					<i class="fas ${statusInfo.icon} fa-lg ${statusInfo.color}" aria-label="${statusInfo.ariaLabelEn}" role="img"></i>
				</div>
			</div>
		</div>
		<!--#else -->
		<div class="col-sm-6">
			<div class="card mb-3">
				<div class="card-body d-flex justify-content-between align-items-center">
					<div>
						<h3 class="h5 mb-1">${appNameFr}</h3>
						<p class="mb-0">
							<span class="sr-only">État&#160;:&#160;</span>${statusInfo.fr}
						</p>
						${messageFrHTML}
					</div>
					<i class="fas ${statusInfo.icon} fa-lg ${statusInfo.color}" aria-label="${statusInfo.ariaLabelFr}" role="img"></i>
				</div>
			</div>
		</div>
		<!--#endif -->`;
	const blob = new Blob([shtmlContent], { type: 'text/html' });
        const url = window.URL.createObjectURL(blob);
        const a = document.createElement('a');
        a.href = url;
        a.download = filename;
        document.body.appendChild(a);
        a.click();
        
        window.URL.revokeObjectURL(url);
        document.body.removeChild(a);
    }
    
    function showAlert(message, type) {
        const alertContainer = document.getElementById('alertContainer');
        const alert = document.createElement('div');
        alert.className = `alert alert-${type} alert-dismissible fade show`;
        alert.setAttribute('role', 'alert');
        alert.innerHTML = `
            ${message}
            <button type="button" class="btn-close" data-bs-dismiss="alert" aria-label="Close"></button>
        `;
        alertContainer.appendChild(alert);
        
        setTimeout(() => {
            alert.classList.remove('show');
            setTimeout(() => alert.remove(), 150);
        }, 5000);
    }
</script>
</body>
</html>