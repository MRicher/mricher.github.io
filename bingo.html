<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ðŸ¦œ Parrot Bingo Caller - Multi-Card System</title>
    <link href="https://cdnjs.cloudflare.com/ajax/libs/bootstrap/5.3.0/css/bootstrap.min.css" rel="stylesheet">
    <style>
        body {
            background: #f8f9fa;
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            height: 100vh;
            overflow: hidden;
        }

        .main-container {
            height: 100vh;
            display: flex;
            flex-direction: column;
        }

        /* Header */
        .header-section {
            background: linear-gradient(135deg, #007bff, #0056b3);
            color: white;
            padding: 0.5rem 0;
            text-align: center;
            box-shadow: 0 2px 4px rgba(0,0,0,0.1);
        }

        .header-section h1 {
            font-size: 1.5rem;
            font-weight: 700;
            margin: 0;
        }

        .header-section .subtitle {
            font-size: 0.9rem;
            opacity: 0.9;
            margin: 0;
        }

        /* Card links */
        .card-links-section {
            background: #e9ecef;
            border-bottom: 1px solid #dee2e6;
            padding: 0.4rem 0;
        }

        .card-link {
            background: #28a745;
            color: white;
            text-decoration: none;
            font-weight: 600;
            font-size: 0.75rem;
            padding: 0.3rem 0.6rem;
            border-radius: 4px;
            transition: all 0.2s ease;
        }

        .card-link:hover {
            background: #218838;
            color: white;
            transform: translateY(-1px);
        }

        /* Winner alerts */
        .winner-alerts {
            background: linear-gradient(45deg, #ffc107, #fd7e14);
            border-radius: 6px;
            animation: winnerPulse 2s infinite alternate;
        }

        .winner-alerts.show {
            display: block !important;
        }

        @keyframes winnerPulse {
            0% { transform: scale(1); }
            100% { transform: scale(1.02); }
        }

        .winner-card {
            background: white;
            border-radius: 4px;
            font-weight: bold;
            color: #495057;
            font-size: 0.8rem;
        }

        /* Main content area */
        .content-area {
            flex: 1;
            padding: 0.5rem;
            overflow: hidden;
        }

        /* Current number display */
        .current-number-section {
            background: white;
            border: 2px solid #007bff;
            border-radius: 8px;
            text-align: center;
            padding: 0.8rem;
            position: relative;
            box-shadow: 0 2px 8px rgba(0,123,255,0.15);
        }

        .current-number {
            font-size: 3.5rem;
            font-weight: 900;
            color: #007bff;
            margin: 0.3rem 0;
            text-shadow: 0 2px 4px rgba(0,123,255,0.2);
        }

        .current-letter {
            font-size: 1.1rem;
            color: #6c757d;
            font-weight: 600;
            margin: 0;
        }

        .squawk-bubble {
            position: absolute;
            top: -8px;
            right: 10px;
            background: #ffc107;
            border-radius: 12px;
            padding: 0.2rem 0.6rem;
            font-size: 0.7rem;
            font-weight: bold;
            color: #212529;
            opacity: 0;
            transform: scale(0);
            transition: all 0.3s ease;
            box-shadow: 0 2px 4px rgba(0,0,0,0.2);
        }

        .squawk-bubble.show {
            opacity: 1;
            transform: scale(1);
        }

        /* Buttons */
        .control-buttons {
            gap: 0.5rem;
        }

        .btn-draw {
            background: #28a745;
            border: none;
            color: white;
            font-weight: 600;
            font-size: 0.9rem;
            padding: 0.6rem 1.2rem;
            border-radius: 6px;
            transition: all 0.2s ease;
        }

        .btn-draw:hover:not(:disabled) {
            background: #218838;
            transform: translateY(-1px);
            box-shadow: 0 4px 8px rgba(40,167,69,0.3);
        }

        .btn-draw:disabled {
            background: #6c757d;
            color: white;
        }

        .btn-reset {
            background: #dc3545;
            border: none;
            color: white;
            font-weight: 600;
            font-size: 0.9rem;
            padding: 0.6rem 1.2rem;
            border-radius: 6px;
            transition: all 0.2s ease;
        }

        .btn-reset:hover {
            background: #c82333;
            transform: translateY(-1px);
            box-shadow: 0 4px 8px rgba(220,53,69,0.3);
        }

        .btn-copy {
            background: #6f42c1;
            border: none;
            color: white;
            font-weight: 600;
            font-size: 0.9rem;
            padding: 0.6rem 1.2rem;
            border-radius: 6px;
            transition: all 0.2s ease;
        }

        .btn-copy:hover {
            background: #5a32a3;
            transform: translateY(-1px);
            box-shadow: 0 4px 8px rgba(111,66,193,0.3);
        }

        /* Counters */
        .counter-card {
            background: white;
            border: 1px solid #dee2e6;
            border-radius: 6px;
            text-align: center;
            box-shadow: 0 1px 3px rgba(0,0,0,0.1);
            padding: 0.6rem;
        }

        .counter-number {
            font-size: 1.8rem;
            font-weight: 700;
            color: #007bff;
            margin: 0;
            line-height: 1;
        }

        .counter-label {
            font-size: 0.75rem;
            color: #6c757d;
            font-weight: 500;
            margin: 0;
            text-transform: uppercase;
        }

        /* BINGO Grid - Ultra compact like letsplaybingo.io */
        .bingo-board {
            background: white;
            border: 2px solid #007bff;
            border-radius: 8px;
            padding: 0.4rem;
            box-shadow: 0 2px 8px rgba(0,123,255,0.15);
        }

        .bingo-headers {
            display: grid;
            grid-template-columns: repeat(5, 1fr);
            gap: 2px;
            margin-bottom: 0.3rem;
        }

        .letter-header {
            background: #007bff;
            color: white;
            font-size: 1rem;
            font-weight: 700;
            text-align: center;
            padding: 0.3rem;
            border-radius: 3px;
        }

        .numbers-grid {
            display: grid;
            grid-template-columns: repeat(5, 1fr);
            gap: 1px;
        }

        .number-cell {
            background: #f8f9fa;
            color: #495057;
            font-size: 1rem;
            font-weight: 600;
            text-align: center;
            padding: 0.3rem;
            border-radius: 3px;
        }

        .number-cell.called {
            background: #28a745;
            color: white;
            font-weight: 700;
        }

        .number-cell.current {
            background: #ffc107;
            color: #212529;
            font-weight: 700;
            animation: currentPulse 1s infinite alternate;
            box-shadow: 0 0 8px rgba(255,193,7,0.8);
            z-index: 10;
            position: relative;
        }

        @keyframes currentPulse {
            0% { transform: scale(1); }
            100% { transform: scale(1.1); }
        }

        /* History panel */
        .history-panel {
            background: white;
            border: 1px solid #dee2e6;
            border-radius: 8px;
            height: 100%;
            display: flex;
            flex-direction: column;
            box-shadow: 0 1px 3px rgba(0,0,0,0.1);
        }

        .history-header {
            background: #f8f9fa;
            border-bottom: 1px solid #dee2e6;
            padding: 0.6rem;
            border-radius: 8px 8px 0 0;
        }

        .history-list {
            flex: 1;
            overflow-y: auto;
            padding: 0.4rem;
        }

        .history-item {
            background: #f8f9fa;
            border-left: 3px solid #007bff;
            border-radius: 3px;
            padding: 0.3rem 0.6rem;
            margin-bottom: 0.2rem;
            font-size: 0.8rem;
        }

        .history-number {
            font-weight: 600;
            color: #007bff;
        }

        /* Game complete */
        .game-complete {
            background: linear-gradient(135deg, #28a745, #20c997);
            border-radius: 8px;
            color: white;
            text-align: center;
            padding: 1rem;
            box-shadow: 0 2px 8px rgba(40,167,69,0.3);
        }

        /* Modal */
        .modal-content {
            border-radius: 8px;
            border: none;
            box-shadow: 0 10px 30px rgba(0,0,0,0.3);
        }

        .modal-header {
            background: #007bff;
            color: white;
            border-radius: 8px 8px 0 0;
            border-bottom: none;
        }

        .modal-header .btn-close {
            filter: invert(1);
        }

        /* Ensure everything fits on screen */
        .row.main-row {
            height: calc(100vh - 120px);
            margin: 0;
        }

        .left-panel {
            height: 100%;
            display: flex;
            flex-direction: column;
        }

        .bingo-board {
            flex: 1;
            display: flex;
            flex-direction: column;
            min-height: 0;
        }

        .numbers-grid {
            flex: 1;
        }

        /* Screen reader only */
        .sr-only {
            position: absolute !important;
            width: 1px !important;
            height: 1px !important;
            padding: 0 !important;
            margin: -1px !important;
            overflow: hidden !important;
            clip: rect(0, 0, 0, 0) !important;
            white-space: nowrap !important;
            border: 0 !important;
        }

        /* Mobile responsive */
        @media (max-width: 768px) {
            .header-section h1 {
                font-size: 1.2rem;
            }
            
            .current-number {
                font-size: 2.5rem;
            }
            
            .number-cell {
                font-size: 0.35rem;
                height: 12px;
                min-height: 12px;
                max-height: 12px;
            }
            
            .letter-header {
                font-size: 0.7rem;
                padding: 0.2rem;
            }

            .row.main-row {
                height: calc(100vh - 140px);
            }
        }

        @media (max-width: 576px) {
            .number-cell {
                font-size: 0.3rem;
                height: 10px;
                min-height: 10px;
                max-height: 10px;
            }

            .letter-header {
                font-size: 0.6rem;
            }

            .current-number {
                font-size: 2rem;
            }
        }
    </style>
</head>
<body>
    <div class="main-container">
        <!-- Header -->
        <header class="header-section">
            <div class="container-fluid">
                <h1>ðŸ¦œ Parrot Partners Bingo Caller</h1>
            </div>
        </header>

        <!-- Card Links Section -->
        <div class="card-links-section">
            <div class="container-fluid">
                <div class="d-flex justify-content-center gap-2 flex-wrap align-items-center">
                    <span class="text-dark fw-bold small">ðŸŽ¯ Bingo Cards:</span>
                    <a href="parrt.html" target="_blank" class="card-link">PARRT</a>
                    <a href="sqawk.html" target="_blank" class="card-link">SQAWK</a>
                </div>
            </div>
        </div>

        <!-- Winner Alerts -->
        <div class="winner-alerts p-2 mx-2 d-none" id="winnerAlerts">
            <div class="text-center fw-bold mb-1">ðŸŽ‰ BINGO WINNERS! ðŸŽ‰</div>
            <div class="d-flex justify-content-center gap-2 flex-wrap" id="winnerList"></div>
        </div>

        <!-- Main Content -->
        <div class="content-area">
            <div class="container-fluid h-100">
                <div class="row g-2 main-row">
                    <!-- Left Panel -->
                    <div class="col-lg-9">
                        <div class="left-panel">
                            <div class="row g-2 mb-2">
                                <!-- Current Number Display -->
                                <div class="col-md-5">
                                    <div class="current-number-section position-relative">
                                        <div class="squawk-bubble" id="squawkBubble">Squawk!</div>
                                        <div class="current-letter" id="currentLetter">Ready to play!</div>
                                        <div class="current-number" id="currentNumber">--</div>
                                        <div id="announcer" class="sr-only" aria-live="assertive" aria-atomic="true"></div>
                                    </div>
                                </div>

                                <!-- Controls -->
                                <div class="col-md-4">
                                    <div class="d-flex flex-column gap-2 h-100">
                                        <button class="btn btn-draw flex-fill" id="drawButton">
                                            ðŸŽ¯ Draw Number
                                        </button>
                                        <div class="d-flex gap-1">
                                            <button class="btn btn-reset flex-fill" id="resetButton">
                                                ðŸ”„ Reset
                                            </button>
                                            <button class="btn btn-copy flex-fill" id="copyButton">
                                                ðŸ“‹ Copy
                                            </button>
                                        </div>
                                    </div>
                                </div>

                                <!-- Counters -->
                                <div class="col-md-3">
                                    <div class="row g-1 h-100">
                                        <div class="col-6">
                                            <div class="counter-card h-100 d-flex flex-column justify-content-center">
                                                <div class="counter-number" id="drawnCount">0</div>
                                                <div class="counter-label">Drawn</div>
                                            </div>
                                        </div>
                                        <div class="col-6">
                                            <div class="counter-card h-100 d-flex flex-column justify-content-center">
                                                <div class="counter-number" id="remainingCount">75</div>
                                                <div class="counter-label">Left</div>
                                            </div>
                                        </div>
                                    </div>
                                </div>
                            </div>

                            <!-- Game Complete Message -->
                            <div id="gameComplete" class="game-complete mb-2 d-none">
                                <h6 class="mb-1">ðŸŽ‰ All Numbers Called!</h6>
                                <p class="mb-0 small">Game complete! Ready for a new round.</p>
                            </div>

                            <!-- BINGO Board -->
                            <div class="bingo-board">
                                <div class="bingo-headers">
                                    <div class="letter-header">B</div>
                                    <div class="letter-header">I</div>
                                    <div class="letter-header">N</div>
                                    <div class="letter-header">G</div>
                                    <div class="letter-header">O</div>
                                </div>
                                <div class="numbers-grid" id="numbersGrid"></div>
                            </div>
                        </div>
                    </div>

                    <!-- Right Panel - History -->
                    <div class="col-lg-3">
                        <div class="history-panel">
                            <div class="history-header">
                                <h6 class="text-primary fw-bold mb-0">ðŸ“œ Call History</h6>
                            </div>
                            <div class="history-list" id="historyList">
                                <p class="text-center text-muted small mb-0 p-2">
                                    Numbers will appear here as they're called
                                </p>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Confirmation Modal -->
    <div class="modal fade" id="confirmModal" tabindex="-1" aria-labelledby="modalTitle" aria-hidden="true">
        <div class="modal-dialog modal-dialog-centered modal-sm">
            <div class="modal-content">
                <div class="modal-header">
                    <h6 class="modal-title" id="modalTitle">Confirm Reset</h6>
                    <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
                </div>
                <div class="modal-body">
                    <p id="modalMessage" class="mb-0">Are you sure you want to reset the game?</p>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal" id="modalNo">No</button>
                    <button type="button" class="btn btn-primary" id="modalYes">Yes</button>
                </div>
            </div>
        </div>
    </div>

    <!-- Hidden help text for screen readers -->
    <div class="sr-only">
        <div id="drawHelp">Press Space or Enter to draw a number</div>
        <div id="resetHelp">Press R to reset the game</div>
        <div id="copyHelp">Copy the call history to clipboard</div>
    </div>

    <script src="https://cdnjs.cloudflare.com/ajax/libs/bootstrap/5.3.0/js/bootstrap.bundle.min.js"></script>
    <script>
        // Protect against extension errors
        window.addEventListener('error', function(e) {
            // Only log extension errors, don't let them break our app
            if (e.filename && e.filename.includes('moz-extension://')) {
                console.warn('Browser extension error detected and ignored:', e.message);
                e.preventDefault();
                return false;
            }
        });

        (() => {
            'use strict';

            // Game state
            let remainingNumbers = [];
            let calledNumbers = [];
            let currentNumber = null;
            let isResetting = false;
            let resetStep = 0;
            let winners = new Set();
            let modalInstance = null;

            // Bingo card definitions with unique 5-letter IDs
            const bingoCards = {
                'PARRT': {
                    B: [7, 14, 2, 9, 12],
                    I: [22, 29, 16, 25, 18],
                    N: [31, 44, 'FREE', 33, 41],
                    G: [56, 49, 52, 47, 60],
                    O: [61, 74, 67, 71, 63]
                },
                'SQAWK': {
                    B: [5, 11, 8, 15, 3],
                    I: [28, 17, 24, 30, 19],
                    N: [34, 45, 'FREE', 38, 32],
                    G: [58, 51, 46, 54, 59],
                    O: [65, 72, 68, 75, 64]
                }
            };

            // DOM elements
            const elements = {
                drawButton: document.getElementById('drawButton'),
                resetButton: document.getElementById('resetButton'),
                copyButton: document.getElementById('copyButton'),
                currentNumber: document.getElementById('currentNumber'),
                currentLetter: document.getElementById('currentLetter'),
                drawnCount: document.getElementById('drawnCount'),
                remainingCount: document.getElementById('remainingCount'),
                historyList: document.getElementById('historyList'),
                numbersGrid: document.getElementById('numbersGrid'),
                gameComplete: document.getElementById('gameComplete'),
                squawkBubble: document.getElementById('squawkBubble'),
                announcer: document.getElementById('announcer'),
                confirmModal: document.getElementById('confirmModal'),
                modalTitle: document.getElementById('modalTitle'),
                modalMessage: document.getElementById('modalMessage'),
                modalYes: document.getElementById('modalYes'),
                modalNo: document.getElementById('modalNo'),
                winnerAlerts: document.getElementById('winnerAlerts'),
                winnerList: document.getElementById('winnerList')
            };

            // Initialize the game
            function initializeGame() {
                remainingNumbers = [];
                calledNumbers = [];
                currentNumber = null;
                isResetting = false;
                resetStep = 0;
                winners.clear();

                // Fill remaining numbers array with 1-75
                for (let i = 1; i <= 75; i++) {
                    remainingNumbers.push(i);
                }

                // Reset UI
                elements.currentNumber.textContent = '--';
                elements.currentLetter.textContent = 'Ready to play!';
                elements.gameComplete.classList.add('d-none');
                elements.drawButton.disabled = false;
                elements.winnerAlerts.classList.remove('show');
                elements.winnerAlerts.classList.add('d-none');
                
                updateCounters();
                updateHistoryUI();
                createNumbersGrid();
                hideModal();

                // Broadcast reset to all card windows
                broadcastToCards({ type: 'reset' });
            }

            // Get letter group for a number
            function getLetterForNumber(num) {
                if (num >= 1 && num <= 15) return 'B';
                if (num >= 16 && num <= 30) return 'I';
                if (num >= 31 && num <= 45) return 'N';
                if (num >= 46 && num <= 60) return 'G';
                if (num >= 61 && num <= 75) return 'O';
                return '';
            }

            // Check for bingo on a specific card
            function checkBingo(cardId) {
                const card = bingoCards[cardId];
                if (!card) return false;

                const LETTERS = ['B', 'I', 'N', 'G', 'O'];

                // Check rows
                for (let row = 0; row < 5; row++) {
                    let rowComplete = true;
                    for (let col = 0; col < 5; col++) {
                        const cellValue = card[LETTERS[col]][row];
                        if (cellValue !== 'FREE' && !calledNumbers.includes(cellValue)) {
                            rowComplete = false;
                            break;
                        }
                    }
                    if (rowComplete) return true;
                }

                // Check columns
                for (let col = 0; col < 5; col++) {
                    let colComplete = true;
                    for (let row = 0; row < 5; row++) {
                        const cellValue = card[LETTERS[col]][row];
                        if (cellValue !== 'FREE' && !calledNumbers.includes(cellValue)) {
                            colComplete = false;
                            break;
                        }
                    }
                    if (colComplete) return true;
                }

                // Check diagonals
                // Top-left to bottom-right
                let diagonal1Complete = true;
                for (let i = 0; i < 5; i++) {
                    const cellValue = card[LETTERS[i]][i];
                    if (cellValue !== 'FREE' && !calledNumbers.includes(cellValue)) {
                        diagonal1Complete = false;
                        break;
                    }
                }
                if (diagonal1Complete) return true;

                // Top-right to bottom-left
                let diagonal2Complete = true;
                for (let i = 0; i < 5; i++) {
                    const cellValue = card[LETTERS[i]][4 - i];
                    if (cellValue !== 'FREE' && !calledNumbers.includes(cellValue)) {
                        diagonal2Complete = false;
                        break;
                    }
                }
                if (diagonal2Complete) return true;

                return false;
            }

            // Check all cards for winners
            function checkAllCardsForWinners() {
                const newWinners = [];
                
                Object.keys(bingoCards).forEach(cardId => {
                    if (!winners.has(cardId) && checkBingo(cardId)) {
                        winners.add(cardId);
                        newWinners.push(cardId);
                    }
                });

                if (newWinners.length > 0) {
                    updateWinnerDisplay();
                    // Announce new winners
                    elements.announcer.textContent = `BINGO! Winners: ${Array.from(winners).join(', ')}`;
                }
            }

            // Update winner display
            function updateWinnerDisplay() {
                if (winners.size > 0) {
                    elements.winnerList.innerHTML = Array.from(winners).map(cardId => 
                        `<div class="winner-card p-1 px-2">Card ${cardId}</div>`
                    ).join('');
                    elements.winnerAlerts.classList.add('show');
                    elements.winnerAlerts.classList.remove('d-none');
                } else {
                    elements.winnerAlerts.classList.remove('show');
                    elements.winnerAlerts.classList.add('d-none');
                }
            }

            // Broadcast message to all card windows
            function broadcastToCards(message) {
                try {
                    // Use a simple variable to communicate with card windows
                    window.bingoCallerMessage = { ...message, timestamp: Date.now() };
                    
                    // Clean up after a short delay
                    setTimeout(() => {
                        if (window.bingoCallerMessage && window.bingoCallerMessage.timestamp === message.timestamp) {
                            delete window.bingoCallerMessage;
                        }
                    }, 1000);
                } catch (error) {
                    console.warn('Could not broadcast to cards:', error);
                }
            }

            // Draw the next number
            function drawNextNumber() {
                if (remainingNumbers.length === 0 || isResetting) return;

                // Prevent double clicks
                elements.drawButton.disabled = true;

                // Remove current highlight
                if (currentNumber) {
                    const prevCell = document.querySelector(`[data-number="${currentNumber}"]`);
                    if (prevCell) {
                        prevCell.classList.remove('current');
                    }
                }

                // Pick random number from remaining
                const randomIndex = Math.floor(Math.random() * remainingNumbers.length);
                const drawnNumber = remainingNumbers.splice(randomIndex, 1)[0];
                
                currentNumber = drawnNumber;
                calledNumbers.unshift(drawnNumber); // Add to beginning for reverse chronological order

                const letter = getLetterForNumber(drawnNumber);
                
                // Update display
                elements.currentNumber.textContent = drawnNumber;
                elements.currentLetter.textContent = `${letter} - ${drawnNumber}`;

                // Announce for screen readers
                elements.announcer.textContent = `${letter} ${drawnNumber}`;

                // Show squawk bubble
                showSquawk();

                // Update UI
                updateCounters();
                updateHistoryUI();
                updateGridUI();

                // Broadcast to card windows
                broadcastToCards({ 
                    type: 'numberCalled', 
                    number: drawnNumber, 
                    letter: letter,
                    calledNumbers: [...calledNumbers]
                });

                // Check for winners
                setTimeout(() => {
                    checkAllCardsForWinners();
                }, 500);

                // Check if game is complete
                if (remainingNumbers.length === 0) {
                    elements.gameComplete.classList.remove('d-none');
                    elements.drawButton.disabled = true;
                } else {
                    // Re-enable button after short delay to prevent spam
                    setTimeout(() => {
                        elements.drawButton.disabled = false;
                    }, 500);
                }
            }

            // Show squawk animation
            function showSquawk() {
                const messages = ['Squawk!', 'Tweet!', 'Chirp!'];
                const randomMessage = messages[Math.floor(Math.random() * messages.length)];
                elements.squawkBubble.textContent = randomMessage;
                elements.squawkBubble.classList.add('show');
                setTimeout(() => {
                    elements.squawkBubble.classList.remove('show');
                }, 2000);
            }

            // Update counters
            function updateCounters() {
                elements.drawnCount.textContent = calledNumbers.length;
                elements.remainingCount.textContent = remainingNumbers.length;
            }

            // Update history display
            function updateHistoryUI() {
                if (calledNumbers.length === 0) {
                    elements.historyList.innerHTML = `
                        <p class="text-center text-muted small mb-0 p-2">
                            Numbers will appear here as they're called
                        </p>
                    `;
                    return;
                }

                elements.historyList.innerHTML = calledNumbers.map(num => {
                    const letter = getLetterForNumber(num);
                    return `
                        <div class="history-item">
                            <span class="history-number">${letter}-${num}</span>
                        </div>
                    `;
                }).join('');
            }

            // Create the numbers grid
            function createNumbersGrid() {
                elements.numbersGrid.innerHTML = '';
                
                for (let i = 1; i <= 75; i++) {
                    const cell = document.createElement('div');
                    cell.className = 'number-cell';
                    cell.textContent = i;
                    cell.setAttribute('data-number', i);
                    cell.setAttribute('aria-label', `${getLetterForNumber(i)} ${i}`);
                    elements.numbersGrid.appendChild(cell);
                }
            }

            // Update grid visual state
            function updateGridUI() {
                // Mark called numbers
                calledNumbers.forEach(num => {
                    const cell = document.querySelector(`[data-number="${num}"]`);
                    if (cell && !cell.classList.contains('called')) {
                        cell.classList.add('called');
                    }
                });

                // Highlight current number
                if (currentNumber) {
                    const currentCell = document.querySelector(`[data-number="${currentNumber}"]`);
                    if (currentCell) {
                        currentCell.classList.add('current');
                        // Remove current highlight after animation
                        setTimeout(() => {
                            if (currentCell.classList.contains('current')) {
                                currentCell.classList.remove('current');
                            }
                        }, 3000);
                    }
                }
            }

            // Show modal with Bootstrap
            function showModal(title, message, onYes) {
                elements.modalTitle.textContent = title;
                elements.modalMessage.textContent = message;
                
                if (!modalInstance) {
                    modalInstance = new bootstrap.Modal(elements.confirmModal, {
                        backdrop: 'static',
                        keyboard: true
                    });
                }
                
                modalInstance.show();
                
                // Set up event handlers (remove old ones first)
                const newYesHandler = () => {
                    modalInstance.hide();
                    if (onYes) onYes();
                };
                
                elements.modalYes.removeEventListener('click', elements.modalYes._currentHandler);
                elements.modalYes.addEventListener('click', newYesHandler);
                elements.modalYes._currentHandler = newYesHandler;
                
                // Focus the Yes button for accessibility
                setTimeout(() => {
                    elements.modalYes.focus();
                }, 200);
            }

            // Hide modal
            function hideModal() {
                if (modalInstance) {
                    modalInstance.hide();
                }
                resetStep = 0;
                isResetting = false;
            }

            // Double confirmation reset
            function resetWithDoubleConfirm() {
                if (isResetting) return;
                
                isResetting = true;
                resetStep = 1;

                showModal(
                    'Confirm Reset',
                    'Are you sure you want to reset the game?',
                    () => {
                        resetStep = 2;
                        showModal(
                            'Really Reset?',
                            'Really reset? This will clear all history and winners.',
                            () => {
                                initializeGame();
                            }
                        );
                    }
                );
            }

            // Copy history to clipboard
            async function copyHistoryToClipboard() {
                if (calledNumbers.length === 0) {
                    alert('No numbers have been called yet!');
                    return;
                }

                const historyText = calledNumbers.map(num => {
                    const letter = getLetterForNumber(num);
                    return `${letter}-${num}`;
                }).join(', ');

                try {
                    await navigator.clipboard.writeText(historyText);
                    
                    // Visual feedback
                    const originalText = elements.copyButton.textContent;
                    elements.copyButton.textContent = 'âœ… Copied!';
                    elements.copyButton.style.background = '#28a745';
                    
                    setTimeout(() => {
                        elements.copyButton.textContent = originalText;
                        elements.copyButton.style.background = '';
                    }, 2000);
                } catch (err) {
                    // Fallback for older browsers
                    try {
                        const textarea = document.createElement('textarea');
                        textarea.value = historyText;
                        textarea.style.position = 'fixed';
                        textarea.style.opacity = '0';
                        document.body.appendChild(textarea);
                        textarea.select();
                        document.execCommand('copy');
                        document.body.removeChild(textarea);
                        
                        // Visual feedback for fallback
                        const originalText = elements.copyButton.textContent;
                        elements.copyButton.textContent = 'âœ… Copied!';
                        elements.copyButton.style.background = '#28a745';
                        
                        setTimeout(() => {
                            elements.copyButton.textContent = originalText;
                            elements.copyButton.style.background = '';
                        }, 2000);
                    } catch (fallbackErr) {
                        alert('Could not copy to clipboard. Please copy manually: ' + historyText);
                    }
                }
            }

            // Event listeners
            elements.drawButton.addEventListener('click', drawNextNumber);
            elements.resetButton.addEventListener('click', resetWithDoubleConfirm);
            elements.copyButton.addEventListener('click', copyHistoryToClipboard);

            // Keyboard shortcuts
            document.addEventListener('keydown', (e) => {
                // Ignore if modal is open or user is typing in an input
                if (document.querySelector('.modal.show') || 
                    e.target.tagName === 'INPUT' || 
                    e.target.tagName === 'TEXTAREA') {
                    return;
                }

                switch (e.key.toLowerCase()) {
                    case ' ':
                    case 'enter':
                        e.preventDefault();
                        if (!elements.drawButton.disabled) {
                            drawNextNumber();
                        }
                        break;
                    case 'r':
                        e.preventDefault();
                        resetWithDoubleConfirm();
                        break;
                    case 'c':
                        e.preventDefault();
                        copyHistoryToClipboard();
                        break;
                }
            });

            // Close modal on Escape key
            document.addEventListener('keydown', (e) => {
                if (e.key === 'Escape' && document.querySelector('.modal.show')) {
                    hideModal();
                }
            });

            // Handle modal events properly
            elements.confirmModal.addEventListener('hidden.bs.modal', () => {
                resetStep = 0;
                isResetting = false;
            });

            // Handle modal No button
            elements.modalNo.addEventListener('click', () => {
                modalInstance.hide();
            });

            // Handle modal close button
            elements.confirmModal.addEventListener('hide.bs.modal', () => {
                resetStep = 0;
                isResetting = false;
            });

            // Initialize the game on load
            document.addEventListener('DOMContentLoaded', () => {
                initializeGame();
            });

            // Also initialize immediately in case DOMContentLoaded already fired
            if (document.readyState === 'loading') {
                // DOM is still loading
            } else {
                // DOM is already loaded
                initializeGame();
            }
        })();
    </script>
</body>
</html>
