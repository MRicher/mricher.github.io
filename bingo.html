<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ðŸ¦œ Parrot Bingo Caller - Multi-Card System</title>
    <link href="https://cdnjs.cloudflare.com/ajax/libs/bootstrap/5.3.0/css/bootstrap.min.css" rel="stylesheet">
    <style>
        body {
            background: #f8f9fa;
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            height: 100vh;
            overflow: hidden;
        }

        .main-container {
            height: 100vh;
            display: flex;
            flex-direction: column;
        }

        /* Header */
        .header-section {
            background: linear-gradient(135deg, #007bff, #0056b3);
            color: white;
            padding: 0.5rem 0;
            text-align: center;
            box-shadow: 0 2px 4px rgba(0,0,0,0.1);
        }

        .header-section h1 {
            font-size: 1.5rem;
            font-weight: 700;
            margin: 0;
        }

        .header-section .subtitle {
            font-size: 0.9rem;
            opacity: 0.9;
            margin: 0;
        }

        /* Card links */
        .card-links-section {
            background: #e9ecef;
            border-bottom: 1px solid #dee2e6;
            padding: 0.4rem 0;
        }

        .card-link {
            background: #28a745;
            color: white;
            text-decoration: none;
            font-weight: 600;
            font-size: 0.75rem;
            padding: 0.3rem 0.6rem;
            border-radius: 4px;
            transition: all 0.2s ease;
        }

        .card-link:hover {
            background: #218838;
            color: white;
            transform: translateY(-1px);
        }

        /* Winner alerts */
        .winner-alerts {
            background: linear-gradient(45deg, #ffc107, #fd7e14);
            border-radius: 6px;
            animation: winnerPulse 2s infinite alternate;
        }

        .winner-alerts.show {
            display: block !important;
        }

        @keyframes winnerPulse {
            0% { transform: scale(1); }
            100% { transform: scale(1.02); }
        }

        .winner-card {
            background: white;
            border-radius: 4px;
            font-weight: bold;
            color: #495057;
            font-size: 0.8rem;
        }

        /* Game mode display */
        .game-mode-display {
            background: linear-gradient(135deg, #6f42c1, #5a32a3);
            color: white;
            border-radius: 6px;
            padding: 0.5rem;
            text-align: center;
            margin-bottom: 0.5rem;
        }

        .game-mode-title {
            font-size: 0.9rem;
            font-weight: 700;
            margin: 0;
        }

        .game-mode-desc {
            font-size: 0.7rem;
            opacity: 0.9;
            margin: 0;
        }

        /* Main content area */
        .content-area {
            flex: 1;
            padding: 0.5rem;
            overflow: hidden;
        }

        /* Current number display */
        .current-number-section {
            background: white;
            border: 2px solid #007bff;
            border-radius: 8px;
            text-align: center;
            padding: 0.8rem;
            position: relative;
            box-shadow: 0 2px 8px rgba(0,123,255,0.15);
        }

        .current-number {
            font-size: 3.5rem;
            font-weight: 900;
            color: #007bff;
            margin: 0.3rem 0;
            text-shadow: 0 2px 4px rgba(0,123,255,0.2);
        }

        .current-letter {
            font-size: 1.1rem;
            color: #6c757d;
            font-weight: 600;
            margin: 0;
        }

        .squawk-bubble {
            position: absolute;
            top: -8px;
            right: 10px;
            background: #ffc107;
            border-radius: 12px;
            padding: 0.2rem 0.6rem;
            font-size: 0.7rem;
            font-weight: bold;
            color: #212529;
            opacity: 0;
            transform: scale(0);
            transition: all 0.3s ease;
            box-shadow: 0 2px 4px rgba(0,0,0,0.2);
        }

        .squawk-bubble.show {
            opacity: 1;
            transform: scale(1);
        }

        /* Buttons */
        .control-buttons {
            gap: 0.5rem;
        }

        .btn-draw {
            background: #28a745;
            border: none;
            color: white;
            font-weight: 600;
            font-size: 0.9rem;
            padding: 0.6rem 1.2rem;
            border-radius: 6px;
            transition: all 0.2s ease;
        }

        .btn-draw:hover:not(:disabled) {
            background: #218838;
            transform: translateY(-1px);
            box-shadow: 0 4px 8px rgba(40,167,69,0.3);
        }

        .btn-draw:disabled {
            background: #6c757d;
            color: white;
        }

        .btn-copy {
            background: #6f42c1;
            border: none;
            color: white;
            font-weight: 600;
            font-size: 0.9rem;
            padding: 0.6rem 1.2rem;
            border-radius: 6px;
            transition: all 0.2s ease;
        }

        .btn-copy:hover {
            background: #5a32a3;
            transform: translateY(-1px);
            box-shadow: 0 4px 8px rgba(111,66,193,0.3);
        }

        /* Game mode buttons */
        .game-mode-buttons {
            display: grid;
            grid-template-columns: repeat(5, 1fr);
            gap: 0.2rem;
            margin-bottom: 0.5rem;
        }

        .btn-game {
            background: #17a2b8;
            border: none;
            color: white;
            font-weight: 600;
            font-size: 0.6rem;
            padding: 0.3rem 0.2rem;
            border-radius: 4px;
            transition: all 0.2s ease;
            text-align: center;
            line-height: 1.1;
        }

        .btn-game:hover {
            background: #138496;
            transform: translateY(-1px);
            color: white;
        }

        .btn-game.active {
            background: #ffc107;
            color: #212529;
            font-weight: 700;
        }

        /* Counters */
        .counter-card {
            background: white;
            border: 1px solid #dee2e6;
            border-radius: 6px;
            text-align: center;
            box-shadow: 0 1px 3px rgba(0,0,0,0.1);
            padding: 0.6rem;
        }

        .counter-number {
            font-size: 1.8rem;
            font-weight: 700;
            color: #007bff;
            margin: 0;
            line-height: 1;
        }

        .counter-label {
            font-size: 0.75rem;
            color: #6c757d;
            font-weight: 500;
            margin: 0;
            text-transform: uppercase;
        }

        /* BINGO Grid - Ultra compact like letsplaybingo.io */
        .bingo-board {
            background: white;
            border: 2px solid #007bff;
            border-radius: 8px;
            padding: 0.4rem;
            box-shadow: 0 2px 8px rgba(0,123,255,0.15);
        }

        .bingo-headers {
            display: grid;
            grid-template-columns: repeat(5, 1fr);
            gap: 2px;
            margin-bottom: 0.3rem;
        }

        .letter-header {
            background: #007bff;
            color: white;
            font-size: 1rem;
            font-weight: 700;
            text-align: center;
            padding: 0.3rem;
            border-radius: 3px;
        }

        .numbers-grid {
            display: grid;
            grid-template-columns: repeat(5, 1fr);
            gap: 1px;
        }

        .number-cell {
            background: #f8f9fa;
            color: #495057;
            font-size: 1rem;
            font-weight: 600;
            text-align: center;
            padding: 0.3rem;
            border-radius: 3px;
        }

        .number-cell.called {
            background: #28a745;
            color: white;
            font-weight: 700;
        }

        .number-cell.current {
            background: #ffc107;
            color: #212529;
            font-weight: 700;
            animation: currentPulse 1s infinite alternate;
            box-shadow: 0 0 8px rgba(255,193,7,0.8);
            z-index: 10;
            position: relative;
        }

        @keyframes currentPulse {
            0% { transform: scale(1); }
            100% { transform: scale(1.1); }
        }

        /* History panel */
        .history-panel {
            background: white;
            border: 1px solid #dee2e6;
            border-radius: 8px;
            height: 100%;
            display: flex;
            flex-direction: column;
            box-shadow: 0 1px 3px rgba(0,0,0,0.1);
        }

        .history-header {
            background: #f8f9fa;
            border-bottom: 1px solid #dee2e6;
            padding: 0.6rem;
            border-radius: 8px 8px 0 0;
        }

        .history-list {
            flex: 1;
            overflow-y: auto;
            padding: 0.4rem;
            max-height: calc(100vh - 400px);
        }

        .history-item {
            background: #f8f9fa;
            border-left: 3px solid #007bff;
            border-radius: 3px;
            padding: 0.3rem 0.6rem;
            margin-bottom: 0.2rem;
            font-size: 0.8rem;
        }

        .history-number {
            font-weight: 600;
            color: #007bff;
        }

        /* Game complete */
        .game-complete {
            background: linear-gradient(135deg, #28a745, #20c997);
            border-radius: 8px;
            color: white;
            text-align: center;
            padding: 1rem;
            box-shadow: 0 2px 8px rgba(40,167,69,0.3);
        }

        /* Ensure everything fits on screen */
        .row.main-row {
            height: calc(100vh - 120px);
            margin: 0;
        }

        .left-panel {
            height: 100%;
            display: flex;
            flex-direction: column;
        }

        .bingo-board {
            flex: 1;
            display: flex;
            flex-direction: column;
            min-height: 0;
        }

        .numbers-grid {
            flex: 1;
        }

        /* Screen reader only */
        .sr-only {
            position: absolute !important;
            width: 1px !important;
            height: 1px !important;
            padding: 0 !important;
            margin: -1px !important;
            overflow: hidden !important;
            clip: rect(0, 0, 0, 0) !important;
            white-space: nowrap !important;
            border: 0 !important;
        }

        /* Mobile responsive */
        @media (max-width: 768px) {
            .header-section h1 {
                font-size: 1.2rem;
            }
            
            .current-number {
                font-size: 2.5rem;
            }
            
            .number-cell {
                font-size: 0.35rem;
                height: 12px;
                min-height: 12px;
                max-height: 12px;
            }
            
            .letter-header {
                font-size: 0.7rem;
                padding: 0.2rem;
            }

            .row.main-row {
                height: calc(100vh - 140px);
            }

            .btn-game {
                font-size: 0.5rem;
                padding: 0.2rem 0.1rem;
            }
        }

        @media (max-width: 576px) {
            .number-cell {
                font-size: 0.3rem;
                height: 10px;
                min-height: 10px;
                max-height: 10px;
            }

            .letter-header {
                font-size: 0.6rem;
            }

            .current-number {
                font-size: 2rem;
            }

            .btn-game {
                font-size: 0.45rem;
            }
        }
    </style>
</head>
<body>
    <div class="main-container">
        <!-- Header -->
        <header class="header-section">
            <div class="container-fluid">
                <h1>ðŸ¦œ Parrot Partners Bingo Caller</h1>
            </div>
        </header>

        <!-- Card Links Section -->
        <div class="card-links-section">
            <div class="container-fluid">
                <div class="d-flex justify-content-center gap-2 flex-wrap align-items-center">
                    <span class="text-dark fw-bold small">ðŸŽ¯ Bingo Cards:</span>
                    <a href="parrt.html" target="_blank" class="card-link">PARRT</a>
                    <a href="sqawk.html" target="_blank" class="card-link">SQAWK</a>
                </div>
            </div>
        </div>

        <!-- Winner Alerts -->
        <div class="winner-alerts p-2 mx-2 d-none" id="winnerAlerts">
            <div class="text-center fw-bold mb-1">ðŸŽ‰ BINGO WINNERS! ðŸŽ‰</div>
            <div class="d-flex justify-content-center gap-2 flex-wrap" id="winnerList"></div>
        </div>

        <!-- Game Mode Display -->
        <div class="game-mode-display mx-2 d-none" id="gameModeDisplay">
            <div class="game-mode-title" id="gameModeTitle">Game Mode</div>
            <div class="game-mode-desc" id="gameModeDesc">Select a game mode to begin</div>
        </div>

        <!-- Main Content -->
        <div class="content-area">
            <div class="container-fluid h-100">
                <div class="row g-2 main-row">
                    <!-- Left Panel -->
                    <div class="col-lg-9">
                        <div class="left-panel">
                            <div class="row g-2 mb-2">
                                <!-- Current Number Display -->
                                <div class="col-md-6">
                                    <div class="current-number-section position-relative">
                                        <div class="squawk-bubble" id="squawkBubble">Squawk!</div>
                                        <div class="current-letter" id="currentLetter">Select a game mode!</div>
                                        <div class="current-number" id="currentNumber">--</div>
                                        <div id="announcer" class="sr-only" aria-live="assertive" aria-atomic="true"></div>
                                    </div>
                                </div>

                                <!-- Controls -->
                                <div class="col-md-3">
                                    <div class="d-flex flex-column gap-2 h-100">
                                        <button class="btn btn-draw flex-fill" id="drawButton" disabled>
                                            ðŸŽ¯ Draw Number
                                        </button>
                                        <button class="btn btn-copy flex-fill" id="copyButton">
                                            ðŸ“‹ Copy History
                                        </button>
                                    </div>
                                </div>

                                <!-- Counters -->
                                <div class="col-md-3">
                                    <div class="row g-1 h-100">
                                        <div class="col-6">
                                            <div class="counter-card h-100 d-flex flex-column justify-content-center">
                                                <div class="counter-number" id="drawnCount">0</div>
                                                <div class="counter-label">Drawn</div>
                                            </div>
                                        </div>
                                        <div class="col-6">
                                            <div class="counter-card h-100 d-flex flex-column justify-content-center">
                                                <div class="counter-number" id="remainingCount">75</div>
                                                <div class="counter-label">Left</div>
                                            </div>
                                        </div>
                                    </div>
                                </div>
                            </div>

                            <!-- Game Complete Message -->
                            <div id="gameComplete" class="game-complete mb-2 d-none">
                                <h6 class="mb-1">ðŸŽ‰ All Numbers Called!</h6>
                                <p class="mb-0 small">Game complete! Select a new game mode to start over.</p>
                            </div>

                            <!-- BINGO Board -->
                            <div class="bingo-board">
                                <div class="bingo-headers">
                                    <div class="letter-header">B</div>
                                    <div class="letter-header">I</div>
                                    <div class="letter-header">N</div>
                                    <div class="letter-header">G</div>
                                    <div class="letter-header">O</div>
                                </div>
                                <div class="numbers-grid" id="numbersGrid"></div>
                            </div>
                        </div>
                    </div>

                    <!-- Right Panel - Game Modes & History -->
                    <div class="col-lg-3">
                        <div class="history-panel">
                            <!-- Game Mode Buttons -->
                            <div class="p-2 border-bottom">
                                <h6 class="text-primary fw-bold mb-2 text-center">ðŸŽ® Game Modes</h6>
                                <div class="game-mode-buttons">
                                    <button class="btn-game" data-game="corners" title="4 Corners - Win with all 4 corner spots">
                                        4<br>Corners
                                    </button>
                                    <button class="btn-game" data-game="twolines" title="2 Lines - Win with any 2 complete lines">
                                        2<br>Lines
                                    </button>
                                    <button class="btn-game" data-game="postage" title="Postage Stamp - Win with any 2x2 corner square">
                                        Postage<br>Stamp
                                    </button>
                                    <button class="btn-game" data-game="inner" title="Inner Square - Win with the 3x3 center square">
                                        Inner<br>Square
                                    </button>
                                    <button class="btn-game" data-game="fullcard" title="Full Card - Win with complete card">
                                        Full<br>Card
                                    </button>
                                </div>
                            </div>

                            <!-- History Header -->
                            <div class="history-header">
                                <h6 class="text-primary fw-bold mb-0">ðŸ“œ Call History</h6>
                            </div>

                            <!-- History List (Scrollable) -->
                            <div class="history-list" id="historyList">
                                <p class="text-center text-muted small mb-0 p-2">
                                    Select a game mode and start calling numbers
                                </p>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Hidden help text for screen readers -->
    <div class="sr-only">
        <div id="drawHelp">Press Space or Enter to draw a number</div>
        <div id="copyHelp">Copy the call history to clipboard</div>
    </div>

    <script src="https://cdnjs.cloudflare.com/ajax/libs/bootstrap/5.3.0/js/bootstrap.bundle.min.js"></script>
    <script>
        // Protect against extension errors
        window.addEventListener('error', function(e) {
            // Only log extension errors, don't let them break our app
            if (e.filename && e.filename.includes('moz-extension://')) {
                console.warn('Browser extension error detected and ignored:', e.message);
                e.preventDefault();
                return false;
            }
        });

        (() => {
            'use strict';

            // Game state
            let remainingNumbers = [];
            let calledNumbers = [];
            let currentNumber = null;
            let winners = new Set();
            let currentGameMode = null;

            // Game mode definitions
            const gameModes = {
                corners: {
                    name: "4 Corners",
                    description: "Win with all 4 corner spots",
                    checkWin: (card) => {
                        const corners = [
                            card.B[0], card.B[4], card.O[0], card.O[4]
                        ];
                        return corners.every(num => num === 'FREE' || calledNumbers.includes(num));
                    }
                },
                twolines: {
                    name: "2 Lines",
                    description: "Win with any 2 complete lines (rows, columns, or diagonals)",
                    checkWin: (card) => {
                        const LETTERS = ['B', 'I', 'N', 'G', 'O'];
                        let linesComplete = 0;

                        // Check rows
                        for (let row = 0; row < 5; row++) {
                            let rowComplete = true;
                            for (let col = 0; col < 5; col++) {
                                const cellValue = card[LETTERS[col]][row];
                                if (cellValue !== 'FREE' && !calledNumbers.includes(cellValue)) {
                                    rowComplete = false;
                                    break;
                                }
                            }
                            if (rowComplete) linesComplete++;
                        }

                        // Check columns
                        for (let col = 0; col < 5; col++) {
                            let colComplete = true;
                            for (let row = 0; row < 5; row++) {
                                const cellValue = card[LETTERS[col]][row];
                                if (cellValue !== 'FREE' && !calledNumbers.includes(cellValue)) {
                                    colComplete = false;
                                    break;
                                }
                            }
                            if (colComplete) linesComplete++;
                        }

                        // Check diagonals
                        let diagonal1Complete = true;
                        for (let i = 0; i < 5; i++) {
                            const cellValue = card[LETTERS[i]][i];
                            if (cellValue !== 'FREE' && !calledNumbers.includes(cellValue)) {
                                diagonal1Complete = false;
                                break;
                            }
                        }
                        if (diagonal1Complete) linesComplete++;

                        let diagonal2Complete = true;
                        for (let i = 0; i < 5; i++) {
                            const cellValue = card[LETTERS[i]][4 - i];
                            if (cellValue !== 'FREE' && !calledNumbers.includes(cellValue)) {
                                diagonal2Complete = false;
                                break;
                            }
                        }
                        if (diagonal2Complete) linesComplete++;

                        return linesComplete >= 2;
                    }
                },
                postage: {
                    name: "Postage Stamp",
                    description: "Win with any 2x2 corner square",
                    checkWin: (card) => {
                        const LETTERS = ['B', 'I', 'N', 'G', 'O'];
                        
                        // Check all four 2x2 corners
                        const corners = [
                            // Top-left
                            [[0,0], [0,1], [1,0], [1,1]],
                            // Top-right
                            [[0,3], [0,4], [1,3], [1,4]],
                            // Bottom-left
                            [[3,0], [3,1], [4,0], [4,1]],
                            // Bottom-right
                            [[3,3], [3,4], [4,3], [4,4]]
                        ];

                        return corners.some(corner => {
                            return corner.every(([col, row]) => {
                                const cellValue = card[LETTERS[col]][row];
                                return cellValue === 'FREE' || calledNumbers.includes(cellValue);
                            });
                        });
                    }
                },
                inner: {
                    name: "Inner Square",
                    description: "Win with the 3x3 center square (9 spots including FREE)",
                    checkWin: (card) => {
                        const LETTERS = ['B', 'I', 'N', 'G', 'O'];
                        
                        // Check the 3x3 inner square (columns 1-3, rows 1-3)
                        for (let col = 1; col <= 3; col++) {
                            for (let row = 1; row <= 3; row++) {
                                const cellValue = card[LETTERS[col]][row];
                                if (cellValue !== 'FREE' && !calledNumbers.includes(cellValue)) {
                                    return false;
                                }
                            }
                        }
                        return true;
                    }
                },
                fullcard: {
                    name: "Full Card",
                    description: "Win with complete card (all 25 spots including FREE)",
                    checkWin: (card) => {
                        const LETTERS = ['B', 'I', 'N', 'G', 'O'];
                        
                        for (let col = 0; col < 5; col++) {
                            for (let row = 0; row < 5; row++) {
                                const cellValue = card[LETTERS[col]][row];
                                if (cellValue !== 'FREE' && !calledNumbers.includes(cellValue)) {
                                    return false;
                                }
                            }
                        }
                        return true;
                    }
                }
            };

            // Bingo card definitions with unique 5-letter IDs
            const bingoCards = {
                'PARRT': {
                    B: [7, 14, 2, 9, 12],
                    I: [22, 29, 16, 25, 18],
                    N: [31, 44, 'FREE', 33, 41],
                    G: [56, 49, 52, 47, 60],
                    O: [61, 74, 67, 71, 63]
                },
                'SQAWK': {
                    B: [5, 11, 8, 15, 3],
                    I: [28, 17, 24, 30, 19],
                    N: [34, 45, 'FREE', 38, 32],
                    G: [58, 51, 46, 54, 59],
                    O: [65, 72, 68, 75, 64]
                }
            };

            // DOM elements
            const elements = {
                drawButton: document.getElementById('drawButton'),
                copyButton: document.getElementById('copyButton'),
                currentNumber: document.getElementById('currentNumber'),
                currentLetter: document.getElementById('currentLetter'),
                drawnCount: document.getElementById('drawnCount'),
                remainingCount: document.getElementById('remainingCount'),
                historyList: document.getElementById('historyList'),
                numbersGrid: document.getElementById('numbersGrid'),
                gameComplete: document.getElementById('gameComplete'),
                squawkBubble: document.getElementById('squawkBubble'),
                announcer: document.getElementById('announcer'),
                winnerAlerts: document.getElementById('winnerAlerts'),
                winnerList: document.getElementById('winnerList'),
                gameModeDisplay: document.getElementById('gameModeDisplay'),
                gameModeTitle: document.getElementById('gameModeTitle'),
                gameModeDesc: document.getElementById('gameModeDesc')
            };

            // Initialize the game
            function initializeGame() {
                remainingNumbers = [];
                calledNumbers = [];
                currentNumber = null;
                winners.clear();

                // Fill remaining numbers array with 1-75
                for (let i = 1; i <= 75; i++) {
                    remainingNumbers.push(i);
                }

                // Reset UI
                elements.currentNumber.textContent = '--';
                elements.currentLetter.textContent = currentGameMode ? 'Ready to play!' : 'Select a game mode!';
                elements.gameComplete.classList.add('d-none');
                elements.drawButton.disabled = !currentGameMode;
                elements.winnerAlerts.classList.remove('show');
                elements.winnerAlerts.classList.add('d-none');
                
                updateCounters();
                updateHistoryUI();
                createNumbersGrid();

                // Broadcast reset to all card windows
                broadcastToCards({ type: 'reset', gameMode: currentGameMode });
            }

            // Set game mode
            function setGameMode(mode) {
                currentGameMode = mode;
                const gameMode = gameModes[mode];
                
                // Update game mode display
                elements.gameModeTitle.textContent = gameMode.name;
                elements.gameModeDesc.textContent = gameMode.description;
                elements.gameModeDisplay.classList.remove('d-none');
                
                // Update active button
                document.querySelectorAll('.btn-game').forEach(btn => {
                    btn.classList.remove('active');
                });
                document.querySelector(`[data-game="${mode}"]`).classList.add('active');
                
                // Reset and start new game
                initializeGame();
                
                // Broadcast game mode to cards
                broadcastToCards({ 
                    type: 'gameMode', 
                    mode: mode,
                    name: gameMode.name,
                    description: gameMode.description
                });
            }

            // Get letter group for a number
            function getLetterForNumber(num) {
                if (num >= 1 && num <= 15) return 'B';
                if (num >= 16 && num <= 30) return 'I';
                if (num >= 31 && num <= 45) return 'N';
                if (num >= 46 && num <= 60) return 'G';
                if (num >= 61 && num <= 75) return 'O';
                return '';
            }

            // Check for bingo on a specific card using current game mode
            function checkBingo(cardId) {
                if (!currentGameMode) return false;
                
                const card = bingoCards[cardId];
                if (!card) return false;

                return gameModes[currentGameMode].checkWin(card);
            }

            // Check all cards for winners
            function checkAllCardsForWinners() {
                if (!currentGameMode) return;
                
                const newWinners = [];
                
                Object.keys(bingoCards).forEach(cardId => {
                    if (!winners.has(cardId) && checkBingo(cardId)) {
                        winners.add(cardId);
                        newWinners.push(cardId);
                    }
                });

                if (newWinners.length > 0) {
                    updateWinnerDisplay();
                    // Announce new winners
                    elements.announcer.textContent = `BINGO! Winners: ${Array.from(winners).join(', ')}`;
                }
            }

            // Update winner display
            function updateWinnerDisplay() {
                if (winners.size > 0) {
                    elements.winnerList.innerHTML = Array.from(winners).map(cardId => 
                        `<div class="winner-card p-1 px-2">Card ${cardId}</div>`
                    ).join('');
                    elements.winnerAlerts.classList.add('show');
                    elements.winnerAlerts.classList.remove('d-none');
                } else {
                    elements.winnerAlerts.classList.remove('show');
                    elements.winnerAlerts.classList.add('d-none');
                }
            }

            // Broadcast message to all card windows
            function broadcastToCards(message) {
                try {
                    // Use a simple variable to communicate with card windows
                    window.bingoCallerMessage = { ...message, timestamp: Date.now() };
                    
                    // Clean up after a short delay
                    setTimeout(() => {
                        if (window.bingoCallerMessage && window.bingoCallerMessage.timestamp === message.timestamp) {
                            delete window.bingoCallerMessage;
                        }
                    }, 1000);
                } catch (error) {
                    console.warn('Could not broadcast to cards:', error);
                }
            }

            // Draw the next number
            function drawNextNumber() {
                if (remainingNumbers.length === 0 || !currentGameMode) return;

                // Prevent double clicks
                elements.drawButton.disabled = true;

                // Remove current highlight
                if (currentNumber) {
                    const prevCell = document.querySelector(`[data-number="${currentNumber}"]`);
                    if (prevCell) {
                        prevCell.classList.remove('current');
                    }
                }

                // Pick random number from remaining
                const randomIndex = Math.floor(Math.random() * remainingNumbers.length);
                const drawnNumber = remainingNumbers.splice(randomIndex, 1)[0];
                
                currentNumber = drawnNumber;
                calledNumbers.unshift(drawnNumber); // Add to beginning for reverse chronological order

                const letter = getLetterForNumber(drawnNumber);
                
                // Update display
                elements.currentNumber.textContent = drawnNumber;
                elements.currentLetter.textContent = `${letter} - ${drawnNumber}`;

                // Announce for screen readers
                elements.announcer.textContent = `${letter} ${drawnNumber}`;

                // Show squawk bubble
                showSquawk();

                // Update UI
                updateCounters();
                updateHistoryUI();
                updateGridUI();

                // Broadcast to card windows
                broadcastToCards({ 
                    type: 'numberCalled', 
                    number: drawnNumber, 
                    letter: letter,
                    calledNumbers: [...calledNumbers],
                    gameMode: currentGameMode
                });

                // Check for winners
                setTimeout(() => {
                    checkAllCardsForWinners();
                }, 500);

                // Check if game is complete
                if (remainingNumbers.length === 0) {
                    elements.gameComplete.classList.remove('d-none');
                    elements.drawButton.disabled = true;
                } else {
                    // Re-enable button after short delay to prevent spam
                    setTimeout(() => {
                        elements.drawButton.disabled = false;
                    }, 500);
                }
            }

            // Show squawk animation
            function showSquawk() {
                const messages = ['Squawk!', 'Tweet!', 'Chirp!'];
                const randomMessage = messages[Math.floor(Math.random() * messages.length)];
                elements.squawkBubble.textContent = randomMessage;
                elements.squawkBubble.classList.add('show');
                setTimeout(() => {
                    elements.squawkBubble.classList.remove('show');
                }, 2000);
            }

            // Update counters
            function updateCounters() {
                elements.drawnCount.textContent = calledNumbers.length;
                elements.remainingCount.textContent = remainingNumbers.length;
            }

            // Update history display
            function updateHistoryUI() {
                if (calledNumbers.length === 0) {
                    elements.historyList.innerHTML = `
                        <p class="text-center text-muted small mb-0 p-2">
                            ${currentGameMode ? 'Numbers will appear here as they\'re called' : 'Select a game mode and start calling numbers'}
                        </p>
                    `;
                    return;
                }

                elements.historyList.innerHTML = calledNumbers.map(num => {
                    const letter = getLetterForNumber(num);
                    return `
                        <div class="history-item">
                            <span class="history-number">${letter}-${num}</span>
                        </div>
                    `;
                }).join('');
            }

            // Create the numbers grid
            function createNumbersGrid() {
                elements.numbersGrid.innerHTML = '';
                
                for (let i = 1; i <= 75; i++) {
                    const cell = document.createElement('div');
                    cell.className = 'number-cell';
                    cell.textContent = i;
                    cell.setAttribute('data-number', i);
                    cell.setAttribute('aria-label', `${getLetterForNumber(i)} ${i}`);
                    elements.numbersGrid.appendChild(cell);
                }
            }

            // Update grid visual state
            function updateGridUI() {
                // Mark called numbers
                calledNumbers.forEach(num => {
                    const cell = document.querySelector(`[data-number="${num}"]`);
                    if (cell && !cell.classList.contains('called')) {
                        cell.classList.add('called');
                    }
                });

                // Highlight current number
                if (currentNumber) {
                    const currentCell = document.querySelector(`[data-number="${currentNumber}"]`);
                    if (currentCell) {
                        currentCell.classList.add('current');
                        // Remove current highlight after animation
                        setTimeout(() => {
                            if (currentCell.classList.contains('current')) {
                                currentCell.classList.remove('current');
                            }
                        }, 3000);
                    }
                }
            }

            // Copy history to clipboard
            async function copyHistoryToClipboard() {
                if (calledNumbers.length === 0) {
                    alert('No numbers have been called yet!');
                    return;
                }

                const historyText = calledNumbers.map(num => {
                    const letter = getLetterForNumber(num);
                    return `${letter}-${num}`;
                }).join(', ');

                try {
                    await navigator.clipboard.writeText(historyText);
                    
                    // Visual feedback
                    const originalText = elements.copyButton.textContent;
                    elements.copyButton.textContent = 'âœ… Copied!';
                    elements.copyButton.style.background = '#28a745';
                    
                    setTimeout(() => {
                        elements.copyButton.textContent = originalText;
                        elements.copyButton.style.background = '';
                    }, 2000);
                } catch (err) {
                    // Fallback for older browsers
                    try {
                        const textarea = document.createElement('textarea');
                        textarea.value = historyText;
                        textarea.style.position = 'fixed';
                        textarea.style.opacity = '0';
                        document.body.appendChild(textarea);
                        textarea.select();
                        document.execCommand('copy');
                        document.body.removeChild(textarea);
                        
                        // Visual feedback for fallback
                        const originalText = elements.copyButton.textContent;
                        elements.copyButton.textContent = 'âœ… Copied!';
                        elements.copyButton.style.background = '#28a745';
                        
                        setTimeout(() => {
                            elements.copyButton.textContent = originalText;
                            elements.copyButton.style.background = '';
                        }, 2000);
                    } catch (fallbackErr) {
                        alert('Could not copy to clipboard. Please copy manually: ' + historyText);
                    }
                }
            }

            // Event listeners
            elements.drawButton.addEventListener('click', drawNextNumber);
            elements.copyButton.addEventListener('click', copyHistoryToClipboard);

            // Game mode button event listeners
            document.addEventListener('click', (e) => {
                if (e.target.classList.contains('btn-game')) {
                    const gameMode = e.target.getAttribute('data-game');
                    setGameMode(gameMode);
                }
            });

            // Keyboard shortcuts
            document.addEventListener('keydown', (e) => {
                // Ignore if user is typing in an input
                if (e.target.tagName === 'INPUT' || e.target.tagName === 'TEXTAREA') {
                    return;
                }

                switch (e.key.toLowerCase()) {
                    case ' ':
                    case 'enter':
                        e.preventDefault();
                        if (!elements.drawButton.disabled) {
                            drawNextNumber();
                        }
                        break;
                    case 'c':
                        e.preventDefault();
                        copyHistoryToClipboard();
                        break;
                    case '1':
                        e.preventDefault();
                        setGameMode('corners');
                        break;
                    case '2':
                        e.preventDefault();
                        setGameMode('twolines');
                        break;
                    case '3':
                        e.preventDefault();
                        setGameMode('postage');
                        break;
                    case '4':
                        e.preventDefault();
                        setGameMode('inner');
                        break;
                    case '5':
                        e.preventDefault();
                        setGameMode('fullcard');
                        break;
                }
            });

            // Initialize the game on load
            document.addEventListener('DOMContentLoaded', () => {
                initializeGame();
            });

            // Also initialize immediately in case DOMContentLoaded already fired
            if (document.readyState === 'loading') {
                // DOM is still loading
            } else {
                // DOM is already loaded
                initializeGame();
            }
        })();
    </script>
</body>
</html>
