<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Closest RCMP Detachment</title>
    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" />
    <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
    <style>
        body {
            font-family: Arial, sans-serif;
            margin: 0;
            padding: 20px;
            background: #f5f5f5;
        }
        .container {
            background: white;
            padding: 30px;
            border-radius: 8px;
            box-shadow: 0 2px 10px rgba(0,0,0,0.1);
            max-width: 1200px;
            margin: 0 auto;
        }
        h1 {
            color: #333;
            margin-bottom: 20px;
        }
        .result {
            margin-top: 20px;
            padding: 20px;
            background: #e8f5e9;
            border-radius: 5px;
            font-size: 18px;
        }
        .loading {
            color: #666;
            font-style: italic;
        }
        .error {
            background: #ffebee;
            color: #c62828;
        }
        button {
            background: #1976d2;
            color: white;
            border: none;
            padding: 12px 24px;
            border-radius: 5px;
            cursor: pointer;
            font-size: 16px;
        }
        button:hover {
            background: #1565c0;
        }
        button:disabled {
            background: #ccc;
            cursor: not-allowed;
        }
        .input-group {
            margin-top: 20px;
            padding: 20px;
            background: #f9f9f9;
            border-radius: 5px;
            position: relative;
        }
        .input-group label {
            display: block;
            margin-bottom: 8px;
            font-weight: bold;
            color: #333;
        }
        .input-group input {
            width: 100%;
            padding: 10px;
            border: 1px solid #ddd;
            border-radius: 4px;
            font-size: 16px;
            box-sizing: border-box;
        }
        .input-group button {
            margin-top: 10px;
        }
        .divider {
            text-align: center;
            margin: 20px 0;
            color: #999;
            position: relative;
        }
        .divider:before,
        .divider:after {
            content: "";
            position: absolute;
            top: 50%;
            width: 45%;
            height: 1px;
            background: #ddd;
        }
        .divider:before {
            left: 0;
        }
        .divider:after {
            right: 0;
        }
        .suggestions {
            position: absolute;
            top: 100%;
            left: 20px;
            right: 20px;
            background: white;
            border: 1px solid #ddd;
            border-top: none;
            border-radius: 0 0 4px 4px;
            max-height: 200px;
            overflow-y: auto;
            z-index: 1000;
            display: none;
        }
        .suggestions.show {
            display: block;
        }
        .suggestion-item {
            padding: 10px;
            cursor: pointer;
            border-bottom: 1px solid #eee;
        }
        .suggestion-item:hover {
            background: #f5f5f5;
        }
        .suggestion-item:last-child {
            border-bottom: none;
        }
        #map {
            height: 600px;
            margin-top: 20px;
            border-radius: 5px;
            display: none;
        }
        #map.show {
            display: block;
        }
    </style>
</head>
<body>
    <div class="container">
        <h1>Find Closest RCMP Detachment</h1>
        <button id="findBtn" onclick="findClosest()">Use My Current Location</button>
        
        <div class="divider">OR</div>
        
        <div class="input-group">
            <label for="addressInput">Enter an address:</label>
            <input type="text" id="addressInput" placeholder="e.g., 100 Main Street, Whitehorse" />
            <div id="suggestions" class="suggestions"></div>
            <button onclick="findByAddress()">Find from Address</button>
        </div>
        
        <div id="result"></div>
        <div id="map"></div>
    </div>

    <script>
        const detachments = [
            // Alberta
            { name: "Airdrie Detachment", lat: 51.303273853596146, lon: -113.98911652454072 },
            { name: "Athabasca Detachment", lat: 54.71726195561294, lon: -113.25776998428134 },
            { name: "Banff Detachment", lat: 51.18066374319154, lon: -115.57602648219184 },
            { name: "Barrhead Detachment", lat: 54.130858763649194, lon: -114.39722134605145 },
            { name: "Bashaw Detachment", lat: 52.5859987982551, lon: -112.97413008682108 },
            { name: "Bassano Detachment", lat: 50.792383540994464, lon: -112.45252221759333 },
            { name: "Beaumont Detachment", lat: 53.33867065059248, lon: -113.42077451424204 },
            { name: "Beaverlodge Detachment", lat: 55.21179501290534, lon: -119.42467149369631 },
            { name: "Beiseker Detachment", lat: 51.38673562943297, lon: -113.54144073219953 },
            { name: "Blackfalds Detachment", lat: 52.374788525827576, lon: -113.81107604835903 },
            { name: "Bonnyville Detachment", lat: 54.271912094997, lon: -110.72926256364498 },
            { name: "Bow Island Detachment", lat: 49.87210188271511, lon: -111.37188658349503 },
            { name: "Boyle Detachment", lat: 54.58755482344513, lon: -112.80847152589793 },
            { name: "Brooks Detachment", lat: 50.568427815459, lon: -111.90195260375404 },
            { name: "Camrose Detachment", lat: 53.018481224044, lon: -112.85265092523251 },
            { name: "Canmore Detachment", lat: 51.07621476581553, lon: -115.3218378391914 },
            { name: "Cardston Detachment", lat: 49.201688873776845, lon: -113.30217936171772 },
            { name: "Chateh Detachment", lat: 58.697642167949645, lon: -118.69568889768469 },
            { name: "Chestermere Detachment", lat: 51.05088565778684, lon: -113.81444268442279 },
            { name: "Claresholm Detachment", lat: 50.023002337054116, lon: -113.58936886590853 },
            { name: "Coaldale Detachment", lat: 49.7312398145596, lon: -112.59866134416352 },
            { name: "Cochrane Detachment", lat: 51.20498171919771, lon: -114.51241468765161 },
            { name: "Cold Lake Detachment", lat: 54.41101556400877, lon: -110.21516048659875 },
            { name: "Consort Detachment", lat: 52.00880482535351, lon: -110.77047694576258 },
            { name: "Coronation Detachment", lat: 52.092967428711034, lon: -111.44876736665128 },
            { name: "Crowsnest Pass Detachment", lat: 49.610030398105074, lon: -114.44179663139109 },
            { name: "Devon Detachment", lat: 53.363395918399846, lon: -113.7298101162529 },
            { name: "Didsbury Detachment", lat: 51.66567851325636, lon: -114.13458978396775 },
            { name: "Drayton Valley Detachment", lat: 53.22560606510534, lon: -114.98553757885001 },
            { name: "Drumheller Detachment", lat: 51.46584009125613, lon: -112.70689483035571 },
            { name: "Edmonton International Airport Detachment", lat: 53.308561828039, lon: -113.58476024319555 },
            { name: "Edson Detachment", lat: 53.577652061599004, lon: -116.44152147648484 },
            { name: "Elk Point Detachment", lat: 53.89370142499588, lon: -110.90678653330832 },
            { name: "Evansburg Detachment", lat: 53.603421633716124, lon: -115.0199913063463 },
            { name: "Fairview Detachment", lat: 56.06611118472666, lon: -118.39258223256601 },
            { name: "Faust Detachment", lat: 55.31507223847873, lon: -115.64222777171861 },
            { name: "Fort Chipewyan Detachment", lat: 58.71474195458482, lon: -111.14627526455064 },
            { name: "Fort Macleod Detachment", lat: 49.723739596486354, lon: -113.39111858417625 },
            { name: "Fort Saskatchewan Detachment", lat: 53.68324010489931, lon: -113.23873992405382 },
            { name: "Fort Vermilion Detachment", lat: 58.38337454035455, lon: -116.0041624045796 },
            { name: "Fox Creek Detachment", lat: 54.39687917446109, lon: -116.80777495519433 },
            { name: "Fox Lake Detachment", lat: 58.46389376457064, lon: -114.53482017701772 },
            { name: "Gleichen Detachment", lat: 50.86783130757046, lon: -113.05282870069641 },
            { name: "Grande Cache Detachment", lat: 53.89194386136823, lon: -119.11467069888987 },
            { name: "Grande Prairie City Detachment", lat: 55.17272610417535, lon: -118.79232732877797 },
            { name: "Grande Prairie Rural Detachment", lat: 55.168390637887825, lon: -118.81469971051656 },
            { name: "Grimshaw Detachment", lat: 56.189616774397415, lon: -117.60798539108363 },
            { name: "Hanna Detachment", lat: 51.6443833702485, lon: -111.92697140876045 },
            { name: "High Level Detachment", lat: 58.51944774118796, lon: -117.13725983767014 },
            { name: "High Prairie Detachment", lat: 55.43369630098711, lon: -116.50528632511326 },
            { name: "High River Detachment", lat: 50.57248306800287, lon: -113.84722090557311 },
            { name: "Hinton Detachment", lat: 53.397894655177176, lon: -117.57573368328214 },
            { name: "Innisfail Detachment", lat: 52.02644247348459, lon: -113.93979917359282 },
            { name: "Jasper Detachment", lat: 52.87740346184815, lon: -118.08836735316875 },
            { name: "Killam Detachment", lat: 52.78910842224297, lon: -111.85521217311947 },
            { name: "Kitscoty Detachment", lat: 53.3421890878544, lon: -110.33433837843607 },
            { name: "Lac La Biche Detachment", lat: 54.77189151938715, lon: -111.96303036705501 },
            { name: "Lake Louise Detachment", lat: 51.42412616627414, lon: -116.17568715756957 },
            { name: "Langdon Detachment", lat: 50.97258017581341, lon: -113.68128728384069 },
            { name: "Leduc Detachment", lat: 53.253633981221306, lon: -113.54383281337388 },
            { name: "Lloydminster Detachment", lat: 53.278496135702284, lon: -110.00850336774576 },
            { name: "Manning Detachment", lat: 56.92739669083205, lon: -117.62403628271994 },
            { name: "Maskwacis (Hobbema) Detachment", lat: 52.81481110499712, lon: -113.43707604126375 },
            { name: "Mayerthorpe Detachment", lat: 53.95023157277253, lon: -115.14182342382956 },
            { name: "McLennan Detachment", lat: 55.71183546518091, lon: -116.8922166145581 },
            { name: "Milk River Detachment", lat: 49.153002888231505, lon: -112.08707569531838 },
            { name: "Morinville Detachment", lat: 53.80399148140562, lon: -113.65601398910746 },
            { name: "Nanton Detachment", lat: 50.34429836059973, lon: -113.77878885937847 },
            { name: "Okotoks Detachment", lat: 50.71948155331825, lon: -113.98077955656277 },
            { name: "Olds Detachment", lat: 51.79357148684576, lon: -114.1328222908999 },
            { name: "Oyen Detachment", lat: 51.35312655770945, lon: -110.4770989883649 },
            { name: "Parkland Detachment", lat: 53.53920139352148, lon: -113.93544573895916 },
            { name: "Peace River Detachment", lat: 56.241435765736696, lon: -117.2925130457973 },
            { name: "Picture Butte Detachment", lat: 49.87418555241572, lon: -112.7852546719084 },
            { name: "Piikani Nation Detachment", lat: 49.545946594065725, lon: -113.74858989922346 },
            { name: "Pincher Creek Detachment", lat: 49.496042210561775, lon: -113.9422106967213 },
            { name: "Ponoka Detachment", lat: 52.67738337287672, lon: -113.5804330746469 },
            { name: "Provost Detachment", lat: 52.355785973875975, lon: -110.26580362227442 },
            { name: "Raymond / Magrath Detachment", lat: 49.46585078675318, lon: -112.66747407217774 },
            { name: "Red Deer City Detachment", lat: 52.2652255568102, lon: -113.8161728396934 },
            { name: "Red Earth Creek Detachment", lat: 56.53915703268398, lon: -115.30695549221764 },
            { name: "Redcliff Detachment", lat: 50.072969812721595, lon: -110.77737671727753 },
            { name: "Redwater Detachment", lat: 53.949444063805075, lon: -113.12367350599096 },
            { name: "Rimbey Detachment", lat: 52.64138990629957, lon: -114.23768391636322 },
            { name: "Rocky Mountain House Detachment", lat: 52.36742328897728, lon: -114.90962746338175 },
            { name: "Slave Lake Detachment", lat: 55.27577458565401, lon: -114.76061441556445 },
            { name: "Smoky Lake Detachment", lat: 54.110233067042046, lon: -112.48171957323557 },
            { name: "Spirit River Detachment", lat: 55.777567162592035, lon: -118.83646784129125 },
            { name: "St. Albert Detachment", lat: 53.64956119588857, lon: -113.61814105901108 },
            { name: "St. Paul Detachment", lat: 53.99084956768891, lon: -111.31084314419337 },
            { name: "Stettler Detachment", lat: 52.3179287956324, lon: -112.72026542400921 },
            { name: "Strathcona County Detachment", lat: 53.550916846562885, lon: -113.29756732979185 },
            { name: "Strathmore Detachment", lat: 51.03953653761791, lon: -113.40211540466395 },
            { name: "Sundre Detachment", lat: 51.80669084377711, lon: -114.6354506962633 },
            { name: "Swan Hills Detachment", lat: 54.71797139597323, lon: -115.40476870193744 },
            { name: "Sylvan Lake Detachment", lat: 52.296280608760654, lon: -114.09811358238618 },
            { name: "Taber-Vauxhall Detachment", lat: 49.774835834985694, lon: -112.15954166152372 },
            { name: "Thorsby Detachment", lat: 53.23239587049886, lon: -114.04891199179427 },
            { name: "Three Hills Detachment", lat: 51.70672237800704, lon: -113.26434155241218 },
            { name: "Tofield Detachment", lat: 53.3720589482857, lon: -112.66238029626554 },
            { name: "Turner Valley Detachment", lat: 50.67713050696378, lon: -114.27840328650707 },
            { name: "Two Hills Detachment", lat: 53.713121021268975, lon: -111.74326671236395 },
            { name: "Valleyview Detachment", lat: 55.06798201700434, lon: -117.27008496663866 },
            { name: "Vegreville Detachment", lat: 53.50463897616393, lon: -112.08176848761873 },
            { name: "Vermilion Detachment", lat: 53.3537558692243, lon: -110.85651080762563 },
            { name: "Viking Detachment", lat: 53.095872232968425, lon: -111.78360065635312 },
            { name: "Vulcan Detachment", lat: 50.39647096439108, lon: -113.25478860706927 },
            { name: "Wabasca Detachment", lat: 55.96443775190233, lon: -113.82733899267029 },
            { name: "Wainwright Detachment", lat: 52.83576527464241, lon: -110.8626916540124 },
            // Manitoba
            { name: "Emerson Detachment", lat: 49.00431242910584, lon: -97.23145500233318 },
            { name: "Manitoba RCMP Headquarters", lat: 49.88464661489753, lon: -97.17894572078933 },
            { name: "Sprague Detachment", lat: 49.04200451839544, lon: -95.63977027037647 },
            { name: "Killarney Detachment", lat: 49.178069267313525, lon: -99.66264168319535 },
            { name: "Deloraine Detachment", lat: 49.186793007186736, lon: -100.49366062984757 },
            { name: "Morden Detachment", lat: 49.19264240849788, lon: -98.11377543000269 },
            { name: "Boissevain Detachment", lat: 49.23513724499894, lon: -100.06157410487377 },
            { name: "Manitou Detachment", lat: 49.236091340691736, lon: -98.53748712075893 },
            { name: "Melita Detachment", lat: 49.27397868790059, lon: -100.98532659258399 },
            { name: "Morris Detachment", lat: 49.353098387559974, lon: -97.35992547686516 },
            { name: "St. Pierre-Jolys Detachment", lat: 49.44637725456496, lon: -96.98554091478302 },
            { name: "Carman Detachment", lat: 49.50122271009111, lon: -98.00106091668293 },
            { name: "Steinbach Detachment", lat: 49.539334679554344, lon: -96.6895419731782 },
            { name: "Reston Detachment", lat: 49.56068300135329, lon: -101.09973845039241 },
            { name: "Treherne Detachment", lat: 49.626623701441716, lon: -98.69713680239057 },
            { name: "Souris Detachment", lat: 49.6224373120051, lon: -100.25615162394953 },
            { name: "Falcon Beach Detachment", lat: 49.689703338014574, lon: -95.32900796538581 },
            { name: "Virden Detachment", lat: 49.849320125119064, lon: -100.94006083704822 },
            { name: "Brandon Detachment", lat: 49.86481836739249, lon: -99.91528716293392 },
            { name: "Carberry Detachment", lat: 49.87370054806593, lon: -99.35840177131546 },
            { name: "Headingley Detachment", lat: 49.875167983585264, lon: -97.40971535368632 },
            { name: "Oakbank Detachment", lat: 49.94175936611877, lon: -96.844071722572 },
            { name: "Whitemouth Detachment", lat: 49.956276458336255, lon: -95.97606316406075 },
            { name: "Red River North Detachment", lat: 49.97088134110909, lon: -97.0101488734608 },
            { name: "Portage La Prairie Detachment", lat: 49.975317460476944, lon: -98.28489993811397 },
            { name: "Beausejour Detachment", lat: 50.06307401867567, lon: -96.5138112777051 },
            { name: "Minnedosa Detachment", lat: 50.242841856535094, lon: -99.84060776854534 },
            { name: "Stonewall Detachment", lat: 50.13073804317657, lon: -97.32723231775424 },
            { name: "Pinawa Detachment", lat: 50.14837774930696, lon: -95.87493806654903 },
            { name: "Selkirk Detachment", lat: 50.15724791075653, lon: -96.89837342594437 },
            { name: "Hamiota Detachment", lat: 50.181288996091006, lon: -100.59532010013845 },
            { name: "Neepawa Detachment", lat: 50.22946803581436, lon: -99.47437937552289 },
            { name: "Lac du Bonnet Detachment", lat: 50.255161742508946, lon: -96.06706429725335 },
            { name: "Shoal Lake Detachment", lat: 50.43697156871613, lon: -100.58774439452813 },
            { name: "Elphinstone Detachment", lat: 50.53262284853499, lon: -100.3199657183866 },
            { name: "Grand Marais Detachment", lat: 50.533916167776724, lon: -96.58499579744098 },
            { name: "Powerview Detachment", lat: 50.56784119624821, lon: -96.19767660259834 },
            { name: "Amaranth Detachment", lat: 50.584486037922936, lon: -98.73175529620904 },
            { name: "Gimli Detachment", lat: 50.633792502655766, lon: -96.99596026530122 },
            { name: "Lundar Detachment", lat: 50.696770094839366, lon: -98.03378755445057 },
            { name: "Russell Detachment", lat: 50.7743880941208, lon: -101.2869748036054 },
            { name: "Ste. Rose du Lac Detachment", lat: 49.353098387559974, lon: -97.35992547686516 },
            { name: "Fisher Branch Detachment", lat: 51.082239379468135, lon: -97.61305616061779 },
            { name: "Dauphin Detachment", lat: 51.15518881324105, lon: -100.0441968610676 },
            { name: "Ashern Detachment", lat: 51.183951550159264, lon: -98.34782224110411 },
            { name: "Roblin Detachment", lat: 51.227390095824035, lon: -101.35269426955102 },
            { name: "Winnipegosis Detachment", lat: 51.649220863682665, lon: -99.92410254612773 },
            { name: "Gypsumville Detachment", lat: 51.76678463539701, lon: -98.63784108019297 },
            { name: "Bloodvein Detachment", lat: 51.79024570149924, lon: -96.70302530518063 },
            { name: "Little Grand Rapids Detachment", lat: 52.00624455434796, lon: -95.47488439816085 },
            { name: "Swan River Detachment", lat: 52.10698820565967, lon: -101.26142398388255 },
            { name: "Poplar River Detachment", lat: 52.99107241788359, lon: -97.25177028044696 },
            { name: "Chemawawin Cree Nation Detachment", lat: 53.10286620482176, lon: -99.80733460447368 },
            { name: "Grand Rapids Detachment", lat: 53.187444077854046, lon: -99.262317769813 },
            { name: "Moose Lake Detachment", lat: 53.7036368472093, lon: -100.3288949191245 },
            { name: "The Pas Detachment", lat: 53.82253585491343, lon: -101.25105668753622 },
            { name: "Island Lake Detachment", lat: 53.86593740334115, lon: -94.66798471443852 },
            { name: "Norway House Detachment", lat: 53.994663418957515, lon: -97.76813474190057 },
            { name: "Gods Lake Narrows Detachment", lat: 54.55560843205429, lon: -94.47698240099429 },
            { name: "Cranberry Portage Detachment", lat: 54.588595230548464, lon: -101.37892773225569 },
            { name: "Cross Lake Detachment", lat: 54.62378439303406, lon: -97.77657893987343 },
            { name: "Flin Flon Detachment", lat: 54.76797725237556, lon: -101.87657833172143 },
            { name: "Snow Lake Detachment", lat: 54.878413800384784, lon: -100.02446594948837 },
            { name: "Wabowden Detachment", lat: 54.91054637955159, lon: -98.63451992083806 },
            { name: "Oxford House Detachment", lat: 54.95527197107634, lon: -95.26442966801642 },
            { name: "Thompson Detachment", lat: 55.744137530047674, lon: -97.85662337586129 },
            { name: "Pukatawagan Detachment", lat: 55.7537459298745, lon: -101.29905649205025 },
            { name: "Nelson House Detachment", lat: 55.78943882759565, lon: -98.88227165173139 },
            { name: "Shamattawa Detachment", lat: 55.8595075716048, lon: -92.09394053900145 },
            { name: "Gillam Detachment", lat: 56.347081619883944, lon: -94.70415401735575 },
            { name: "Leaf Rapids Detachment", lat: 56.46208255053604, lon: -100.01475401254113 },
            { name: "Lynn Lake Detachment", lat: 56.85303471186375, lon: -101.04660859358381 },
            { name: "South Indian Lake Detachment", lat: 56.779065868961325, lon: -98.929082656989071 },
            { name: "Churchill Detachment", lat: 58.76561158660485, lon: -94.1622044346209 },
            { name: "Winnipeg Airport Detachment", lat: 49.905911391758835, lon: -97.22431956505532 },
            { name: "Berens River Detachment", lat: 52.35458471583981, lon: -97.02249290207254 },
            { name: "Wasagaming Detachment", lat: 50.652446322901476, lon: -99.97199201517316 },
            { name: "Peguis Detachment", lat: 51.29522261406654, lon: -97.548098625995 },
            { name: "Thompson Detachment (rural)", lat: 55.73221227664644, lon: -97.87243541940812 },
            // Yukon
            { name: "Beaver Creek Detachment", lat: 62.3831637285805, lon: -140.8743807289492 },
            { name: "Carcross Detachment", lat: 60.166842761232076, lon: -134.70471147722677 },
            { name: "Carmacks Detachment", lat: 62.08977602096233, lon: -136.2892672357153 },
            { name: "Dawson City Detachment", lat: 64.05703780887602, lon: -139.44013443540706 },
            { name: "Faro Detachment", lat: 62.230668086728734, lon: -133.3566635472941 },
            { name: "Haines Junction Detachment", lat: 60.75197178125077, lon: -137.5107280314997 },
            { name: "Mayo Detachment", lat: 63.59558344607216, lon: -135.89777955257398 },
            { name: "Old Crow Detachment", lat: 67.5690690966879, lon: -139.8324246923276 },
            { name: "Pelly Crossing Detachment", lat: 62.82380827372366, lon: -136.5775172208898 },
            { name: "Ross River Detachment", lat: 61.9822740918631, lon: -132.45395262314642 },
            { name: "Teslin Detachment", lat: 60.164617768451336, lon: -132.7245611215806 },
            { name: "Watson Lake Detachment", lat: 60.05559404325373, lon: -128.67228345534656 },
            { name: "M Division Headquarters and Whitehorse Detachment", lat: 60.71812221174552, lon: -135.056315169137 }
        ];

        let map = null;
        let searchTimeout = null;

        const addressInput = document.getElementById('addressInput');
        const suggestionsDiv = document.getElementById('suggestions');

        // Auto-complete functionality
        addressInput.addEventListener('input', function() {
            clearTimeout(searchTimeout);
            const query = this.value.trim();
            
            if (query.length < 3) {
                suggestionsDiv.classList.remove('show');
                return;
            }
            
            searchTimeout = setTimeout(() => searchAddresses(query), 300);
        });

        addressInput.addEventListener('keydown', function(e) {
            if (e.key === 'Enter') {
                findByAddress();
            }
        });

        document.addEventListener('click', function(e) {
            if (e.target !== addressInput) {
                suggestionsDiv.classList.remove('show');
            }
        });

        async function searchAddresses(query) {
            try {
                const url = `https://nominatim.openstreetmap.org/search?format=json&q=${encodeURIComponent(query)}&limit=5&countrycodes=ca`;
                const response = await fetch(url);
                const data = await response.json();
                
                // Filter to only show Canadian addresses
                const canadianResults = data.filter(item => 
                    item.display_name.includes('Canada') || 
                    item.address?.country === 'Canada' ||
                    item.address?.country_code === 'ca'
                );
                
                if (canadianResults && canadianResults.length > 0) {
                    suggestionsDiv.innerHTML = '';
                    canadianResults.forEach(item => {
                        const div = document.createElement('div');
                        div.className = 'suggestion-item';
                        div.textContent = item.display_name;
                        div.onclick = function() {
                            addressInput.value = item.display_name;
                            suggestionsDiv.classList.remove('show');
                            calculateClosest(parseFloat(item.lat), parseFloat(item.lon), item.display_name);
                        };
                        suggestionsDiv.appendChild(div);
                    });
                    suggestionsDiv.classList.add('show');
                } else {
                    suggestionsDiv.classList.remove('show');
                }
            } catch (error) {
                console.error('Error fetching suggestions:', error);
            }
        }

        async function geocodeAddress(address) {
            const url = `https://nominatim.openstreetmap.org/search?format=json&q=${encodeURIComponent(address)}&limit=1`;
            const response = await fetch(url);
            const data = await response.json();
            
            if (data && data.length > 0) {
                return {
                    lat: parseFloat(data[0].lat),
                    lon: parseFloat(data[0].lon),
                    display_name: data[0].display_name
                };
            }
            return null;
        }

        async function findByAddress() {
            const address = addressInput.value.trim();
            
            if (!address) {
                alert('Please enter an address');
                return;
            }
            
            const resultDiv = document.getElementById('result');
            resultDiv.className = 'result loading';
            resultDiv.textContent = 'Looking up address...';
            suggestionsDiv.classList.remove('show');
            
            try {
                const coords = await geocodeAddress(address);
                
                if (!coords) {
                    resultDiv.className = 'result error';
                    resultDiv.textContent = 'Could not find that address. Please try a different address or be more specific.';
                    return;
                }
                
                await calculateClosest(coords.lat, coords.lon, coords.display_name);
            } catch (error) {
                resultDiv.className = 'result error';
                resultDiv.textContent = 'Error looking up address: ' + error.message;
            }
        }

        async function findClosest() {
            const resultDiv = document.getElementById('result');
            const mapDiv = document.getElementById('map');
            const btn = document.getElementById('findBtn');
            
            btn.disabled = true;
            resultDiv.className = 'result loading';
            resultDiv.textContent = 'Getting your location...';
            mapDiv.classList.remove('show');

            if (!navigator.geolocation) {
                resultDiv.className = 'result error';
                resultDiv.textContent = 'Geolocation is not supported by your browser. Please use the address lookup instead.';
                btn.disabled = false;
                return;
            }

            navigator.geolocation.getCurrentPosition(async (position) => {
                const userLat = position.coords.latitude;
                const userLon = position.coords.longitude;
                
                await calculateClosest(userLat, userLon, 'Your Location');
                btn.disabled = false;
            }, (error) => {
                resultDiv.className = 'result error';
                resultDiv.textContent = 'Error getting location: ' + error.message + '. Please use the address lookup instead.';
                btn.disabled = false;
            });
        }

        function calculateHaversineDistance(lat1, lon1, lat2, lon2) {
            const R = 6371; // Earth's radius in km
            const dLat = (lat2 - lat1) * Math.PI / 180;
            const dLon = (lon2 - lon1) * Math.PI / 180;
            const a = Math.sin(dLat/2) * Math.sin(dLat/2) +
                      Math.cos(lat1 * Math.PI / 180) * Math.cos(lat2 * Math.PI / 180) *
                      Math.sin(dLon/2) * Math.sin(dLon/2);
            const c = 2 * Math.atan2(Math.sqrt(a), Math.sqrt(1-a));
            return R * c;
        }

        async function calculateClosest(userLat, userLon, locationLabel) {
            const resultDiv = document.getElementById('result');
            const mapDiv = document.getElementById('map');

            resultDiv.className = 'result loading';
            resultDiv.textContent = 'Calculating distances to detachments...';

            try {
                let closestDetachment = null;
                let closestDetachmentData = null;
                let shortestDistance = Infinity;
                let routeGeometry = null;

                for (const det of detachments) {
                    try {
                        const url = `https://router.project-osrm.org/route/v1/driving/${userLon},${userLat};${det.lon},${det.lat}?overview=full&geometries=geojson&steps=true`;
                        
                        const response = await fetch(url);
                        const data = await response.json();

                        // Check if route was successfully calculated
                        if (data.code === 'Ok' && data.routes && data.routes.length > 0) {
                            const route = data.routes[0];
                            
                            // Get the actual starting and ending points of the route from waypoints
                            if (data.waypoints && data.waypoints.length >= 2) {
                                const startWaypoint = data.waypoints[0];
                                const endWaypoint = data.waypoints[1];
                                const startLat = startWaypoint.location[1];
                                const startLon = startWaypoint.location[0];
                                const endLat = endWaypoint.location[1];
                                const endLon = endWaypoint.location[0];
                                
                                // Calculate distance between user location and route start point (in meters)
                                const startSnapDist = Math.sqrt(
                                    Math.pow((startLat - userLat) * 111000, 2) + 
                                    Math.pow((startLon - userLon) * 111000 * Math.cos(userLat * Math.PI / 180), 2)
                                );
                                
                                // Calculate distance between detachment and route end point (in meters)
                                const endSnapDist = Math.sqrt(
                                    Math.pow((endLat - det.lat) * 111000, 2) + 
                                    Math.pow((endLon - det.lon) * 111000 * Math.cos(det.lat * Math.PI / 180), 2)
                                );
                                
                                // If either endpoint is too far (>1km), there's no proper road connection
                                if (startSnapDist > 1000 || endSnapDist > 1000) {
                                    console.log(`${det.name}: Start snap: ${startSnapDist.toFixed(0)}m, End snap: ${endSnapDist.toFixed(0)}m - no direct road access`);
                                    continue;
                                }
                                
                                const distance = route.distance;
                                
                                if (distance > 0 && distance < shortestDistance) {
                                    shortestDistance = distance;
                                    closestDetachment = det.name;
                                    closestDetachmentData = det;
                                    routeGeometry = route.geometry;
                                }
                            }
                        }
                    } catch (err) {
                        console.log(`Could not route to ${det.name}:`, err);
                        continue;
                    }
                }

                if (closestDetachment && closestDetachmentData) {
                    const distanceKm = (shortestDistance / 1000).toFixed(1);
                    resultDiv.className = 'result';
                    resultDiv.innerHTML = `<strong>Closest Detachment:</strong><br>${closestDetachment}<br><small>Driving Distance: ${distanceKm} km</small>`;
                    
                    mapDiv.classList.add('show');
                    
                    if (map) {
                        map.remove();
                    }
                    
                    map = L.map('map').setView([userLat, userLon], 8);
                    
                    L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
                        attribution: '© OpenStreetMap contributors'
                    }).addTo(map);
                    
                    // Green marker for user location
                    const greenIcon = L.icon({
                        iconUrl: 'https://raw.githubusercontent.com/pointhi/leaflet-color-markers/master/img/marker-icon-2x-green.png',
                        shadowUrl: 'https://cdnjs.cloudflare.com/ajax/libs/leaflet/1.9.4/images/marker-shadow.png',
                        iconSize: [25, 41],
                        iconAnchor: [12, 41],
                        popupAnchor: [1, -34],
                        shadowSize: [41, 41]
                    });
                    
                    L.marker([userLat, userLon], {icon: greenIcon})
                        .addTo(map)
                        .bindPopup(locationLabel)
                        .openPopup();
                    
                    // Red marker for closest detachment
                    const redIcon = L.icon({
                        iconUrl: 'https://raw.githubusercontent.com/pointhi/leaflet-color-markers/master/img/marker-icon-2x-red.png',
                        shadowUrl: 'https://cdnjs.cloudflare.com/ajax/libs/leaflet/1.9.4/images/marker-shadow.png',
                        iconSize: [25, 41],
                        iconAnchor: [12, 41],
                        popupAnchor: [1, -34],
                        shadowSize: [41, 41]
                    });
                    
                    L.marker([closestDetachmentData.lat, closestDetachmentData.lon], {icon: redIcon})
                        .addTo(map)
                        .bindPopup(closestDetachment);
                    
                    // Blue markers for other detachments
                    const blueIcon = L.icon({
                        iconUrl: 'https://raw.githubusercontent.com/pointhi/leaflet-color-markers/master/img/marker-icon-2x-blue.png',
                        shadowUrl: 'https://cdnjs.cloudflare.com/ajax/libs/leaflet/1.9.4/images/marker-shadow.png',
                        iconSize: [25, 41],
                        iconAnchor: [12, 41],
                        popupAnchor: [1, -34],
                        shadowSize: [41, 41]
                    });
                    
                    detachments.forEach(det => {
                        if (det.name !== closestDetachment) {
                            L.marker([det.lat, det.lon], {icon: blueIcon})
                                .addTo(map)
                                .bindPopup(det.name);
                        }
                    });
                    
                    if (routeGeometry) {
                        const coords = routeGeometry.coordinates.map(c => [c[1], c[0]]);
                        L.polyline(coords, {color: 'blue', weight: 4}).addTo(map);
                    }
                    
                    const bounds = L.latLngBounds([
                        [userLat, userLon],
                        [closestDetachmentData.lat, closestDetachmentData.lon]
                    ]);
                    map.fitBounds(bounds, {padding: [50, 50]});
                    
                } else {
                    // No road routes found, find closest by straight-line distance
                    let closestStraightLine = null;
                    let closestStraightLineData = null;
                    let shortestStraightDistance = Infinity;
                    
                    for (const det of detachments) {
                        // Calculate straight-line distance using Haversine formula
                        const R = 6371000; // Earth's radius in meters
                        const dLat = (det.lat - userLat) * Math.PI / 180;
                        const dLon = (det.lon - userLon) * Math.PI / 180;
                        const a = Math.sin(dLat/2) * Math.sin(dLat/2) +
                                  Math.cos(userLat * Math.PI / 180) * Math.cos(det.lat * Math.PI / 180) *
                                  Math.sin(dLon/2) * Math.sin(dLon/2);
                        const c = 2 * Math.atan2(Math.sqrt(a), Math.sqrt(1-a));
                        const distance = R * c;
                        
                        if (distance < shortestStraightDistance) {
                            shortestStraightDistance = distance;
                            closestStraightLine = det.name;
                            closestStraightLineData = det;
                        }
                    }
                    
                    const distanceKm = (shortestStraightDistance / 1000).toFixed(1);
                    resultDiv.className = 'result error';
                    resultDiv.innerHTML = `<strong>Closest Detachment:</strong><br>${closestStraightLine}<br><small>Straight-line Distance: ${distanceKm} km</small><br><br><span style="color: #c62828; font-weight: bold;">No directroad acess</span><br><small>There are no accessible roads connecting your location to any RCMP detachment.</small>`;
                    
                    mapDiv.classList.add('show');
                    
                    if (map) {
                        map.remove();
                    }
                    
                    map = L.map('map').setView([userLat, userLon], 8);
                    
                    L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
                        attribution: '© OpenStreetMap contributors'
                    }).addTo(map);
                    
                    // Green marker for user location
                    const greenIcon = L.icon({
                        iconUrl: 'https://raw.githubusercontent.com/pointhi/leaflet-color-markers/master/img/marker-icon-2x-green.png',
                        shadowUrl: 'https://cdnjs.cloudflare.com/ajax/libs/leaflet/1.9.4/images/marker-shadow.png',
                        iconSize: [25, 41],
                        iconAnchor: [12, 41],
                        popupAnchor: [1, -34],
                        shadowSize: [41, 41]
                    });
                    
                    L.marker([userLat, userLon], {icon: greenIcon})
                        .addTo(map)
                        .bindPopup(locationLabel)
                        .openPopup();
                    
                    // Red marker for closest detachment
                    const redIcon = L.icon({
                        iconUrl: 'https://raw.githubusercontent.com/pointhi/leaflet-color-markers/master/img/marker-icon-2x-red.png',
                        shadowUrl: 'https://cdnjs.cloudflare.com/ajax/libs/leaflet/1.9.4/images/marker-shadow.png',
                        iconSize: [25, 41],
                        iconAnchor: [12, 41],
                        popupAnchor: [1, -34],
                        shadowSize: [41, 41]
                    });
                    
                    L.marker([closestStraightLineData.lat, closestStraightLineData.lon], {icon: redIcon})
                        .addTo(map)
                        .bindPopup(closestStraightLine + '<br><span style="color: #c62828;">No road access</span>');
                    
                    // Blue markers for other detachments
                    const blueIcon = L.icon({
                        iconUrl: 'https://raw.githubusercontent.com/pointhi/leaflet-color-markers/master/img/marker-icon-2x-blue.png',
                        shadowUrl: 'https://cdnjs.cloudflare.com/ajax/libs/leaflet/1.9.4/images/marker-shadow.png',
                        iconSize: [25, 41],
                        iconAnchor: [12, 41],
                        popupAnchor: [1, -34],
                        shadowSize: [41, 41]
                    });
                    
                    detachments.forEach(det => {
                        if (det.name !== closestStraightLine) {
                            L.marker([det.lat, det.lon], {icon: blueIcon})
                                .addTo(map)
                                .bindPopup(det.name);
                        }
                    });
                    
                    // Draw a dashed line to show it's not a road route
                    L.polyline([[userLat, userLon], [closestStraightLineData.lat, closestStraightLineData.lon]], {
                        color: 'red',
                        weight: 2,
                        dashArray: '10, 10',
                        opacity: 0.6
                    }).addTo(map);
                    
                    const bounds = L.latLngBounds([
                        [userLat, userLon],
                        [closestStraightLineData.lat, closestStraightLineData.lon]
                    ]);
                    map.fitBounds(bounds, {padding: [50, 50]});
                }
            } catch (error) {
                resultDiv.className = 'result error';
                resultDiv.textContent = 'Error calculating routes: ' + error.message;
            }
        }
    </script>
</body>
</html>
